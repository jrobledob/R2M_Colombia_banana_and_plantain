---
title: "Analisis of individual Questions EKE Colombia - Banano and Plantain 2023"
author: "Jacobo Robledo"
date: "`r Sys.Date()`"
output: github_document
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = 'hide')
```

## Libraries, Functions, and Global Variables

#### `tree_map_3` Function

**Description:**\
This function creates a treemap visualization based on a given dataset.
It first calculates the frequency of occurrences for specified grouping variables and then plots a treemap using these frequencies.

**Parameters:**\

-   `data`: A data frame containing the data to be visualized.

-   `group`: The name of the column in 'data' to be used as the primary grouping variable.

-   `subgroup_1`: The name of the column in 'data' to be used as the first level subgroup.

-   `subgroup_2`: The name of the column in 'data' to be used as the second level subgroup.

-   `color_column`: The name of the column in 'data' that determines the color of the treemap blocks.

-   `title`: The title to be displayed on the treemap.

**Details:**\
The function groups the data by 'group', 'subgroup_1', 'subgroup_2', and 'color_column', then calculates the frequency of each group.
It uses the 'treemap' package to create the treemap, where the size of each block is determined by the calculated frequency.
The color of the blocks is determined by the 'color_column'.
The function allows customization of label sizes, colors, and placement, as well as border colors and widths.

**Returns:**\
A treemap plot as specified by the input parameters.

**Example Usage:**\
`tree_map_3(my_data, "main_category", "sub_category1", "sub_category2", "color_var", "My Treemap Title")`

#### `Col_map_by_depto` Function

**Description:**\
This function creates a colored map visualization based on departmental data.
It utilizes the `colmap` function to map data to specific geographical areas (departments) and applies a continuous color scale to these areas.

**Function Structure:** - `colmap(departamentos, data, data_id, var)`: Maps the `var` variable from the `data` data frame onto the `departamentos` geographical layout.
The `data_id` specifies the matching column in `data` that corresponds to department IDs.
- `scale_fill_continuous(low, high, na.value)`: Applies a continuous color scale to the map.
The `low` and `high` parameters define the color range for the lowest and highest values of `var`, respectively.
The `na.value` parameter defines the color for missing values.
- `labs(fill = legend_lab)`: Sets the label for the map legend.

**Parameters:**\
- `departamentos`: The geographical layout of departments.
- `data`: The data frame containing the data to be visualized.
- `data_id`: The column in `data` that corresponds to department IDs.
- `var`: The variable in `data` to be visualized on the map.
- `low`: The color representing the low end of the `var` variable's range.
- `high`: The color representing the high end of the `var` variable's range.
- `na.value`: The color used for missing values in `var`.
- `legend_lab`: The label for the map's legend.

**Example Usage:**\
Suppose you have a data frame `my_data` with department IDs in `depto_id` column and a variable `population` to visualize.
You could call:

`R Col_map_by_depto(departamentos = my_map_layout, data = my_data, data_id = "depto_id", var = "population", low = "blue", high = "red", na.value = "grey", legend_lab = "Population")`

#### `category_by_mean_by_question` Function

**Description:**\
This function retrieves the category corresponding to a given mean value for a specific question.
It reads a dataset from a specified URL containing category information in both English and Spanish.
The function allows the user to specify the language for the category description.

**Parameters:**\
- `question`: The question number for which the category needs to be found.
- `mean`: The mean value whose corresponding category is to be retrieved.
- `language`: A character vector specifying the language of the category description.
Default is `c("en", "es")`.

**Functionality:**\
- The function first rounds the mean value to the nearest whole number.
- It then reads a dataset from a given URL that contains categories in both English and Spanish.
- Depending on the selected language, it filters the dataset to find the category corresponding to the provided question number and rounded mean value.
- If the language is set to "en" (English), it retrieves the category from the `trans_answer` column; if "es" (Spanish), it retrieves from the `Category` column.
- An error message is displayed if the specified language is not found.

**Returns:**\
The category corresponding to the specified mean and question in the chosen language.

**Example Usage:**\
Suppose you have a mean value of 3.6 for question number 5 and want the category in English.
You could call:

`R   category <- category_by_mean_by_question(question = 5, mean = 3.6, language = "en")`

#### `count_elements_by_group` Function

**Description:**\
This function is designed to count the frequency of elements within a specified column that contains comma-separated values.
It processes the data to convert it into a long format and then performs a count of each element within the specified groups.

**Parameters:**\
- `data`: The data frame containing the data to be analyzed.
- `value_column`: The name of the column in `data` that contains the comma-separated values.
- `group_columns`: A vector of column names in `data` used to define groups for aggregation.

**Functionality:**\
- The function first uses `separate_rows` to split the comma-separated values in `value_column` and convert the data into a long format.
- `group_by` is then applied to group the data by the columns specified in `group_columns`.
- `count` is used to count the occurrences of each unique element within these groups.
- The result is a long-format data frame with the frequency count of each element in the specified groups.

**Returns:**\
A data frame in long format that contains the counts of each unique element within the specified groups.

**Example Usage:**\
Suppose you have a data frame `df` with a column `categories` containing comma-separated values and you want to count these values within groups defined by `column1` and `column2`.
You could call: `R   result <- count_elements_by_group(df, "categories", c("column1", "column2"))`

#### `bar_plot_banana_plantain` Function

**Description:**\
This function creates a bar plot specifically designed for visualizing data related to 'Banana' and 'Plantain' categories.
It includes customizable aesthetics such as background color for highlighting, bar color coding, and an adjustable upper limit for the y-axis to enhance the proportional representation of data.

**Parameters:**\
- `data_set`: The data frame containing the data to be plotted.
- `x_lab`: Label for the x-axis.
- `y_lab`: Label for the y-axis.
- `title`: The title of the plot.
- `x`: The name of the column in `data_set` to be used as the x-axis variable.
- `y`: The name of the column in `data_set` to be used as the y-axis variable.
- `facet`: The name of the column in `data_set` to create facets for different panels in the plot.
- `alpha`: The transparency level for the background color of the geom_rect.
- `background_color`: The name of the column in `data_set` that contains the background colors for the rectangles.
- `bar_color`: The name of the column in `data_set` that contains the colors for the bars.
- `proportional_limit`: A numeric value to set the upper limit of the y-axis as a proportion of the maximum value of the y variable.

**Functionality:**\
- The function starts by converting provided column names into symbols for `ggplot2` aesthetics.
- It calculates the new y-axis upper limit based on the provided `proportional_limit`.
- A ggplot object is initialized, and layers are added for rectangles, text, and bars, with aesthetics mapped accordingly.
- The plot's appearance is customized, including colors for text and lines, and removing the grid lines for a cleaner look.
- The y-axis is scaled with the calculated limit, and facet panels are created as per the `facet` column.

**Returns:**\
A ggplot object representing the bar plot with customized aesthetics and scales, ready for rendering or further modification.

**Example Usage:**\
To create a plot for a data frame `df` with background colors specified in `bg_colors` and bar colors in `bar_colors`, where we want to facet by the 'type' column and set the y-axis upper limit to be 20% higher than the max 'value' in `df`:

`R result_plot <- bar_plot_banana_plantain(   data_set = df,   x_lab = "Type of Crop",   y_lab = "Value in Percentage",   title = "Crop Value Comparison",   x = "type",   y = "value",   facet = "category",   alpha = 0.3,   background_color = "bg_colors",   bar_color = "bar_colors",   proportional_limit = 1.2 ) # Print the result print(result_plot)`

#### `assign_group_color` Function

**Description:**\
This function dynamically assigns color codes to data points based on their categorical responses within specific groups (crops).
It is designed to work with variable-length categories and color mappings for different groups.
It's especially useful for visualizing data where the color representation depends on both the group (crop) and the category of response.

**Parameters:**\
- `data`: The data frame containing the data to be processed.
- `levels_by_crop`: A named list where each element is a vector of categorical levels for a specific crop.
- `colors_by_crop`: A named list where each element is a vector of colors corresponding to each categorical level for each crop.

**Functionality:**\
- The function iterates through each row of the data frame.
- For each row, it matches the crop and its corresponding answer to its categorical level.
- It then assigns the color based on the matched level from the provided color vectors.
- The function handles varying lengths of categories and color mappings, making it versatile for different datasets.

**Returns:**\
The modified data frame with an additional column `group_color` that contains the assigned color codes based on the crop and answer categories.

**Example Usage:**\
To assign colors to a dataset `df` with crops 'Banana' and 'Plantain' and their respective levels and colors:

`r levels_by_crop <- list( Banana = c("Very Low Knowledge", "Low Knowledge", "Moderate Knowledge", "High Knowledge", "Very High Knowledge"), Plantain = c("No Knowledge", "Very Low Knowledge", "Low Knowledge", "Moderate Knowledge", "High Knowledge", "Very High Knowledge") )`


`r colors_by_crop <- list( Banana = c("#color1", "#color2", "#color3", "#color4", "#color5"), Plantain = c("#color6", "#color7", "#color8", "#color9", "#color10", "#color11") )`


`r #df <- assign_group_color(df, levels_by_crop, colors_by_crop)`


#### `summarise_frequencies` Function

**Description:**  
This function is designed to calculate and summarize frequencies within a dataset. It groups the data based on a set of primary columns, computes the total count per group, then groups the data again using a second set of columns to calculate the frequency and the average frequency. Finally, it averages these frequencies to derive a mean frequency for each unique combination in the second group.

**Parameters:**  

- `data`: A data frame containing the dataset to be analyzed.
- `first_group_cols`: A vector of column names from the data frame used for the initial grouping.
- `second_group_cols`: A vector of column names from the data frame used for the subsequent grouping and frequency calculation.

**Details:**  
The function utilizes `dplyr` functions for data manipulation. It first groups the data with `first_group_cols` and computes a total count for each group. The data is then regrouped using `second_group_cols`, where it calculates both the frequency and average frequency. The final operation is summarizing these results to find the mean of average frequencies for each group combination.

**Returns:**  
A data frame containing the mean of average frequencies for each unique combination of `second_group_cols`.

**Example Usage:**  
`summarise_frequencies(question_12_long, c(\"crop\", \"expert_in\"), c(\"crop\", \"expert_in\", \"Add_parameters_english\"))`

#### `create_sankey` Function

**Description:**  
This function creates a Sankey diagram from a given dataset. It prepares the data by selecting necessary columns and restructuring them for use in the Sankey diagram. Nodes are created from the source and target columns, and a Sankey diagram is generated using the `networkD3` package.

**Parameters:**  

- `data`: A data frame containing the data for the Sankey diagram.
- `source`: The name of the column in 'data' to be used as the source of the links.
- `target`: The name of the column in 'data' to be used as the target of the links.
- `value`: The name of the column in 'data' that provides values for the link widths.
- `ColourScal`: A character string representing the JavaScript command for D3 color scale.

**Details:**  
The function first selects the specified source, target, and value columns from the data. Then, it creates a set of nodes based on the unique values from the source and target columns. The source and target columns are mapped to these nodes, and the `sankeyNetwork` function from the `networkD3` package is used to create and print the Sankey diagram.

**Returns:**  
A Sankey diagram visualizing the flow between different nodes as specified by the source and target, with the link widths proportional to the specified value.

**Example Usage:**  
`# Assuming 'question_12_long_frequencies' is your dataset and 'ColourScal' is defined
sankey <- create_sankey(
  data = question_12_long_frequencies,
  source = "expert_in",
  target = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = 'd3.scaleOrdinal().range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'
)`

```{r libraries}
#libraries----
  library(treemap)
  library(tidyverse)
  library(RColorBrewer)
  library("colmaps")
  library("homicidios")
  library(voronoiTreemap)
  library(webshot)
  library(webshot2)
  library(purrr)
  library(rlang)
  library(patchwork)
  library(hrbrthemes)
  library(circlize)
  library(networkD3)

#Global variables
  #set the color palette for bananas and plantains
  palette_banana <- colorRampPalette(c("#FFDA00","#FFF2CC" ))
  palette_plantain <- colorRampPalette(c("#28B463","#BEF4BE"))
  palette_soil<- colorRampPalette(c( "#654321","#d8c298"))
  #data set: individual questions:
  #read individual surveys from GitHub
  num_cols <- length(read.csv("https://raw.githubusercontent.com/jrobledob/R2M_Colombia_banana_and_plantain/main/Data/DATA_Individual_surveys_Banana_and_Plantain_Colombia_Clean_surveys_2023-12-28.csv", nrows = 1, header = TRUE))
  # Create a colClasses vector with "character" for each column
  col_classes <- rep("character", num_cols)
  individual_surveys<- read.csv("https://raw.githubusercontent.com/jrobledob/R2M_Colombia_banana_and_plantain/main/Data/DATA_Individual_surveys_Banana_and_Plantain_Colombia_Clean_surveys_2023-12-28.csv", colClasses = col_classes)
  #reformat columns
  individual_surveys$question_number<- as.integer(individual_surveys$question_number)
  #Getting the experience of each expert by department by crop
  experience_of_each_expert<- individual_surveys %>%
    filter(question_number==1) %>%
    select(crop, expert_ID, expert_in, numeric_answer) %>%
    mutate(numeric_answer= as.numeric(numeric_answer))
  colnames(experience_of_each_expert)[which(colnames(experience_of_each_expert)=="numeric_answer")]<- "weights"
  #correct the missing answer which is "Antioquia"
  experience_of_each_expert$expert_in[which(is.na(experience_of_each_expert$expert_in))]<- "Antioquia"
  list_of_deptos<- unique(c(individual_surveys$expert_in, individual_surveys$Add_parameters_english))
list_of_deptos<- list_of_deptos[!list_of_deptos %in% c(NA, "Local Certified Corms", 
                                                "Local Markets (informal)", 
                                                "Corms Stored From Previous Cycles Of The Same Farm",
                                                "Certified Tissue Culture Plants from International Production",
                                                "Certified Banana Nurseries in Colombia",
                                                "Planting Materials Shared by Neighbors or Communities",
                                                "Certified Tissue Culture Plants from National Production",
                                                "Planting Materials Supplied by the Government or a Research Institution",
                                                "Wild Sources or Naturally Grown Sprouts",
                                                "Not Sure")]
list_of_deptos<- data.frame(expert_in= sort(list_of_deptos))

    
#function tree_map_3 
  tree_map_3<- function(data,group, subgroup_1, subgroup_2, color_column, title){
    #Calculate the frequencies
    frequency_personalized_question<- data %>%
      group_by(!!rlang::sym(group), !!rlang::sym(subgroup_1), !!rlang::sym(subgroup_2), !!rlang::sym(color_column)) %>%
      summarise(frequency=n())
    #Plot the tree map 
    figure<- treemap(frequency_personalized_question,
            index=c(group,subgroup_1, subgroup_2), 
            vSize="frequency",
            vColor=color_column,
            type="color",
            fontsize.labels=c(0,7,4),                # size of labels. Give the size per level of aggregation: size for group, size for subgroup, sub-subgroups...
            fontcolor.labels=c("transparent","#654321", "#A58F65"),    # Color of labels
            fontface.labels=c(2,1,1),                  # Font of labels: 1,2,3,4 for normal, bold, italic, bold-italic...
            bg.labels=c("transparent"),              # Background color of labels
            align.labels=list(
              c("center", "top"), 
              c("right", "bottom"), 
              c("left", "top")
            ),                                   # Where to place labels in the rectangle?
            overlap.labels=0.5,                      # number between 0 and 1 that determines the tolerance of the overlap between labels. 0 means that labels of lower levels are not printed if higher level labels overlap, 1  means that labels are always printed. In-between values, for instance the default value .5, means that lower level labels are printed if other labels do not overlap with more than .5  times their area size.
            inflate.labels=T,                        # If true, labels are bigger when rectangle is bigger.
            border.col=c("white","#654321","#A58F65"),             # Color of borders of groups, of subgroups, of subsubgroups ....
            border.lwds=c(3,2, 0.5),                         # Width of colors
            title=title,                      # Customize your title
            #fontsize.title=12                       # Size of the title
    )
    return(figure)
  }

#function Col_map_by_depto
  Col_map_by_depto<- function(data, data_id, var, low, high, na.values, legend_lab){
    
    figure<- colmap(departamentos, data = data, data_id = data_id, var = var)+
      scale_fill_continuous(low = low , high = high, na.value = na.values)
    labs(fill= legend_lab)
    return(figure)
  }
  
#function category_by_mean_by_question
category_by_mean_by_question<- function(question, mean, language=c("en","es")){
  mean<-round(mean, 0)
  data<- read.csv("https://raw.githubusercontent.com/jrobledob/R2M_Colombia_banana_and_plantain/main/Data/SUP_DATA_Categories_that_can_be_chosen_in_every_question_of_the_individual_survey_English_and_Spanish.csv")
  if (language=="en") {
    category<- filter(data, number==question & number_to_category==mean)$trans_answer
  }else{
    if (language=="es") {
      category<- filter(data, number==question & number_to_category==mean)$Category
    }
    cat("ERROR: Language not found")
  }
  return(category)
}

#Function count_elements_by_group
count_elements_by_group <- function(data, value_column, group_columns) {
  # Split the comma-separated values and convert to long format
  data_long <- data %>%
    separate_rows(!!sym(value_column), sep = ",\\s*") %>%
    group_by(across(all_of(group_columns))) %>%
    count(!!sym(value_column))
  return(data_long)
}
  
#function bar_plot_banana_plantain
bar_plot_banana_plantain <- function(data_set, x_lab, y_lab, title, x, y, alpha, background_color, bar_color, proportional_limit, facet = NULL) {
  # Calculate new y-axis upper limit, 20% above the max value
  ymax_limit <- max(data_set[[y]], na.rm = TRUE) * proportional_limit
  
  # Convert strings to symbols
  x_sym <- rlang::sym(x)
  y_sym <- rlang::sym(y)
  background_color_sym <- rlang::sym(background_color)
  bar_color_sym <- rlang::sym(bar_color)
  
  # Start the plot
  p <- ggplot(data_set, aes(x = !!x_sym, y = !!y_sym)) +
    geom_rect(aes(fill = !!background_color_sym), xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, alpha = alpha) +
    geom_text(aes(label = !!y_sym), vjust = -0.5, color = "#654321") +
    geom_bar(aes(fill = !!bar_color_sym), color = "#654321",stat = 'identity', position = position_dodge()) +
    scale_fill_identity() +
    labs(x = x_lab, y = y_lab, title = title) +
    theme(
      text = element_text(color = "#654321"),
      axis.title = element_text(color = "#654321"),
      axis.text = element_text(color = "#654321"),
      axis.line = element_line(color = "#654321"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_rect(color = "#654321", fill = NA),
      strip.text = element_text(color = "#654321"),
      strip.background = element_rect(fill = "#A58F65", colour = NA),
      legend.position = "none"
    ) +
    ylim(0, ymax_limit)
  
  # Conditionally add facet grid if facet is provided
  if (!is.null(facet) && facet != "") {
    facet_sym <- rlang::sym(facet)
    facet_formula <- as.formula(paste(". ~", facet))
    p <- p + facet_grid(facet_formula)
  }
  
  # Return the plot
  return(p)
}

#function assign_group_color 
assign_group_color <- function(data, answer_col, levels_by_crop, colors_by_crop) {
  # Ensure that answer_col is a string representing the column name
  # levels_by_crop is a named list of vectors containing the knowledge levels for each crop
  # colors_by_crop is a named list of vectors containing the colors corresponding to each knowledge level for each crop
  
  answer_col_sym <- rlang::sym(answer_col)  # Convert the string to a symbol
  
  data <- data %>%
    mutate(group_color = purrr::map2_chr(crop, !!answer_col_sym, function(crop_name, answer) {
      # Find the index of the answer within the levels for the given crop
      level_index <- match(answer, levels_by_crop[[crop_name]])
      # Use the index to get the corresponding color
      if (!is.na(level_index)) {
        colors_by_crop[[crop_name]][level_index]
      } else {
        NA_character_  # If there's no match, return NA
      }
    }))
  
  return(data)
}

#functions summarise_frequencies
summarise_frequencies <- function(data, first_group_cols, second_group_cols) {
  # Ensure that the column names are in the form of symbols for dplyr
  first_group_cols <- rlang::syms(first_group_cols)
  second_group_cols <- rlang::syms(second_group_cols)
  # Perform the operations
  data %>%
    group_by(!!!first_group_cols) %>% 
    mutate(total = n()) %>%
    group_by(!!!second_group_cols) %>%
    mutate(freq = n(), average = freq / total) %>%
    summarise(freq_unique = mean(average), .groups = 'drop')
}
# Example usage
# summarise_frequencies(question_12_long, c("crop", "expert_in"), c("crop", "expert_in", "Add_parameters_english"))

#function create_sankey
create_sankey <- function(data, source, target, value, ColourScal) {
  # Prepare the data
  data <- data %>%
    select(!!sym(source), !!sym(target), !!sym(value)) %>%
    rename(source = 1, target = 2, value = 3) %>%
    mutate(target = paste(target, " ", sep="")) %>%
    as.data.frame()  # Ensure it's a plain data frame
  
  # Create nodes
  nodes <- distinct(data, source, .keep_all = TRUE) %>%
    rename(name = source) %>%
    bind_rows(distinct(data, target, .keep_all = TRUE) %>% 
                rename(name = target)) %>%
    distinct(name, .keep_all = TRUE) %>%
    mutate(ID = row_number() - 1)
  
  # Map source and target to IDs
  data$IDsource <- match(data$source, nodes$name) - 1 
  data$IDtarget <- match(data$target, nodes$name) - 1 
  
  # Create the Sankey diagram
  sankey <- sankeyNetwork(Links = data, Nodes = nodes,
                          Source = "IDsource", Target = "IDtarget",
                          Value = "value", NodeID = "name",
                          sinksRight = FALSE, colourScale = ColourScal,
                          nodeWidth = 40, fontSize = 13, nodePadding = 20,
                          )
  
  return(sankey)  # Print the Sankey diagram
}

# Example usage of the function
# Assuming 'question_12_long_frequencies' is your dataset and you've defined 'ColourScal' outside the function.
# sankey <- create_sankey(
#   data = question_12_long_frequencies,
#   source = "expert_in",
#   target = "Add_parameters_english",
#   value = "freq_unique",
#   ColourScal = 'd3.scaleOrdinal().range(["#FDE725FF","#B4DE2CFF","#6DCD59FF","#35B779FF","#1F9E89FF","#26828EFF","#31688EFF","#3E4A89FF","#482878FF","#440154FF"])'
# )
```

## Question 1: `r unique(individual_surveys$question_in_english)[1]`

```{r question_1}
#selecting only question 1----
  question_1<- filter(individual_surveys, question_number==1)
  #organizing the order of the levels
  question_1$answer_in_english<- factor(question_1$answer_in_english,levels = c("1 to 2", "3 to 5","5 to 9","10 to 15","More than 15"))
  #finding the number of levels per crop (banana and plantain)
  levels_per_crop_Q1<- tapply(question_1$answer_in_english, question_1$crop, function(x){length(unique(x))})
  #generating a ramp palette according to the number of levels per crop
  colors_banana_question1<- palette_banana(levels_per_crop_Q1["Banana"])
  colors_plantain_question1<- palette_plantain(levels_per_crop_Q1["Plantain"])
  #Assigning the colors by crop and answer
  question_1<- question_1 %>%
    mutate(group_color= case_when(
      crop=="Banana" & answer_in_english == "1 to 2" ~ colors_banana_question1[5],
      crop=="Banana" & answer_in_english == "3 to 5" ~ colors_banana_question1[4],
      crop=="Banana" & answer_in_english == "5 to 9" ~ colors_banana_question1[3],
      crop=="Banana" & answer_in_english == "10 to 15" ~ colors_banana_question1[2],
      crop=="Banana" & answer_in_english == "More than 15" ~ colors_banana_question1[1],
      crop=="Plantain" & answer_in_english == "1 to 2" ~ colors_plantain_question1[5],
      crop=="Plantain" & answer_in_english == "3 to 5" ~ colors_plantain_question1[4],
      crop=="Plantain" & answer_in_english == "5 to 9" ~ colors_plantain_question1[3],
      crop=="Plantain" & answer_in_english == "10 to 15" ~ colors_plantain_question1[2],
      crop=="Plantain" & answer_in_english == "More than 15" ~ colors_plantain_question1[1],
    ))
#tree map
tree_map_3(data = question_1, "crop", "expert_in", "answer_in_english", "group_color", title="Experience of Experts by Department")
#summarise to have the number of experts by departments
data<- question_1 %>%
  group_by(expert_in, id_depto) %>%
  summarise(Number_of_Experts= n())
codes_department<- unique(data.frame(EKE.expert.in=homicidios$depto, id_depto=homicidios$id_depto))
data<- full_join(codes_department, data)
#Map of Colombia
Col_map_by_depto(data = data, data_id = "id_depto", var = "Number_of_Experts", low = "#A58F65", high = "#654321", na.values = "#eeeeee", legend_lab = "Number \n of experts")
#Total number of experts:
total_experts_Q1<- length(unique(question_1$expert_ID))
mode_Q1<- sort(table(question_1$answer_in_english), decreasing = T)
question_1$numeric_answer<- as.numeric(question_1$numeric_answer)
mean_q1<- mean(question_1$numeric_answer)
mean_q1<- category_by_mean_by_question(1, mean_q1, language = "en")
mean_q1_by_crops<- question_1 %>%
  group_by(crop) %>%
  summarise(mean_cat= mean(numeric_answer),
            surveys_by_crop= length(unique(expert_ID)),
            mode= names(sort(table(answer_in_english), decreasing = T))[1])
mean_q1_by_crops$cat_english<- tapply(mean_q1_by_crops$mean_cat, mean_q1_by_crops$crop, function(x){
  category_by_mean_by_question(1, mean = x, language = "en")}) 
  
```

#### Descriptive statistics:

Total number of experts that answer this question= `r total_experts_Q1`

Mode in all the surveys= `r names(mode_Q1[1])`

Mean in all the surveys=`r mean_q1`

Descriptive statistics by crop=

```{r stats_q1, echo=FALSE }
library(knitr)
kable(mean_q1_by_crops)
```

## Question 2: `r unique(individual_surveys$question_in_english)[2]`

```{r question_2}
question_2<- filter(individual_surveys,question_number==2)
question_2_frequencies <- count_elements_by_group(question_2, "answer_in_english", c("crop"))
question_2_frequencies$answer_in_english<- as.factor(question_2_frequencies$answer_in_english)
#finding the number of levels per crop (banana and plantain)
levels_per_crop_Q2<- tapply(question_2_frequencies$answer_in_english, question_2_frequencies$crop, function(x){length(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question2<- palette_banana(levels_per_crop_Q2["Banana"])
colors_plantain_question2<- palette_plantain(levels_per_crop_Q2["Plantain"])
#Assignig a color per factor by crop
question_2_frequencies <- question_2_frequencies %>%
  mutate(group_color = case_when(
    crop == "Banana" ~ colors_banana_question2[match(answer_in_english, c("Agricultural Extension", 
                                                                          "Agricultural Operations Management/Crop Consultants", 
                                                                          "Agronomy", "Economics", 
                                                                          "Entomology", "Horticulture", 
                                                                          "IPM (Integrated Pest Management)", 
                                                                          "Others", "Plant Pathology", 
                                                                          "Producer", "Research", 
                                                                          "Seed Systems", "Social Sciences"))],
    crop == "Plantain" ~ colors_plantain_question2[match(answer_in_english, c("Agricultural Extension", 
                                                                              "Agricultural Operations Management/Crop Consultants", 
                                                                              "Agronomy", "Economics", 
                                                                              "Entomology", "Horticulture", 
                                                                              "IPM (Integrated Pest Management)", 
                                                                              "Others", "Plant Pathology", 
                                                                              "Producer", "Research", 
                                                                              "Seed Systems", "Social Sciences"))]
  ))
#Creating avreviations for the the plot 
question_2_frequencies <- question_2_frequencies %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Agricultural Extension" ~ "AE",
    answer_in_english == "Agricultural Operations Management/Crop Consultants" ~ "AOM/CC",
    answer_in_english == "Agronomy" ~ "Agro",
    answer_in_english == "Economics" ~ "Econ",
    answer_in_english == "Entomology" ~ "Ento",
    answer_in_english == "Horticulture" ~ "Hort",
    answer_in_english == "IPM (Integrated Pest Management)" ~ "IPM",
    answer_in_english == "Others" ~ "Oth",
    answer_in_english == "Plant Pathology" ~ "PlPath",
    answer_in_english == "Producer" ~ "Prod",
    answer_in_english == "Research" ~ "Res",
    answer_in_english == "Seed Systems" ~ "SS",
    answer_in_english == "Social Sciences" ~ "SocSci",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#formating the data set to make the visualization, voronoiTreemap was quite picky...  
colnames(question_2_frequencies)<- c('h2', "h3", "weight","color", "codes")
question_2_frequencies$h1<- "Total"
question_2_frequencies <- question_2_frequencies %>%
  select(h1, h2, h3, color, weight, codes)
question_2_frequencies$weight<- (question_2_frequencies$weight/sum(question_2_frequencies$weight))*100
question_2_frequencies$h1<- as.factor(question_2_frequencies$h1)
question_2_frequencies$h2<- as.factor(question_2_frequencies$h2)
question_2_frequencies<- data.frame(h1= question_2_frequencies$h1,
                                    h2= question_2_frequencies$h2,
                                    h3= question_2_frequencies$h3,
                                    color= question_2_frequencies$color,
                                    weight= question_2_frequencies$weight,
                                    codes= question_2_frequencies$codes)
gdp_json <- vt_export_json(vt_input_from_df(question_2_frequencies))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3)
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3)
kable(question_2_frequencies)
```

## Question 3: `r unique(individual_surveys$question_in_english)[3]`

```{r queestion_3}
#selecting only question 3----
  question_3<- filter(individual_surveys, question_number==3)
#Counts by crop
  question_3_frequencies <- count_elements_by_group(question_3, "answer_in_english", c("crop"))
  #calculate the percentages by crop and question 
  question_3_frequencies <- question_3_frequencies %>%
  group_by(crop) %>%
  mutate(total = sum(n),          # Calculate total for each crop group
         percentage = (n / total) * 100) %>%
  ungroup()
  #Plot
  #Add colors to each 
  question_3_frequencies<- question_3_frequencies %>%
  mutate(background_color= case_when(crop=="Banana" ~ "#FFF2CC",
                     crop=="Plantain" ~ "#BEF4BE"))
  #bars colors
question_3_frequencies<- question_3_frequencies %>%
  mutate(bar_color= case_when(crop=="Banana" & answer_in_english=="Public" ~ "#FFDA00",
                              crop=="Banana" & answer_in_english=="Private" ~ "#FFEDA3",
                              crop=="Plantain" & answer_in_english=="Public" ~ "#28B463",
                              crop=="Plantain" & answer_in_english=="Private" ~ "#82DA99"))
question_3_frequencies$percentage<- round(question_3_frequencies$percentage,0)
#custom function
question_3_plot<- bar_plot_banana_plantain(
  data_set = question_3_frequencies,
  x_lab = "Sector Affiliation of Experts",
  y_lab = "Percent (%)",
  title = "Expert Affiliation by Crop",
  x = "answer_in_english",
  y = "percentage",
  facet = "crop",
  alpha = 0.3,
  background_color = "background_color",
  bar_color = "bar_color",
  proportional_limit= 1.05
)
question_3_plot
#Counts national
  question_3_frequencies_nal <- count_elements_by_group(question_3, "answer_in_english", c("answer_in_english"))
  #calculate the percentages by crop and question 
  question_3_frequencies_nal <- question_3_frequencies_nal %>%
     ungroup() %>%
    mutate(total = sum(n),          # Calculate total for each crop group
         percentage = (n / total) * 100) 
  #Plot
  #Add colors to each 
  question_3_frequencies_nal<- question_3_frequencies_nal %>%
  mutate(background_color= case_when(answer_in_english=="Public" ~ "transparent",
                     answer_in_english=="Private" ~ "transparent"))
  #Add color to the bars
 question_3_frequencies_nal<-  question_3_frequencies_nal %>%
  mutate(bar_color= case_when(answer_in_english=="Public"~ "#654321",
                              answer_in_english=="Private"~ "#d8c298"))
question_3_frequencies_nal$percentage<- round(question_3_frequencies_nal$percentage,0)
  #custom plot 
question_3_plot_nal<- bar_plot_banana_plantain(
  data_set = question_3_frequencies_nal,
  x_lab = "Sector Affiliation of Experts",
  y_lab = "Percent (%)",
  title = "Expert Affiliation",
  x = "answer_in_english",
  y = "percentage",
  alpha = 1,
  background_color = "background_color",
  bar_color = "bar_color",
  proportional_limit= 1.05
)
question_3_plot_nal
```

## Question 4: `r unique(individual_surveys$question_in_english)[4]`

```{r question_4}
#selecting only question 4----
  question_4<- filter(individual_surveys, question_number==4)
#Counts by crop
  question_4_frequencies <- count_elements_by_group(question_4, "answer_in_english", c("crop"))
  #calculate the percentages by crop and question 
  question_4_frequencies <- question_4_frequencies %>%
  group_by(crop) %>%
  mutate(total = sum(n),          # Calculate total for each crop group
         percentage = (n / total) * 100) %>%
  ungroup()
  question_4_frequencies$answer_in_english <- factor(
  question_4_frequencies$answer_in_english, 
  levels = c("No Formal Education", "Secondary Education", "Bachelor's Degree", "Master's Degree", "Doctorate"),
  labels = c("No Ed.", "Sec.", "Bac.", "Ms.C", "Ph.D")
)
  #Plot
  #Add colors to each backgorund 
  question_4_frequencies<- question_4_frequencies %>%
  mutate(background_color= case_when(crop=="Banana" ~ "#FFF2CC",
                     crop=="Plantain" ~ "#BEF4BE"))
  #Colors of the bars
  # Identify the levels by crop
  levels_Q_4_banana<- question_4_frequencies$answer_in_english[which( question_4_frequencies$crop=="Banana")]
  levels_Q_4_plantain<- question_4_frequencies$answer_in_english[which( question_4_frequencies$crop=="Plantain")]
  #set the color. The +1 is to make a different color that background wich will be the last element in the vector
  q_4_colors_banana<- palette_banana(length(levels_Q_4_banana)+1)
  q_4_colors_plantain<- palette_plantain(length(levels_Q_4_plantain)+1)
  names(q_4_colors_banana)<- levels_Q_4_banana
  names(q_4_colors_plantain)<- levels_Q_4_plantain
    # Modify the data_set to include the bar_color
question_4_frequencies <- question_4_frequencies %>%
  mutate(bar_color = case_when(
    crop == "Banana" ~ q_4_colors_banana[answer_in_english],
    crop == "Plantain" ~ q_4_colors_plantain[answer_in_english]
  ))
question_4_frequencies$percentage<- round(question_4_frequencies$percentage, 0)
dput(unique(question_4_frequencies$answer_in_english))
#custom function
question_4_plot<- bar_plot_banana_plantain(
  data_set = question_4_frequencies,
  x_lab = "Education Level of the Experts",
  y_lab = "Percent (%)",
  title = "Eucation Level of the Experts by Crop",
  x = "answer_in_english",
  y = "percentage",
  facet = "crop",
  alpha = 0.3,
  background_color = "background_color",
  bar_color = "bar_color",
  proportional_limit= 1.05
)
question_4_plot
#Counts national
  question_4_frequencies_nal <- count_elements_by_group(question_4, "answer_in_english", c("answer_in_english"))
  #calculate the percentages by crop and question 
  question_4_frequencies_nal <- question_4_frequencies_nal %>%
     ungroup() %>%
    mutate(total = sum(n),          # Calculate total for each crop group
         percentage = (n / total) * 100) 
  #Plot
  #Add colors to each background
   question_4_frequencies_nal$answer_in_english <- factor(
  question_4_frequencies_nal$answer_in_english, 
  levels = c("No Formal Education", "Secondary Education", "Bachelor's Degree", "Master's Degree", "Doctorate"),
  labels = c("No Ed.", "Sec.", "Bac.", "Ms.C", "Ph.D")
)
  question_4_frequencies_nal$background_color<-"transparent"
   q_4_colors_soil_nal<- palette_soil(length(levels(question_4_frequencies_nal$answer_in_english)))
    names(q_4_colors_soil_nal)<- levels(question_4_frequencies_nal)
 # Modify the data_set to include the bar_color
question_4_frequencies_nal <- question_4_frequencies_nal %>%
  mutate(bar_color = q_4_colors_soil_nal[answer_in_english])
question_4_frequencies_nal$percentage<- round(question_4_frequencies_nal$percentage, 0)
  #custom plot 
question_4_plot_nal<- bar_plot_banana_plantain(
  data_set = question_4_frequencies_nal,
  x_lab = "Education Level of the Experts",
  y_lab = "Percent (%)",
  title = "Education Level of the Experts",
  x = "answer_in_english",
  y = "percentage",
  alpha = 1,
  background_color = "background_color",
  bar_color = "bar_color",
  proportional_limit= 1.05
)
question_4_plot_nal
```

## Question 5: `r unique(individual_surveys$question_in_english)[5]`

```{r question_5}
question_5<- filter(individual_surveys,question_number==5)
question_5_frequencies <- count_elements_by_group(question_5, "answer_in_english", c("crop"))
question_5_frequencies$answer_in_english<- as.factor(question_5_frequencies$answer_in_english)
#finding the number of levels per crop (banana and plantain)
levels_per_crop_Q5<- tapply(question_5_frequencies$answer_in_english, question_5_frequencies$crop, function(x){length(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question5<- palette_banana(levels_per_crop_Q5["Banana"])
colors_plantain_question5<- palette_plantain(levels_per_crop_Q5["Plantain"])
#Assignig a color per factor by crop
question_5_frequencies <- question_5_frequencies %>%
  mutate(group_color = case_when(
    crop == "Banana" ~ colors_banana_question5[match(answer_in_english, c("Banana Mosaic Disease", "Black Sigatoka", 
"Black Weevil", "Elephantiasis", "Fusarium", "Moko or Madurabiche", 
"Nematodes", "Red Spider Mite", "Scale Insect", "Scarab Beetle", 
"Whiteflies", "Yellow Sigatoka"))],
    crop == "Plantain" ~ colors_plantain_question5[match(answer_in_english, c("Banana Mosaic Disease", "Black Sigatoka", 
"Black Weevil", "Elephantiasis", "Fusarium", "Moko or Madurabiche", 
"Nematodes", "Red Spider Mite", "Scale Insect", "Scarab Beetle", 
"Whiteflies", "Yellow Sigatoka"))]
  ))
#Make the abbreviations
question_5_frequencies <- question_5_frequencies %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Banana Mosaic Disease" ~ "BMD",
    answer_in_english == "Black Sigatoka" ~ "BS",
    answer_in_english == "Black Weevil" ~ "BW",
    answer_in_english == "Elephantiasis" ~ "ELE",
    answer_in_english == "Fusarium" ~ "FUS",
    answer_in_english == "Moko or Madurabiche" ~ "MOKO",
    answer_in_english == "Nematodes" ~ "NEM",
    answer_in_english == "Red Spider Mite" ~ "RSM",
    answer_in_english == "Scale Insect" ~ "SI",
    answer_in_english == "Scarab Beetle" ~ "SB",
    answer_in_english == "Whiteflies" ~ "WF",
    answer_in_english == "Yellow Sigatoka" ~ "YS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))

#formating the data set to make the visualization, voronoiTreemap was quite picky...  
colnames(question_5_frequencies)<- c('h2', "h3", "weight","color", "codes")
question_5_frequencies$h1<- "Total"
question_5_frequencies <- question_5_frequencies %>%
  select(h1, h2, h3, color, weight, codes)
question_5_frequencies$weight<- (question_5_frequencies$weight/sum(question_5_frequencies$weight))*100
question_5_frequencies$h1<- as.factor(question_5_frequencies$h1)
question_5_frequencies$h2<- as.factor(question_5_frequencies$h2)
question_5_frequencies<- data.frame(h1= question_5_frequencies$h1,
                                    h2= question_5_frequencies$h2,
                                    h3= question_5_frequencies$h3,
                                    color= question_5_frequencies$color,
                                    weight= question_5_frequencies$weight,
                                    codes= question_5_frequencies$codes)
gdp_json <- vt_export_json(vt_input_from_df(question_5_frequencies))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3)
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3)
kable(question_5_frequencies)
#select top 5
question_5_frequencies <- question_5_frequencies %>%
  group_by(h2) %>%
  slice_max(order_by = weight, n = 5) 
kable(question_5_frequencies, label = "TOP 5 pest and Diseases by Crop (banana and plantain")
#Frequencies by department
question_5_frequencies_by_depto <- count_elements_by_group(question_5, "answer_in_english", c("crop", "expert_in"))
#colors by disease
question_5_frequencies_by_depto <- question_5_frequencies_by_depto %>%
  mutate(group_color = case_when(
    crop == "Banana" ~ colors_banana_question5[match(answer_in_english, c("Banana Mosaic Disease", "Black Sigatoka", 
"Black Weevil", "Elephantiasis", "Fusarium", "Moko or Madurabiche", 
"Nematodes", "Red Spider Mite", "Scale Insect", "Scarab Beetle", 
"Whiteflies", "Yellow Sigatoka"))],
    crop == "Plantain" ~ colors_plantain_question5[match(answer_in_english, c("Banana Mosaic Disease", "Black Sigatoka", 
"Black Weevil", "Elephantiasis", "Fusarium", "Moko or Madurabiche", 
"Nematodes", "Red Spider Mite", "Scale Insect", "Scarab Beetle", 
"Whiteflies", "Yellow Sigatoka"))]
  ))
#Make the abbreviations
question_5_frequencies_by_depto <- question_5_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Banana Mosaic Disease" ~ "BMD",
    answer_in_english == "Black Sigatoka" ~ "BS",
    answer_in_english == "Black Weevil" ~ "BW",
    answer_in_english == "Elephantiasis" ~ "ELE",
    answer_in_english == "Fusarium" ~ "FUS",
    answer_in_english == "Moko or Madurabiche" ~ "MOKO",
    answer_in_english == "Nematodes" ~ "NEM",
    answer_in_english == "Red Spider Mite" ~ "RSM",
    answer_in_english == "Scale Insect" ~ "SI",
    answer_in_english == "Scarab Beetle" ~ "SB",
    answer_in_english == "Whiteflies" ~ "WF",
    answer_in_english == "Yellow Sigatoka" ~ "YS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_5_frequencies_by_depto<- select(question_5_frequencies_by_depto,!answer_in_english)
question_5_frequencies_by_depto<- question_5_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_5_frequencies_by_depto<- select(question_5_frequencies_by_depto,!n & !total)
#put it in long format
question_5_frequencies_by_depto <- question_5_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#only select top 5 for the tree map
  #for banana
  question_5_frequencies_by_depto_banana<- filter(question_5_frequencies_by_depto, cat_abbreviations %in% question_5_frequencies$codes[which(question_5_frequencies$h2=="Banana")], crop=="Banana")
  #for plantain
  question_5_frequencies_by_depto_plantain<- filter(question_5_frequencies_by_depto, cat_abbreviations %in% question_5_frequencies$codes[which(question_5_frequencies$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_5_frequencies_by_depto<- rbind(question_5_frequencies_by_depto_banana, question_5_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_5_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="Top 5 Most Limiting Pests and Diseases in Plantains by Department")
#tree map only banana
tree_map_3(data = filter(question_5_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="Top 5 Most Limiting Pests and Diseases in Bananas by Department")
#Additional top 5 diseases and pest in Colombia
q5_top_5Colobia<- count_elements_by_group(question_5, "answer_in_english", c("answer_in_english"))
q5_top_5Colobia$mean<-round((q5_top_5Colobia$n/sum(q5_top_5Colobia$n)*100),0)
q5_top_5Colobia$background_color<- "white"
q5_top_5Colobia$color<- palette_soil(length(unique(q5_top_5Colobia$answer_in_english)))
#Make abbreviations 
q5_top_5Colobia <- q5_top_5Colobia %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Banana Mosaic Disease" ~ "BMD",
    answer_in_english == "Black Sigatoka" ~ "BS",
    answer_in_english == "Black Weevil" ~ "BW",
    answer_in_english == "Elephantiasis" ~ "ELE",
    answer_in_english == "Fusarium" ~ "FUS",
    answer_in_english == "Moko or Madurabiche" ~ "MOKO",
    answer_in_english == "Nematodes" ~ "NEM",
    answer_in_english == "Red Spider Mite" ~ "RSM",
    answer_in_english == "Scale Insect" ~ "SI",
    answer_in_english == "Scarab Beetle" ~ "SB",
    answer_in_english == "Whiteflies" ~ "WF",
    answer_in_english == "Yellow Sigatoka" ~ "YS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#sort the results by mean
q5_top_5Colobia <- q5_top_5Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q5_top_5Colobia$cat_abbreviations<- factor(q5_top_5Colobia$cat_abbreviations, levels = q5_top_5Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q5_top_5Colobia,x_lab = "Pest and Diseases", y_lab ="Proportion of Experts (%)", title = "
Important Pests and Diseases in Musaceae Identified by Experts" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)

```

## Question 6: `r unique(individual_surveys$question_in_english)[6]`

```{r question_6}
#selecting only question 6----
  question_6<- filter(individual_surveys, question_number==6)
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_6 <- question_6 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "Very Low Knowledge,Low Knowledge,Moderate Knowledge" ~ "Low Knowledge",
    answer_in_english == "Very Low Knowledge,Low Knowledge" ~ "Low Knowledge",
    answer_in_english == "Moderate Knowledge,High Knowledge" ~ "Moderate Knowledge",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_6 <- question_6 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "2,3,4" ~ "3",
    numeric_answer == "2,3" ~ "2.5",
    numeric_answer == "4,5" ~ "4.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
  #organizing the order of the levels
  question_6$answer_in_english<- factor(question_6$answer_in_english,levels = 
c("No Knowledge", "Very Low Knowledge", "Low Knowledge", "Moderate Knowledge", "High Knowledge", "Very High Knowledge"))
 #average by department (weighted and no weighted)
    #not weighted 
    avg_dept_no_weight<- question_6 %>%
      group_by(crop, expert_in) %>%
      mutate(numeric_answer=as.numeric(numeric_answer))%>%
      mutate(average= mean(numeric_answer)) %>%
      group_by(average)%>%
      mutate(ave_cat= category_by_mean_by_question(6, mean =average, language = "en"))
    #weighted 
    add_weights_question6<- inner_join(question_6, experience_of_each_expert)
    avg_dept_weight<- add_weights_question6 %>%
      group_by(crop, expert_in) %>%
      mutate(numeric_answer=as.numeric(numeric_answer))%>%
      mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
      group_by(average_weighted)%>%
      mutate(ave_cat_weighted= category_by_mean_by_question(6, mean =average_weighted, language = "en"))

    #finding the levels per crop (banana and plantain) no weighted
  levels_per_crop_Q6_no_weighted<- tapply(avg_dept_no_weight$ave_cat, avg_dept_no_weight$crop, function(x){(unique(x))})
  #generating a ramp palette according to the number of levels per crop
  colors_banana_question6_no_weighted<- palette_banana(length(levels_per_crop_Q6_no_weighted$Banana))
  colors_plantain_question6_no_weighted<- palette_plantain(length(levels_per_crop_Q6_no_weighted$Plantain))
  #Assigning the colors by crop and answer
    # Define the knowledge levels for each crop
    levels_by_crop_no_weighted <- list(
      Banana = levels_per_crop_Q6_no_weighted$Banana,
      Plantain = levels_per_crop_Q6_no_weighted$Plantain
    )
    # Define the colors for each crop
    colors_by_crop_no_weighted <- list(
      Banana = colors_banana_question6_no_weighted, # Replace with actual color vector for Banana
      Plantain = colors_plantain_question6_no_weighted # Replace with actual color vector for Plantain
      # Add more crops and their color vectors here if needed
    )
    # Now call the function
    avg_dept_no_weight <- assign_group_color(data = avg_dept_no_weight, levels_by_crop = levels_by_crop_no_weighted, colors_by_crop = colors_by_crop_no_weighted,answer_col =  "ave_cat")
    
    #finding the levels per crop (banana and plantain) weighted
  levels_per_crop_Q6_weighted<- tapply(avg_dept_weight$ave_cat_weighted, avg_dept_weight$crop, function(x){(unique(x))})
  #generating a ramp palette according to the number of levels per crop
  colors_banana_question6_weighted<- palette_banana(length(levels_per_crop_Q6_weighted$Banana))
  colors_plantain_question6_weighted<- palette_plantain(length(levels_per_crop_Q6_weighted$Plantain))
  #Assigning the colors by crop and answer
    # Define the knowledge levels for each crop
    levels_by_crop_weighted <- list(
      Banana = levels_per_crop_Q6_weighted$Banana,
      Plantain = levels_per_crop_Q6_weighted$Plantain
    )
    # Define the colors for each crop
    colors_by_crop_weighted <- list(
      Banana = colors_banana_question6_weighted, # Replace with actual color vector for Banana
      Plantain = colors_plantain_question6_weighted # Replace with actual color vector for Plantain
      # Add more crops and their color vectors here if needed
    )
    # Now call the function
    avg_dept_weight <- assign_group_color(data = avg_dept_weight, levels_by_crop = levels_by_crop_weighted, colors_by_crop = colors_by_crop_weighted,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
  #non weighted
  nal_q6_no_weight<- question_6 %>%
  group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>% 
  group_by(average) %>%
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =6)) %>%
  rename(EKE.expert.in=expert_in)
  nal_q6_no_weight<- full_join(codes_department, nal_q6_no_weight)
  nal_q6_no_weight$cat<- factor(nal_q6_no_weight$cat, levels = c("Very Low Knowledge","Low Knowledge", "Moderate Knowledge", "High Knowledge", "Very High Knowledge", NA))
  colmap(departamentos, data = nal_q6_no_weight, data_id = "id_depto", var = "cat")+
    scale_fill_manual(values = palette_soil(length(unique(nal_q6_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
  nal_q6_weight<- inner_join(question_6, experience_of_each_expert)
  nal_q6_weight<- nal_q6_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =6)) %>%
  rename(EKE.expert.in=expert_in)
  
  nal_q6_weight<- full_join(codes_department, nal_q6_weight)
  nal_q6_weight$cat_weighted<- factor(nal_q6_weight$cat_weighted, levels = c("Very Low Knowledge","Low Knowledge", "Moderate Knowledge", "High Knowledge", "Very High Knowledge", NA))
  colmap(departamentos, data = nal_q6_weight, data_id = "id_depto", var = "cat_weighted")+
    scale_fill_manual(values = palette_soil(length(unique(nal_q6_weight$cat))-1), na.value = "#eeeeee")


```

## Question 7: `r unique(individual_surveys$question_in_english)[7]`

```{r question_7}
#selecting only question 7----
question_7<- filter(individual_surveys, question_number==7)
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_7 <- question_7 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "Somewhat Likely,Likely" ~ "Likely",
    answer_in_english == "Extremely Unlikely,Unlikely" ~ "Very Unlikely",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_7 <- question_7 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "1,3" ~ "2",
    numeric_answer == "6,7" ~ "6.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
question_7$answer_in_english<- factor(question_7$answer_in_english,levels = c("Extremely Unlikely", "Very Unlikely", "Somewhat Unlikely", 
                                                                              "Unlikely", "Neutral", "Somewhat Likely", "Likely", 
                                                                              "Very Likely", "Extremely Likely"))
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_7<- question_7 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(7, mean =average, language = "en"))
#weighted 
add_weights_question_7<- inner_join(question_7, experience_of_each_expert)
avg_dept_weight_7<- add_weights_question_7 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(7, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q7_no_weighted<- tapply(avg_dept_no_weight_7$ave_cat, avg_dept_no_weight_7$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question7_no_weighted<- palette_banana(length(levels_per_crop_Q7_no_weighted$Banana))
colors_plantain_question7_no_weighted<- palette_plantain(length(levels_per_crop_Q7_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_7 <- list(
  Banana = levels_per_crop_Q7_no_weighted$Banana,
  Plantain = levels_per_crop_Q7_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_7 <- list(
  Banana = colors_banana_question7_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question7_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_7 <- assign_group_color(data = avg_dept_no_weight_7, levels_by_crop = levels_by_crop_no_weighted_7, colors_by_crop = colors_by_crop_no_weighted_7,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q7_weighted<- tapply(avg_dept_weight_7$ave_cat_weighted, avg_dept_weight_7$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question7_weighted<- palette_banana(length(levels_per_crop_Q7_weighted$Banana))
colors_plantain_question7_weighted<- palette_plantain(length(levels_per_crop_Q7_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_7 <- list(
  Banana = levels_per_crop_Q7_weighted$Banana,
  Plantain = levels_per_crop_Q7_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_7 <- list(
  Banana = colors_banana_question7_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question7_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_7 <- assign_group_color(data = avg_dept_weight_7, levels_by_crop = levels_by_crop_weighted_7, colors_by_crop = colors_by_crop_weighted_7,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_7, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_7, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q7_no_weight<- question_7 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =7))%>%
  rename(EKE.expert.in = expert_in)
  
nal_q7_no_weight<- full_join(codes_department, nal_q7_no_weight)




nal_q7_no_weight$cat<- factor(nal_q7_no_weight$cat, levels = c("Extremely Unlikely", "Very Unlikely", "Somewhat Unlikely", 
                                                                        "Unlikely", "Neutral", "Somewhat Likely", "Likely", 
                                                                        "Very Likely", "Extremely Likely"))
colmap(departamentos, data = nal_q7_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q7_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q7_weight<- inner_join(question_7, experience_of_each_expert)
nal_q7_weight<- nal_q7_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =7)) %>%
  rename(EKE.expert.in=expert_in)

nal_q7_weight<- full_join(codes_department, nal_q7_weight)
nal_q7_weight$cat_weighted<- factor(nal_q7_weight$cat_weighted, levels = c("Extremely Unlikely", "Very Unlikely", "Somewhat Unlikely", 
                                                                           "Unlikely", "Neutral", "Somewhat Likely", "Likely", 
                                                                           "Very Likely", "Extremely Likely"))
colmap(departamentos, data = nal_q7_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q7_weight$cat))-1), na.value = "#eeeeee")

```

## Question 8: `r unique(individual_surveys$question_in_english)[8]`

```{r question_8}
#selecting only question 8----
question_8<- filter(individual_surveys, question_number==8)
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_8 <- question_8 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "Slightly Effective,Moderately Effective" ~ "Moderately Effective",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_8 <- question_8 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "2,3" ~ "2.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
question_8$answer_in_english<- factor(question_8$answer_in_english,levels = c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective", "Extremely Effective"))
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_8<- question_8 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(8, mean =average, language = "en"))
#weighted 
add_weights_question_8<- inner_join(question_8, experience_of_each_expert)
avg_dept_weight_8<- add_weights_question_8 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(8, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q8_no_weighted<- tapply(avg_dept_no_weight_8$ave_cat, avg_dept_no_weight_8$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question8_no_weighted<- palette_banana(length(levels_per_crop_Q8_no_weighted$Banana))
colors_plantain_question8_no_weighted<- palette_plantain(length(levels_per_crop_Q8_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_8 <- list(
  Banana = levels_per_crop_Q8_no_weighted$Banana,
  Plantain = levels_per_crop_Q8_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_8 <- list(
  Banana = colors_banana_question8_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question8_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_8 <- assign_group_color(data = avg_dept_no_weight_8, levels_by_crop = levels_by_crop_no_weighted_8, colors_by_crop = colors_by_crop_no_weighted_8,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q8_weighted<- tapply(avg_dept_weight_8$ave_cat_weighted, avg_dept_weight_8$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question8_weighted<- palette_banana(length(levels_per_crop_Q8_weighted$Banana))
colors_plantain_question8_weighted<- palette_plantain(length(levels_per_crop_Q8_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_8 <- list(
  Banana = levels_per_crop_Q8_weighted$Banana,
  Plantain = levels_per_crop_Q8_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_8 <- list(
  Banana = colors_banana_question8_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question8_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_8 <- assign_group_color(data = avg_dept_weight_8, levels_by_crop = levels_by_crop_weighted_8, colors_by_crop = colors_by_crop_weighted_8,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_8, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_8, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q8_no_weight<- question_8 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =8))%>%
  rename(EKE.expert.in = expert_in)
  
nal_q8_no_weight<- full_join(codes_department, nal_q8_no_weight)
nal_q8_no_weight$cat<- factor(nal_q8_no_weight$cat, levels = c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective", "Extremely Effective"))
colmap(departamentos, data = nal_q8_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q8_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q8_weight<- inner_join(question_8, experience_of_each_expert)
nal_q8_weight<- nal_q8_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =8)) %>%
  rename(EKE.expert.in=expert_in)

nal_q8_weight<- full_join(codes_department, nal_q8_weight)
nal_q8_weight$cat_weighted<- factor(nal_q8_weight$cat_weighted, levels = c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective", "Extremely Effective"))
colmap(departamentos, data = nal_q8_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q8_weight$cat))-1), na.value = "#eeeeee")
```

## Question 9: `r unique(individual_surveys$question_in_english)[9]`

```{r question_9}
#selecting only question 9----
question_9<- filter(individual_surveys, question_number==9)
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_9 <- question_9 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "Adequate,Good" ~ "Good",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_9 <- question_9 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "4,5" ~ "4.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
question_9$answer_in_english<- factor(question_9$answer_in_english,levels = c("No Training or Information Available", "Poor", "Fair", "Adequate", "Good", "Excellent", "Unsure"))
question_9<- filter(question_9, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_9<- question_9 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(9, mean =average, language = "en"))
#weighted 
add_weights_question_9<- inner_join(question_9, experience_of_each_expert)
avg_dept_weight_9<- add_weights_question_9 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(9, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q9_no_weighted<- tapply(avg_dept_no_weight_9$ave_cat, avg_dept_no_weight_9$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question9_no_weighted<- palette_banana(length(levels_per_crop_Q9_no_weighted$Banana))
colors_plantain_question9_no_weighted<- palette_plantain(length(levels_per_crop_Q9_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_9 <- list(
  Banana = levels_per_crop_Q9_no_weighted$Banana,
  Plantain = levels_per_crop_Q9_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_9 <- list(
  Banana = colors_banana_question9_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question9_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_9 <- assign_group_color(data = avg_dept_no_weight_9, levels_by_crop = levels_by_crop_no_weighted_9, colors_by_crop = colors_by_crop_no_weighted_9,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q9_weighted<- tapply(avg_dept_weight_9$ave_cat_weighted, avg_dept_weight_9$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question9_weighted<- palette_banana(length(levels_per_crop_Q9_weighted$Banana))
colors_plantain_question9_weighted<- palette_plantain(length(levels_per_crop_Q9_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_9 <- list(
  Banana = levels_per_crop_Q9_weighted$Banana,
  Plantain = levels_per_crop_Q9_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_9 <- list(
  Banana = colors_banana_question9_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question9_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_9 <- assign_group_color(data = avg_dept_weight_9, levels_by_crop = levels_by_crop_weighted_9, colors_by_crop = colors_by_crop_weighted_9,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_9, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_9, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q9_no_weight<- question_9 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =9))%>%
  rename(EKE.expert.in = expert_in)
  
nal_q9_no_weight<- full_join(codes_department, nal_q9_no_weight)
nal_q9_no_weight$cat<- factor(nal_q9_no_weight$cat, levels = c("No Training or Information Available", "Poor", "Fair", "Adequate", "Good", "Excellent", "Unsure"))
colmap(departamentos, data = nal_q9_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q9_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q9_weight<- inner_join(question_9, experience_of_each_expert)
nal_q9_weight<- nal_q9_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =9)) %>%
  rename(EKE.expert.in=expert_in)

nal_q9_weight<- full_join(codes_department, nal_q9_weight)
nal_q9_weight$cat_weighted<- factor(nal_q9_weight$cat_weighted, levels = c("No Training or Information Available", "Poor", "Fair", "Adequate", "Good", "Excellent", "Unsure"))
colmap(departamentos, data = nal_q9_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q9_weight$cat))-1), na.value = "#eeeeee")
```


## Question 10: `r unique(individual_surveys$question_in_english)[10]`



```{r question_10}
#selecting only question 10----
question_10<- filter(individual_surveys, question_number==10)
question_10$round_num_answer<- as.numeric(question_10$round_num_answer)
#Make the abbreviations
question_10 <- question_10 %>%
  mutate(cat_abbreviations = case_when(
    Add_parameters_english == "Local Certified Corms" ~ "LCC",
    Add_parameters_english == "Local Markets (informal)" ~ "LMI",
    Add_parameters_english == "Corms Stored From Previous Cycles Of The Same Farm" ~ "CSPCSF",
    Add_parameters_english == "Certified Tissue Culture Plants from International Production" ~ "CTCPIP",
    Add_parameters_english == "Certified Banana Nurseries in Colombia" ~ "CBNC",
    Add_parameters_english == "Planting Materials Shared by Neighbors or Communities" ~ "PMSNC",
    Add_parameters_english == "Certified Tissue Culture Plants from National Production" ~ "CTCPNP",
    Add_parameters_english == "Planting Materials Supplied by the Government or a Research Institution" ~ "PMSGRI",
    Add_parameters_english == "Wild Sources or Naturally Grown Sprouts" ~ "WSNGS",
    Add_parameters_english == "Not Sure" ~ "NS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#The answers by expert by department has to sum 100%. We need to double check that
answers_not_one_hundred_q10<- question_10 %>%
  group_by(expert_ID, expert_in)%>%
  summarise(new= sum(round_num_answer)) %>%
  filter(new!=100)
#Deletion of the values that do not sum 100
question_10<- filter(question_10, !(expert_ID %in% answers_not_one_hundred_q10$expert_ID &
                       expert_in %in% answers_not_one_hundred_q10$expert_in))
#NON Weighted repeat each row by the number in the column 'round_num_answer'
rep_question_10<- question_10 %>%
  slice(rep(1:n(), question_10$round_num_answer))
#counting the levels
rep_question_10_frequencies <- count_elements_by_group(rep_question_10, "cat_abbreviations", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q10_no_weighted<- tapply(rep_question_10_frequencies$cat_abbreviations, rep_question_10_frequencies$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question10_no_weighted<- palette_banana(length(levels_per_crop_Q10_no_weighted$Banana))
colors_plantain_question10_no_weighted<- palette_plantain(length(levels_per_crop_Q10_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_10 <- list(
  Banana = levels_per_crop_Q10_no_weighted$Banana,
  Plantain = levels_per_crop_Q10_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_10 <- list(
  Banana = colors_banana_question10_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question10_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
rep_question_10_frequencies <- assign_group_color(data = rep_question_10_frequencies, levels_by_crop = levels_by_crop_no_weighted_10, colors_by_crop = colors_by_crop_no_weighted_10,answer_col =  "cat_abbreviations")
#setting the data set for the plot 
rep_question_10_frequencies<- data.frame(h1= "total", 
                                         h2= as.factor(rep_question_10_frequencies$crop), 
                                         h3= as.factor(rep_question_10_frequencies$cat_abbreviations), 
                                         color= rep_question_10_frequencies$group_color,
                                         weight= (rep_question_10_frequencies$n/sum(rep_question_10_frequencies$n))*100,
                                         codes=rep_question_10_frequencies$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(rep_question_10_frequencies))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "non-weighted")
#kable(rep_question_10_frequencies)
#for the weighted analysis repeat the results of each expert by its weight
rep_question_10_weighted<- inner_join(rep_question_10, experience_of_each_expert)
rep_question_10_weighted<- rep_question_10_weighted %>%
  slice(rep(1:n(), rep_question_10_weighted$weights))
#counting the levels
rep_question_10_frequencies_weighted <- count_elements_by_group(rep_question_10_weighted, "cat_abbreviations", c("crop"))
# Now call the function
rep_question_10_frequencies_weighted <- assign_group_color(data = rep_question_10_frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_10, colors_by_crop = colors_by_crop_no_weighted_10,answer_col =  "cat_abbreviations")
#setting the data set for the plot 
rep_question_10_frequencies_weighted_plot<- data.frame(h1= "total", 
                                         h2= as.factor(rep_question_10_frequencies_weighted$crop), 
                                         h3= as.factor(rep_question_10_frequencies_weighted$cat_abbreviations), 
                                         color= rep_question_10_frequencies_weighted$group_color,
                                         weight= (rep_question_10_frequencies_weighted$n/sum(rep_question_10_frequencies_weighted$n))*100,
                                         codes=rep_question_10_frequencies_weighted$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(rep_question_10_frequencies_weighted_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "weighted")
#kable(rep_question_10_frequencies)
#Frequencies by department non-weighted
question_10_frequencies_by_depto <- count_elements_by_group(rep_question_10, "cat_abbreviations", c("crop", "expert_in"))
question_10_frequencies_by_depto <- assign_group_color(data = question_10_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_10, colors_by_crop = colors_by_crop_no_weighted_10,answer_col =  "cat_abbreviations")
#tree map
question_10_frequencies_by_depto<- question_10_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_10_frequencies_by_depto<- select(question_10_frequencies_by_depto,!n & !total)
#put it in long format
question_10_frequencies_by_depto <- question_10_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#only select top 5 for the tree map
#for banana
question_10_frequencies_by_depto_banana<- filter(question_10_frequencies_by_depto, cat_abbreviations %in% rep_question_10_frequencies$codes[which(rep_question_10_frequencies$h2=="Banana")], crop=="Banana")
#for plantain
question_10_frequencies_by_depto_plantain<- filter(question_10_frequencies_by_depto, cat_abbreviations %in% rep_question_10_frequencies$codes[which(rep_question_10_frequencies$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_10_frequencies_by_depto<- rbind(question_10_frequencies_by_depto_banana, question_10_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_10_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="Sources of Planting Material Plantain - non weighted")
#tree map only banana
tree_map_3(data = filter(question_10_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="Sources of Planting Material Banana - non weighted")
#Frequencies by department weighted
question_10_frequencies_by_depto_NW <- count_elements_by_group(rep_question_10_weighted, "cat_abbreviations", c("crop", "expert_in"))
question_10_frequencies_by_depto_NW <- assign_group_color(data = question_10_frequencies_by_depto_NW, levels_by_crop = levels_by_crop_no_weighted_10, colors_by_crop = colors_by_crop_no_weighted_10,answer_col =  "cat_abbreviations")
#tree map
question_10_frequencies_by_depto_NW<- question_10_frequencies_by_depto_NW %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_10_frequencies_by_depto_NW<- select(question_10_frequencies_by_depto_NW,!n & !total)
#put it in long format
question_10_frequencies_by_depto_NW <- question_10_frequencies_by_depto_NW %>% 
  uncount(weights = mean, .id = "id")
#only select top 5 for the tree map
#for banana
question_10_frequencies_by_depto_NW_banana<- filter(question_10_frequencies_by_depto_NW, cat_abbreviations %in% rep_question_10_frequencies_weighted_plot$codes[which(rep_question_10_frequencies_weighted_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_10_frequencies_by_depto_NW_plantain<- filter(question_10_frequencies_by_depto_NW, cat_abbreviations %in% rep_question_10_frequencies_weighted_plot$codes[which(rep_question_10_frequencies_weighted_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_10_frequencies_by_depto_NW<- rbind(question_10_frequencies_by_depto_NW_banana, question_10_frequencies_by_depto_NW_plantain)
#tree map only plantain
tree_map_3(data = filter(question_10_frequencies_by_depto_NW, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="Sources of Planting Material Plantain - weighted")
#tree map only banana
tree_map_3(data = filter(question_10_frequencies_by_depto_NW, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="Sources of Planting Material Banana - weighted")
#Additional top 5 diseases and pest in Colombia
q10_top_5Colobia<- count_elements_by_group(rep_question_10, "cat_abbreviations", c("cat_abbreviations"))
q10_top_5Colobia$mean<-round((q10_top_5Colobia$n/sum(q10_top_5Colobia$n)*100),0)
q10_top_5Colobia$background_color<- "white"
q10_top_5Colobia$color<- palette_soil(length(unique(q10_top_5Colobia$cat_abbreviations)))
#sort the results by mean
q10_top_5Colobia <- q10_top_5Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q10_top_5Colobia$cat_abbreviations<- factor(q10_top_5Colobia$cat_abbreviations, levels = q10_top_5Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q10_top_5Colobia,x_lab = "Source of Planting Material - NW", y_lab ="Proportion of Experts (%)", title = "
Sources of Planting Material Identified by Experts" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
#Additional top 5 diseases and pest in Colombia
q10_top_5Colobia<- count_elements_by_group(rep_question_10_weighted, "cat_abbreviations", c("cat_abbreviations"))
q10_top_5Colobia$mean<-round((q10_top_5Colobia$n/sum(q10_top_5Colobia$n)*100),0)
q10_top_5Colobia$background_color<- "white"
q10_top_5Colobia$color<- palette_soil(length(unique(q10_top_5Colobia$cat_abbreviations)))
#sort the results by mean
q10_top_5Colobia <- q10_top_5Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q10_top_5Colobia$cat_abbreviations<- factor(q10_top_5Colobia$cat_abbreviations, levels = q10_top_5Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q10_top_5Colobia,x_lab = "Source of Planting Material - weighted", y_lab ="Proportion of Experts (%)", title = "
Sources of Planting Material Identified by Experts" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```

## Question 11: `r unique(individual_surveys$question_in_english)[11]`

```{r questoin_11}
#selecting only question 11----
question_11<- filter(individual_surveys, question_number==11)
#unique(question_11$numeric_answer)
#dput(unique(question_11$answer_in_english))
# question_11 <- question_11 %>%
#   mutate(answer_in_english= case_when(
#     answer_in_english=="10 to 0" ~ "0%",
#     answer_in_english=="9 to 1" ~ "10%",
#     answer_in_english=="8 to 2" ~ "20%",
#     answer_in_english=="7 to 3" ~ "30%",
#     answer_in_english=="6 to 4" ~ "40%",
#     answer_in_english=="5 to 5" ~ "50%",
#     answer_in_english=="4 to 6" ~ "60%",
#     answer_in_english=="3 to 7" ~ "70%",
#     answer_in_english=="2 to 8" ~ "80%",
#     answer_in_english=="1 to 9" ~ "90%",
#     answer_in_english=="0 to 10" ~ "100%",
#   ))
#organizing the order of the levels
level_11<- c("0 to 10", "1 to 9", "2 to 8", "3 to 7", "4 to 6", "5 to 5", "6 to 4", "7 to 3", "8 to 2", "9 to 1", "10 to 0")
question_11$answer_in_english<- factor(question_11$answer_in_english,levels = level_11)
#question_11<- filter(question_11, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_11<- question_11 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(11, mean =average, language = "en"))
#weighted 
add_weights_question_11<- inner_join(question_11, experience_of_each_expert)
avg_dept_weight_11<- add_weights_question_11 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(11, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q11_no_weighted<- tapply(avg_dept_no_weight_11$ave_cat, avg_dept_no_weight_11$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question11_no_weighted<- palette_banana(length(levels_per_crop_Q11_no_weighted$Banana))
colors_plantain_question11_no_weighted<- palette_plantain(length(levels_per_crop_Q11_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_11 <- list(
  Banana = levels_per_crop_Q11_no_weighted$Banana,
  Plantain = levels_per_crop_Q11_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_11 <- list(
  Banana = colors_banana_question11_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question11_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_11 <- assign_group_color(data = avg_dept_no_weight_11, levels_by_crop = levels_by_crop_no_weighted_11, colors_by_crop = colors_by_crop_no_weighted_11,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q11_weighted<- tapply(avg_dept_weight_11$ave_cat_weighted, avg_dept_weight_11$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question11_weighted<- palette_banana(length(levels_per_crop_Q11_weighted$Banana))
colors_plantain_question11_weighted<- palette_plantain(length(levels_per_crop_Q11_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_11 <- list(
  Banana = levels_per_crop_Q11_weighted$Banana,
  Plantain = levels_per_crop_Q11_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_11 <- list(
  Banana = colors_banana_question11_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question11_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_11 <- assign_group_color(data = avg_dept_weight_11, levels_by_crop = levels_by_crop_weighted_11, colors_by_crop = colors_by_crop_weighted_11,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_11, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_11, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q11_no_weight<- question_11 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =11))%>%
  rename(EKE.expert.in = expert_in)

nal_q11_no_weight<- full_join(codes_department, nal_q11_no_weight)
nal_q11_no_weight$cat<- factor(nal_q11_no_weight$cat, levels = level_11)
colmap(departamentos, data = nal_q11_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q11_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q11_weight<- inner_join(question_11, experience_of_each_expert)
nal_q11_weight<- nal_q11_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =11)) %>%
  rename(EKE.expert.in=expert_in)

nal_q11_weight<- full_join(codes_department, nal_q11_weight)
nal_q11_weight$cat_weighted<- factor(nal_q11_weight$cat_weighted, levels = level_11)
colmap(departamentos, data = nal_q11_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q11_weight$cat))-1), na.value = "#eeeeee")
#this information will be used for weighting the network of trade of planting material
nal_q11_weight$percentage_informal<-round(nal_q11_weight$average_weighted -1, 0)*10
write.csv(nal_q11_weight, "C:/Users/jrobl/OneDrive - University of Florida/Documents/TA_2023_R2M/R2M_Colombia_banana_and_plantain/Data/SUP_Percentage_of_informal_planting_material_by_department.csv", row.names = F)
```







## Question 12: `r unique(individual_surveys$question_in_english)[12]`

```{r question_12}
#selecting only question 12----
question_12<- filter(individual_surveys, question_number==12)
#select Add_parameters_english different than "Not Sure"
question_12<- filter(question_12, Add_parameters_english!="Not Sure")
#Verify the unique values in the numeric_answer column
unique(question_12$numeric_answer)
#Verify if the percentages by expert and department sum 100% and select those that are not 100%
verification_12<- question_12 %>%
  group_by(crop, expert_in, expert_ID) %>%
  summarise(sum= sum(as.numeric(numeric_answer))) %>%
  filter(sum!=100)
#Remove the experts by department and crop that answer more or less than 100%
question_12<- anti_join(question_12, verification_12, by=c("crop", "expert_in", "expert_ID"))
#double chech all the kept values are 100%
# verification_12<- question_12 %>%
#   group_by(crop, expert_in, expert_ID) %>%
#   summarise(sum= sum(as.numeric(numeric_answer)))
# nrow(verification_12)
# sum(verification_12$sum==100)
question_12<- inner_join(question_12, experience_of_each_expert)
#repeat the interaction the number of times given in the numeric answer column
question_12$numeric_answer<- as.numeric(question_12$numeric_answer)
question_12_long<- question_12 %>%
  slice(rep(1:n(),question_12$numeric_answer)) 
#Add the weights for the weighted data set
question_12_long_weighted<- question_12_long %>%
  slice(rep(1:n(), question_12_long$weights))
question_12_long_frequencies<- summarise_frequencies(data=question_12_long, first_group_cols = c("crop","expert_in"), second_group_cols =  c("crop","expert_in", "Add_parameters_english"))
question_12_long_frequencies_weighted<- summarise_frequencies(data=question_12_long_weighted, first_group_cols = c("crop","expert_in"), second_group_cols =  c("crop","expert_in", "Add_parameters_english"))
#shift for plantain source target 
question_12_long_frequencies_banana<- filter(question_12_long_frequencies, crop=="Banana")
question_12_long_frequencies_plantain<- filter(question_12_long_frequencies, crop=="Plantain")
colnames(question_12_long_frequencies_plantain)<- c("crop",  "Add_parameters_english", "expert_in", "freq_unique")
question_12_long_frequencies<- rbind(question_12_long_frequencies_banana, question_12_long_frequencies_plantain)
#weighted
question_12_long_frequencies_banana<- filter(question_12_long_frequencies_weighted, crop=="Banana")
question_12_long_frequencies_plantain<- filter(question_12_long_frequencies_weighted, crop=="Plantain")
colnames(question_12_long_frequencies_plantain)<- c("crop",  "Add_parameters_english", "expert_in", "freq_unique")
question_12_long_frequencies_weighted<- rbind(question_12_long_frequencies_banana, question_12_long_frequencies_plantain)


#National non weighted 
sankey_national_non_weighted_12 <- create_sankey(
  data = question_12_long_frequencies,
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_soil(length(unique(question_12_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_national_non_weighted_12


sankey_banana_non_weighted_12 <- create_sankey(
  data = filter(question_12_long_frequencies, crop=="Banana"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_banana(length(unique(question_12_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_banana_non_weighted_12

#Plantain non weighted 
sankey_plantain_non_weighted_12 <- create_sankey(
  data = filter(question_12_long_frequencies, crop=="Plantain"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_plantain(length(unique(question_12_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_plantain_non_weighted_12


#National weighted 
sankey_national_non_weighted_12 <- create_sankey(
  data = question_12_long_frequencies_weighted,
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_soil(length(unique(question_12_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_national_non_weighted_12
#banana weighted 
sankey_banana_non_weighted_12 <- create_sankey(
  data = filter(question_12_long_frequencies_weighted, crop=="Banana"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_banana(length(unique(question_12_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_banana_non_weighted_12
#Plantain weighted 
sankey_plantain_non_weighted_12 <- create_sankey(
  data = filter(question_12_long_frequencies_weighted, crop=="Plantain"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_plantain(length(unique(question_12_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_plantain_non_weighted_12
```

## Question 13: `r unique(individual_surveys$question_in_english)[13]`

```{r questoin_13}

#selecting only question 13----
question_13<- filter(individual_surveys, question_number==13)
#organizing the order of the levels
question_13$answer_in_english<- factor(question_13$answer_in_english,levels = c("Every 1 or 2 cycles", "Every 3 to 4 cycles", "Every 5 to 6 cycles",  "Every 7 or more cycles", "Not Sure"))
question_13<- filter(question_13, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_13<- question_13 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(13, mean =average, language = "en"))
#weighted 
add_weights_question_13<- inner_join(question_13, experience_of_each_expert)
avg_dept_weight_13<- add_weights_question_13 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(13, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q13_no_weighted<- tapply(avg_dept_no_weight_13$ave_cat, avg_dept_no_weight_13$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question13_no_weighted<- palette_banana(length(levels_per_crop_Q13_no_weighted$Banana))
colors_plantain_question13_no_weighted<- palette_plantain(length(levels_per_crop_Q13_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_13 <- list(
  Banana = levels_per_crop_Q13_no_weighted$Banana,
  Plantain = levels_per_crop_Q13_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_13 <- list(
  Banana = colors_banana_question13_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question13_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_13 <- assign_group_color(data = avg_dept_no_weight_13, levels_by_crop = levels_by_crop_no_weighted_13, colors_by_crop = colors_by_crop_no_weighted_13,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q13_weighted<- tapply(avg_dept_weight_13$ave_cat_weighted, avg_dept_weight_13$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question13_weighted<- palette_banana(length(levels_per_crop_Q13_weighted$Banana))
colors_plantain_question13_weighted<- palette_plantain(length(levels_per_crop_Q13_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_13 <- list(
  Banana = levels_per_crop_Q13_weighted$Banana,
  Plantain = levels_per_crop_Q13_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_13 <- list(
  Banana = colors_banana_question13_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question13_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_13 <- assign_group_color(data = avg_dept_weight_13, levels_by_crop = levels_by_crop_weighted_13, colors_by_crop = colors_by_crop_weighted_13,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_13, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_13, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q13_no_weight<- question_13 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =13))%>%
  rename(EKE.expert.in = expert_in)
  
nal_q13_no_weight<- full_join(codes_department, nal_q13_no_weight)
nal_q13_no_weight$cat<- factor(nal_q13_no_weight$cat, levels = c("Every 1 or 2 cycles", "Every 3 to 4 cycles", "Every 5 to 6 cycles",  "Every 7 or more cycles", "Not Sure"))
colmap(departamentos, data = nal_q13_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q13_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q13_weight<- inner_join(question_13, experience_of_each_expert)
nal_q13_weight<- nal_q13_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =13)) %>%
  rename(EKE.expert.in=expert_in)

nal_q13_weight<- full_join(codes_department, nal_q13_weight)
nal_q13_weight$cat_weighted<- factor(nal_q13_weight$cat_weighted, levels = c("Every 1 or 2 cycles", "Every 3 to 4 cycles", "Every 5 to 6 cycles",  "Every 7 or more cycles", "Not Sure"))
colmap(departamentos, data = nal_q13_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q13_weight$cat))-1), na.value = "#eeeeee")
```

## Question 14: `r unique(individual_surveys$question_in_english)[14]`

```{R question_14}
#selecting only question 14----
question_14<- filter(individual_surveys, question_number==14)
#dput(unique(question_14$))
question_14<- filter(question_14, answer_in_english!="Unsure")
question_14_Frequencies_non_weighted<- count_elements_by_group(question_14, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q14_no_weighted<- tapply(question_14_Frequencies_non_weighted$answer_in_english, question_14_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question14_no_weighted<- palette_banana(length(levels_per_crop_Q14_no_weighted$Banana))
colors_plantain_question14_no_weighted<- palette_plantain(length(levels_per_crop_Q14_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_14 <- list(
  Banana = levels_per_crop_Q14_no_weighted$Banana,
  Plantain = levels_per_crop_Q14_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_14 <- list(
  Banana = colors_banana_question14_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question14_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_14 <- assign_group_color(data = question_14_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_14, colors_by_crop = colors_by_crop_no_weighted_14,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_14 <- avg_no_weight_14 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Compliance with Regulations" ~ "CWR",
    answer_in_english == "Consultation with Experts" ~ "CWE",
    answer_in_english == "Inspection and Testing" ~ "IAT",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Quarantine and Isolation" ~ "QAI",
    answer_in_english == "Record Keeping" ~ "RK",
    answer_in_english == "Storage Conditions" ~ "SC",
    answer_in_english == "Training and Awareness" ~ "TAA",
    answer_in_english == "Treatment and Disinfection" ~ "TAD",
    answer_in_english == "Community Involvement" ~ "CI",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_14_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_14$crop,
                                    h3= avg_no_weight_14$answer_in_english,
                                    color= avg_no_weight_14$group_color,
                                    weight= avg_no_weight_14$n,
                                    codes= avg_no_weight_14$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_14_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_14_weihted<- inner_join(question_14, experience_of_each_expert)
rep_question_14_weighted<- question_14_weihted %>%
  slice(rep(1:n(), question_14_weihted$weights))
question_14_Frequencies_weighted<- count_elements_by_group(rep_question_14_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_14 <- assign_group_color(data = question_14_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_14, colors_by_crop = colors_by_crop_no_weighted_14,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_14 <- avg_weight_14 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Compliance with Regulations" ~ "CWR",
    answer_in_english == "Consultation with Experts" ~ "CWE",
    answer_in_english == "Inspection and Testing" ~ "IAT",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Quarantine and Isolation" ~ "QAI",
    answer_in_english == "Record Keeping" ~ "RK",
    answer_in_english == "Storage Conditions" ~ "SC",
    answer_in_english == "Training and Awareness" ~ "TAA",
    answer_in_english == "Treatment and Disinfection" ~ "TAD",
    answer_in_english == "Community Involvement" ~ "CI",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_weight_14_plot<- data.frame(h1= "total",
                                   h2= avg_weight_14$crop,
                                   h3= avg_weight_14$answer_in_english,
                                   color= avg_weight_14$group_color,
                                   weight= avg_weight_14$n,
                                   codes= avg_weight_14$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_14_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "weighted")
#Frequencies by department
question_14_frequencies_by_depto <- count_elements_by_group(question_14, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_14_frequencies_by_depto <- assign_group_color(data = question_14_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_14, colors_by_crop = colors_by_crop_no_weighted_14,answer_col =  "answer_in_english")
#Make the abbreviations
question_14_frequencies_by_depto <- question_14_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Compliance with Regulations" ~ "CWR",
    answer_in_english == "Consultation with Experts" ~ "CWE",
    answer_in_english == "Inspection and Testing" ~ "IAT",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Quarantine and Isolation" ~ "QAI",
    answer_in_english == "Record Keeping" ~ "RK",
    answer_in_english == "Storage Conditions" ~ "SC",
    answer_in_english == "Training and Awareness" ~ "TAA",
    answer_in_english == "Treatment and Disinfection" ~ "TAD",
    answer_in_english == "Community Involvement" ~ "CI",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_14_frequencies_by_depto<- select(question_14_frequencies_by_depto,!answer_in_english)
question_14_frequencies_by_depto<- question_14_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_14_frequencies_by_depto<- select(question_14_frequencies_by_depto,!n & !total)
#put it in long format
question_14_frequencies_by_depto <- question_14_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_14_frequencies_by_depto_banana<- filter(question_14_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_14_plot$codes[which(avg_no_weight_14_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_14_frequencies_by_depto_plantain<- filter(question_14_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_14_plot$codes[which(avg_no_weight_14_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_14_frequencies_by_depto<- rbind(question_14_frequencies_by_depto_banana, question_14_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_14_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_14_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_14_frequencies_by_depto_wei <- count_elements_by_group(rep_question_14_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_14_frequencies_by_depto_wei <- assign_group_color(data = question_14_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_14, colors_by_crop = colors_by_crop_no_weighted_14,answer_col =  "answer_in_english")
#Make the abbreviations
question_14_frequencies_by_depto_wei <- question_14_frequencies_by_depto_wei %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Compliance with Regulations" ~ "CWR",
    answer_in_english == "Consultation with Experts" ~ "CWE",
    answer_in_english == "Inspection and Testing" ~ "IAT",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Quarantine and Isolation" ~ "QAI",
    answer_in_english == "Record Keeping" ~ "RK",
    answer_in_english == "Storage Conditions" ~ "SC",
    answer_in_english == "Training and Awareness" ~ "TAA",
    answer_in_english == "Treatment and Disinfection" ~ "TAD",
    answer_in_english == "Community Involvement" ~ "CI",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_14_frequencies_by_depto_wei<- select(question_14_frequencies_by_depto_wei,!answer_in_english)
question_14_frequencies_by_depto_wei<- question_14_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_14_frequencies_by_depto_wei<- select(question_14_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_14_frequencies_by_depto_wei <- question_14_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_14_frequencies_by_depto_banana_wei<- filter(question_14_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_14_plot$codes[which(avg_no_weight_14_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_14_frequencies_by_depto_plantain_wei<- filter(question_14_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_14_plot$codes[which(avg_no_weight_14_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_14_frequencies_by_depto_wei<- rbind(question_14_frequencies_by_depto_banana_wei, question_14_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_14_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_14_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 14 diseases and pest in Colombia
q14_top_14Colobia<- count_elements_by_group(question_14, "answer_in_english", c("answer_in_english"))
q14_top_14Colobia$mean<-round((q14_top_14Colobia$n/sum(q14_top_14Colobia$n)*100),0)
q14_top_14Colobia$background_color<- "white"
q14_top_14Colobia$color<- palette_soil(length(unique(q14_top_14Colobia$answer_in_english)))
#Make the abbreviations
q14_top_14Colobia <- q14_top_14Colobia %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Compliance with Regulations" ~ "CWR",
    answer_in_english == "Consultation with Experts" ~ "CWE",
    answer_in_english == "Inspection and Testing" ~ "IAT",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Quarantine and Isolation" ~ "QAI",
    answer_in_english == "Record Keeping" ~ "RK",
    answer_in_english == "Storage Conditions" ~ "SC",
    answer_in_english == "Training and Awareness" ~ "TAA",
    answer_in_english == "Treatment and Disinfection" ~ "TAD",
    answer_in_english == "Community Involvement" ~ "CI",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#sort the results by mean
q14_top_14Colobia <- q14_top_14Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q14_top_14Colobia$cat_abbreviations<- factor(q14_top_14Colobia$cat_abbreviations, levels = q14_top_14Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q14_top_14Colobia,x_lab = "Procedure Followed", y_lab ="Proportion of Experts (%)", title = "
Procedures Followed to Ensure the Quality of Planting Material -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 14 diseases and pest in Colombia -WEIGHTED
q_14_weighted_top_14Colobia<- count_elements_by_group(rep_question_14_weighted, "answer_in_english", c("answer_in_english"))
q_14_weighted_top_14Colobia$mean<-round((q_14_weighted_top_14Colobia$n/sum(q_14_weighted_top_14Colobia$n)*100),0)
q_14_weighted_top_14Colobia$background_color<- "white"
q_14_weighted_top_14Colobia$color<- palette_soil(length(unique(q_14_weighted_top_14Colobia$answer_in_english)))
#Make the abbreviations
q_14_weighted_top_14Colobia <- q_14_weighted_top_14Colobia %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Compliance with Regulations" ~ "CWR",
    answer_in_english == "Consultation with Experts" ~ "CWE",
    answer_in_english == "Inspection and Testing" ~ "IAT",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Quarantine and Isolation" ~ "QAI",
    answer_in_english == "Record Keeping" ~ "RK",
    answer_in_english == "Storage Conditions" ~ "SC",
    answer_in_english == "Training and Awareness" ~ "TAA",
    answer_in_english == "Treatment and Disinfection" ~ "TAD",
    answer_in_english == "Community Involvement" ~ "CI",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#sort the results by mean
q_14_weighted_top_14Colobia <- q_14_weighted_top_14Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_14_weighted_top_14Colobia$cat_abbreviations<- factor(q_14_weighted_top_14Colobia$cat_abbreviations, levels = q_14_weighted_top_14Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_14_weighted_top_14Colobia,x_lab = "Procedure Followed", y_lab ="Proportion of Experts (%)", title = "
Procedures Followed to Ensure the Quality of Planting Material - W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```

## Question 15: `r unique(individual_surveys$question_in_english)[15]`


```{r question_15}
#selecting only question 15----
question_15<- filter(individual_surveys, question_number==15)
#dput(unique(question_15$answer_in_english))
question_15<- filter(question_15, answer_in_english!="Unsure")
question_15_Frequencies_non_weighted<- count_elements_by_group(question_15, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q15_no_weighted<- tapply(question_15_Frequencies_non_weighted$answer_in_english, question_15_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question15_no_weighted<- palette_banana(length(levels_per_crop_Q15_no_weighted$Banana))
colors_plantain_question15_no_weighted<- palette_plantain(length(levels_per_crop_Q15_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_15 <- list(
  Banana = levels_per_crop_Q15_no_weighted$Banana,
  Plantain = levels_per_crop_Q15_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_15 <- list(
  Banana = colors_banana_question15_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question15_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_15 <- assign_group_color(data = question_15_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_15, colors_by_crop = colors_by_crop_no_weighted_15,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_15 <- avg_no_weight_15 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Biological Control" ~ "BC",
    answer_in_english == "Biosecurity Measures" ~ "BM",
    answer_in_english == "Chemical Control" ~ "CC",
    answer_in_english == "Community Participation" ~ "CP",
    answer_in_english == "Cultural Control" ~ "CUC",
    answer_in_english == "Education and Training" ~ "EAT",
    answer_in_english == "Integrated Pest and Disease Management" ~ "IPDM",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "Physical Control" ~ "PC",
    answer_in_english == "Regulatory Compliance" ~ "RC",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_15_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_15$crop,
                                    h3= avg_no_weight_15$answer_in_english,
                                    color= avg_no_weight_15$group_color,
                                    weight= avg_no_weight_15$n,
                                    codes= avg_no_weight_15$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_15_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_15_weihted<- inner_join(question_15, experience_of_each_expert)
rep_question_15_weighted<- question_15_weihted %>%
  slice(rep(1:n(), question_15_weihted$weights))
question_15_Frequencies_weighted<- count_elements_by_group(rep_question_15_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_15 <- assign_group_color(data = question_15_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_15, colors_by_crop = colors_by_crop_no_weighted_15,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_15 <- avg_weight_15 %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Biological Control" ~ "BC",
      answer_in_english == "Biosecurity Measures" ~ "BM",
      answer_in_english == "Chemical Control" ~ "CC",
      answer_in_english == "Community Participation" ~ "CP",
      answer_in_english == "Cultural Control" ~ "CUC",
      answer_in_english == "Education and Training" ~ "EAT",
      answer_in_english == "Integrated Pest and Disease Management" ~ "IPDM",
      answer_in_english == "Monitoring and Reporting" ~ "MAR",
      answer_in_english == "Physical Control" ~ "PC",
      answer_in_english == "Regulatory Compliance" ~ "RC",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met  
      ))
avg_weight_15_plot<- data.frame(h1= "total",
                                   h2= avg_weight_15$crop,
                                   h3= avg_weight_15$answer_in_english,
                                   color= avg_weight_15$group_color,
                                   weight= avg_weight_15$n,
                                   codes= avg_weight_15$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_15_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "weighted")
#Frequencies by department
question_15_frequencies_by_depto <- count_elements_by_group(question_15, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_15_frequencies_by_depto <- assign_group_color(data = question_15_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_15, colors_by_crop = colors_by_crop_no_weighted_15,answer_col =  "answer_in_english")
#Make the abbreviations
question_15_frequencies_by_depto <- question_15_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Biological Control" ~ "BC",
    answer_in_english == "Biosecurity Measures" ~ "BM",
    answer_in_english == "Chemical Control" ~ "CC",
    answer_in_english == "Community Participation" ~ "CP",
    answer_in_english == "Cultural Control" ~ "CUC",
    answer_in_english == "Education and Training" ~ "EAT",
    answer_in_english == "Integrated Pest and Disease Management" ~ "IPDM",
    answer_in_english == "Monitoring and Reporting" ~ "MAR",
    answer_in_english == "Physical Control" ~ "PC",
    answer_in_english == "Regulatory Compliance" ~ "RC",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#tree map
question_15_frequencies_by_depto<- select(question_15_frequencies_by_depto,!answer_in_english)
question_15_frequencies_by_depto<- question_15_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_15_frequencies_by_depto<- select(question_15_frequencies_by_depto,!n & !total)
#put it in long format
question_15_frequencies_by_depto <- question_15_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_15_frequencies_by_depto_banana<- filter(question_15_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_15_plot$codes[which(avg_no_weight_15_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_15_frequencies_by_depto_plantain<- filter(question_15_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_15_plot$codes[which(avg_no_weight_15_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_15_frequencies_by_depto<- rbind(question_15_frequencies_by_depto_banana, question_15_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_15_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_15_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_15_frequencies_by_depto_wei <- count_elements_by_group(rep_question_15_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_15_frequencies_by_depto_wei <- assign_group_color(data = question_15_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_15, colors_by_crop = colors_by_crop_no_weighted_15,answer_col =  "answer_in_english")
#Make the abbreviations
question_15_frequencies_by_depto_wei <- question_15_frequencies_by_depto_wei %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Biological Control" ~ "BC",
      answer_in_english == "Biosecurity Measures" ~ "BM",
      answer_in_english == "Chemical Control" ~ "CC",
      answer_in_english == "Community Participation" ~ "CP",
      answer_in_english == "Cultural Control" ~ "CUC",
      answer_in_english == "Education and Training" ~ "EAT",
      answer_in_english == "Integrated Pest and Disease Management" ~ "IPDM",
      answer_in_english == "Monitoring and Reporting" ~ "MAR",
      answer_in_english == "Physical Control" ~ "PC",
      answer_in_english == "Regulatory Compliance" ~ "RC",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
      ))
#tree map
question_15_frequencies_by_depto_wei<- select(question_15_frequencies_by_depto_wei,!answer_in_english)
question_15_frequencies_by_depto_wei<- question_15_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_15_frequencies_by_depto_wei<- select(question_15_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_15_frequencies_by_depto_wei <- question_15_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_15_frequencies_by_depto_banana_wei<- filter(question_15_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_15_plot$codes[which(avg_no_weight_15_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_15_frequencies_by_depto_plantain_wei<- filter(question_15_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_15_plot$codes[which(avg_no_weight_15_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_15_frequencies_by_depto_wei<- rbind(question_15_frequencies_by_depto_banana_wei, question_15_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_15_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_15_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 15 diseases and pest in Colombia
q15_top_15Colobia<- count_elements_by_group(question_15, "answer_in_english", c("answer_in_english"))
q15_top_15Colobia$mean<-round((q15_top_15Colobia$n/sum(q15_top_15Colobia$n)*100),0)
q15_top_15Colobia$background_color<- "white"
q15_top_15Colobia$color<- palette_soil(length(unique(q15_top_15Colobia$answer_in_english)))
#Make the abbreviations
q15_top_15Colobia <- q15_top_15Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Biological Control" ~ "BC",
      answer_in_english == "Biosecurity Measures" ~ "BM",
      answer_in_english == "Chemical Control" ~ "CC",
      answer_in_english == "Community Participation" ~ "CP",
      answer_in_english == "Cultural Control" ~ "CUC",
      answer_in_english == "Education and Training" ~ "EAT",
      answer_in_english == "Integrated Pest and Disease Management" ~ "IPDM",
      answer_in_english == "Monitoring and Reporting" ~ "MAR",
      answer_in_english == "Physical Control" ~ "PC",
      answer_in_english == "Regulatory Compliance" ~ "RC",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
      ))
#sort the results by mean
q15_top_15Colobia <- q15_top_15Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q15_top_15Colobia$cat_abbreviations<- factor(q15_top_15Colobia$cat_abbreviations, levels = q15_top_15Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q15_top_15Colobia,x_lab = "Management Practices", y_lab ="Proportion of Experts (%)", title = "
Management Practices to Control Pest and Diseases -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 15 diseases and pest in Colombia -WEIGHTED
q_15_weighted_top_15Colobia<- count_elements_by_group(rep_question_15_weighted, "answer_in_english", c("answer_in_english"))
q_15_weighted_top_15Colobia$mean<-round((q_15_weighted_top_15Colobia$n/sum(q_15_weighted_top_15Colobia$n)*100),0)
q_15_weighted_top_15Colobia$background_color<- "white"
q_15_weighted_top_15Colobia$color<- palette_soil(length(unique(q_15_weighted_top_15Colobia$answer_in_english)))
#Make the abbreviations
q_15_weighted_top_15Colobia <- q_15_weighted_top_15Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Biological Control" ~ "BC",
      answer_in_english == "Biosecurity Measures" ~ "BM",
      answer_in_english == "Chemical Control" ~ "CC",
      answer_in_english == "Community Participation" ~ "CP",
      answer_in_english == "Cultural Control" ~ "CUC",
      answer_in_english == "Education and Training" ~ "EAT",
      answer_in_english == "Integrated Pest and Disease Management" ~ "IPDM",
      answer_in_english == "Monitoring and Reporting" ~ "MAR",
      answer_in_english == "Physical Control" ~ "PC",
      answer_in_english == "Regulatory Compliance" ~ "RC",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
      ))
#sort the results by mean
q_15_weighted_top_15Colobia <- q_15_weighted_top_15Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_15_weighted_top_15Colobia$cat_abbreviations<- factor(q_15_weighted_top_15Colobia$cat_abbreviations, levels = q_15_weighted_top_15Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_15_weighted_top_15Colobia,x_lab = "Management Practices", y_lab ="Proportion of Experts (%)", title = "
Management Practices to Control Pest and Diseases -  W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```


## Question 16: `r unique(individual_surveys$question_in_english)[16]`

```{r questoin_16}
#selecting only question 16----
question_16<- filter(individual_surveys, question_number==16)
#unique(question_16$numeric_answer)
#dput(unique(question_16$answer_in_english))
#organizing the order of the levels
level_16<- c("0%", "1%-10%", "11%-20%", "21%-30%", "31%-40%", "41%-50%","51%-60%", "61%-70%", "71%-80%", "81%-90%", "91%-100%", "Not Sure")
question_16$answer_in_english<- factor(question_16$answer_in_english,levels = level_16)
question_16<- filter(question_16, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_16<- question_16 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(16, mean =average, language = "en"))
#weighted 
add_weights_question_16<- inner_join(question_16, experience_of_each_expert)
avg_dept_weight_16<- add_weights_question_16 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(16, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q16_no_weighted<- tapply(avg_dept_no_weight_16$ave_cat, avg_dept_no_weight_16$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question16_no_weighted<- palette_banana(length(levels_per_crop_Q16_no_weighted$Banana))
colors_plantain_question16_no_weighted<- palette_plantain(length(levels_per_crop_Q16_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_16 <- list(
  Banana = levels_per_crop_Q16_no_weighted$Banana,
  Plantain = levels_per_crop_Q16_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_16 <- list(
  Banana = colors_banana_question16_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question16_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_16 <- assign_group_color(data = avg_dept_no_weight_16, levels_by_crop = levels_by_crop_no_weighted_16, colors_by_crop = colors_by_crop_no_weighted_16,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q16_weighted<- tapply(avg_dept_weight_16$ave_cat_weighted, avg_dept_weight_16$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question16_weighted<- palette_banana(length(levels_per_crop_Q16_weighted$Banana))
colors_plantain_question16_weighted<- palette_plantain(length(levels_per_crop_Q16_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_16 <- list(
  Banana = levels_per_crop_Q16_weighted$Banana,
  Plantain = levels_per_crop_Q16_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_16 <- list(
  Banana = colors_banana_question16_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question16_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_16 <- assign_group_color(data = avg_dept_weight_16, levels_by_crop = levels_by_crop_weighted_16, colors_by_crop = colors_by_crop_weighted_16,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_16, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_16, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q16_no_weight<- question_16 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =16))%>%
  rename(EKE.expert.in = expert_in)

nal_q16_no_weight<- full_join(codes_department, nal_q16_no_weight)
nal_q16_no_weight$cat<- factor(nal_q16_no_weight$cat, levels = level_16)
colmap(departamentos, data = nal_q16_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q16_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q16_weight<- inner_join(question_16, experience_of_each_expert)
nal_q16_weight<- nal_q16_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =16)) %>%
  rename(EKE.expert.in=expert_in)

nal_q16_weight<- full_join(codes_department, nal_q16_weight)
nal_q16_weight$cat_weighted<- factor(nal_q16_weight$cat_weighted, levels = level_16)
colmap(departamentos, data = nal_q16_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q16_weight$cat))-1), na.value = "#eeeeee")
```


## Question 17: `r unique(individual_surveys$question_in_english)[17]`

```{r question_17}
#selecting only question 17----
question_17<- filter(individual_surveys, question_number==17)
#unique(question_17$numeric_answer)
#dput(unique(question_17$answer_in_english))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_17 <- question_17 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "71%-80%,81%-90%" ~ "81%-90%",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_17 <- question_17 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "9,10" ~ "10.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
level_17<- c("0%", "1%-10%", "11%-20%", "21%-30%", "31%-40%", "41%-50%","51%-60%", "61%-70%", "71%-80%", "81%-90%", "91%-100%", "Not Sure")
question_17$answer_in_english<- factor(question_17$answer_in_english,levels = level_17)
question_17<- filter(question_17, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_17<- question_17 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(17, mean =average, language = "en"))
#weighted 
add_weights_question_17<- inner_join(question_17, experience_of_each_expert)
avg_dept_weight_17<- add_weights_question_17 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(17, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q17_no_weighted<- tapply(avg_dept_no_weight_17$ave_cat, avg_dept_no_weight_17$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question17_no_weighted<- palette_banana(length(levels_per_crop_Q17_no_weighted$Banana))
colors_plantain_question17_no_weighted<- palette_plantain(length(levels_per_crop_Q17_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_17 <- list(
  Banana = levels_per_crop_Q17_no_weighted$Banana,
  Plantain = levels_per_crop_Q17_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_17 <- list(
  Banana = colors_banana_question17_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question17_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_17 <- assign_group_color(data = avg_dept_no_weight_17, levels_by_crop = levels_by_crop_no_weighted_17, colors_by_crop = colors_by_crop_no_weighted_17,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q17_weighted<- tapply(avg_dept_weight_17$ave_cat_weighted, avg_dept_weight_17$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question17_weighted<- palette_banana(length(levels_per_crop_Q17_weighted$Banana))
colors_plantain_question17_weighted<- palette_plantain(length(levels_per_crop_Q17_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_17 <- list(
  Banana = levels_per_crop_Q17_weighted$Banana,
  Plantain = levels_per_crop_Q17_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_17 <- list(
  Banana = colors_banana_question17_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question17_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_17 <- assign_group_color(data = avg_dept_weight_17, levels_by_crop = levels_by_crop_weighted_17, colors_by_crop = colors_by_crop_weighted_17,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_17, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_17, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q17_no_weight<- question_17 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =17))%>%
  rename(EKE.expert.in = expert_in)

nal_q17_no_weight<- full_join(codes_department, nal_q17_no_weight)
nal_q17_no_weight$cat<- factor(nal_q17_no_weight$cat, levels = level_17)
colmap(departamentos, data = nal_q17_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q17_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q17_weight<- inner_join(question_17, experience_of_each_expert)
nal_q17_weight<- nal_q17_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =17)) %>%
  rename(EKE.expert.in=expert_in)

nal_q17_weight<- full_join(codes_department, nal_q17_weight)
nal_q17_weight$cat_weighted<- factor(nal_q17_weight$cat_weighted, levels = level_17)
colmap(departamentos, data = nal_q17_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q17_weight$cat))-1), na.value = "#eeeeee")
```


## Question 18: `r unique(individual_surveys$question_in_english)[18]`

```{r question_18}
#selecting only question 18----
question_18<- filter(individual_surveys, question_number==18)
#unique(question_18$numeric_answer)
#dput(unique(question_18$answer_in_english))
#organizing the order of the levels
level_18<- c("0%", "1%-10%", "11%-20%", "21%-30%", "31%-40%", "41%-50%","51%-60%", "61%-70%", "71%-80%", "81%-90%", "91%-100%", "Not Sure")
question_18$answer_in_english<- factor(question_18$answer_in_english,levels = level_18)
question_18<- filter(question_18, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_18<- question_18 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(18, mean =average, language = "en"))
#weighted 
add_weights_question_18<- inner_join(question_18, experience_of_each_expert)
avg_dept_weight_18<- add_weights_question_18 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(18, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q18_no_weighted<- tapply(avg_dept_no_weight_18$ave_cat, avg_dept_no_weight_18$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question18_no_weighted<- palette_banana(length(levels_per_crop_Q18_no_weighted$Banana))
colors_plantain_question18_no_weighted<- palette_plantain(length(levels_per_crop_Q18_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_18 <- list(
  Banana = levels_per_crop_Q18_no_weighted$Banana,
  Plantain = levels_per_crop_Q18_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_18 <- list(
  Banana = colors_banana_question18_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question18_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_18 <- assign_group_color(data = avg_dept_no_weight_18, levels_by_crop = levels_by_crop_no_weighted_18, colors_by_crop = colors_by_crop_no_weighted_18,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q18_weighted<- tapply(avg_dept_weight_18$ave_cat_weighted, avg_dept_weight_18$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question18_weighted<- palette_banana(length(levels_per_crop_Q18_weighted$Banana))
colors_plantain_question18_weighted<- palette_plantain(length(levels_per_crop_Q18_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_18 <- list(
  Banana = levels_per_crop_Q18_weighted$Banana,
  Plantain = levels_per_crop_Q18_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_18 <- list(
  Banana = colors_banana_question18_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question18_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_18 <- assign_group_color(data = avg_dept_weight_18, levels_by_crop = levels_by_crop_weighted_18, colors_by_crop = colors_by_crop_weighted_18,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_18, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_18, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q18_no_weight<- question_18 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =18))%>%
  rename(EKE.expert.in = expert_in)

nal_q18_no_weight<- full_join(codes_department, nal_q18_no_weight)
nal_q18_no_weight$cat<- factor(nal_q18_no_weight$cat, levels = level_18)
colmap(departamentos, data = nal_q18_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q18_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q18_weight<- inner_join(question_18, experience_of_each_expert)
nal_q18_weight<- nal_q18_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =18)) %>%
  rename(EKE.expert.in=expert_in)

nal_q18_weight<- full_join(codes_department, nal_q18_weight)
nal_q18_weight$cat_weighted<- factor(nal_q18_weight$cat_weighted, levels = level_18)
colmap(departamentos, data = nal_q18_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q18_weight$cat))-1), na.value = "#eeeeee")
```


## Question 19: `r unique(individual_surveys$question_in_english)[19]`

```{r question_19}
#selecting only question 19----
question_19<- filter(individual_surveys, question_number==19)
#unique(question_19$numeric_answer)
#dput(unique(question_19$answer_in_english))
#organizing the order of the levels
level_19<- c("0%", "1%-10%", "11%-20%", "21%-30%", "31%-40%", "41%-50%","51%-60%", "61%-70%", "71%-80%", "81%-90%", "91%-100%", "Not Sure")
question_19$answer_in_english<- factor(question_19$answer_in_english,levels = level_19)
question_19<- filter(question_19, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_19<- question_19 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(19, mean =average, language = "en"))
#weighted 
add_weights_question_19<- inner_join(question_19, experience_of_each_expert)
avg_dept_weight_19<- add_weights_question_19 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(19, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q19_no_weighted<- tapply(avg_dept_no_weight_19$ave_cat, avg_dept_no_weight_19$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question19_no_weighted<- palette_banana(length(levels_per_crop_Q19_no_weighted$Banana))
colors_plantain_question19_no_weighted<- palette_plantain(length(levels_per_crop_Q19_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_19 <- list(
  Banana = levels_per_crop_Q19_no_weighted$Banana,
  Plantain = levels_per_crop_Q19_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_19 <- list(
  Banana = colors_banana_question19_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question19_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_19 <- assign_group_color(data = avg_dept_no_weight_19, levels_by_crop = levels_by_crop_no_weighted_19, colors_by_crop = colors_by_crop_no_weighted_19,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q19_weighted<- tapply(avg_dept_weight_19$ave_cat_weighted, avg_dept_weight_19$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question19_weighted<- palette_banana(length(levels_per_crop_Q19_weighted$Banana))
colors_plantain_question19_weighted<- palette_plantain(length(levels_per_crop_Q19_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_19 <- list(
  Banana = levels_per_crop_Q19_weighted$Banana,
  Plantain = levels_per_crop_Q19_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_19 <- list(
  Banana = colors_banana_question19_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question19_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_19 <- assign_group_color(data = avg_dept_weight_19, levels_by_crop = levels_by_crop_weighted_19, colors_by_crop = colors_by_crop_weighted_19,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_19, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_19, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q19_no_weight<- question_19 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =19))%>%
  rename(EKE.expert.in = expert_in)

nal_q19_no_weight<- full_join(codes_department, nal_q19_no_weight)
nal_q19_no_weight$cat<- factor(nal_q19_no_weight$cat, levels = level_19)
colmap(departamentos, data = nal_q19_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q19_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q19_weight<- inner_join(question_19, experience_of_each_expert)
nal_q19_weight<- nal_q19_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =19)) %>%
  rename(EKE.expert.in=expert_in)

nal_q19_weight<- full_join(codes_department, nal_q19_weight)
nal_q19_weight$cat_weighted<- factor(nal_q19_weight$cat_weighted, levels = level_19)
colmap(departamentos, data = nal_q19_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q19_weight$cat))-1), na.value = "#eeeeee")

```



## Question 20: `r unique(individual_surveys$question_in_english)[20]`

```{r question_20}
#selecting only question 20----
question_20<- filter(individual_surveys, question_number==20)
#unique(question_20$numeric_answer)
#dput(unique(question_20$answer_in_english))
#organizing the order of the levels
level_20<- c("0%", "1%-10%", "11%-20%", "21%-30%", "31%-40%", "41%-50%","51%-60%", "61%-70%", "71%-80%", "81%-90%", "91%-100%", "Not Sure")
question_20$answer_in_english<- factor(question_20$answer_in_english,levels = level_20)
question_20<- filter(question_20, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_20<- question_20 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(20, mean =average, language = "en"))
#weighted 
add_weights_question_20<- inner_join(question_20, experience_of_each_expert)
avg_dept_weight_20<- add_weights_question_20 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(20, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q20_no_weighted<- tapply(avg_dept_no_weight_20$ave_cat, avg_dept_no_weight_20$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question20_no_weighted<- palette_banana(length(levels_per_crop_Q20_no_weighted$Banana))
colors_plantain_question20_no_weighted<- palette_plantain(length(levels_per_crop_Q20_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_20 <- list(
  Banana = levels_per_crop_Q20_no_weighted$Banana,
  Plantain = levels_per_crop_Q20_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_20 <- list(
  Banana = colors_banana_question20_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question20_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_20 <- assign_group_color(data = avg_dept_no_weight_20, levels_by_crop = levels_by_crop_no_weighted_20, colors_by_crop = colors_by_crop_no_weighted_20,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q20_weighted<- tapply(avg_dept_weight_20$ave_cat_weighted, avg_dept_weight_20$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question20_weighted<- palette_banana(length(levels_per_crop_Q20_weighted$Banana))
colors_plantain_question20_weighted<- palette_plantain(length(levels_per_crop_Q20_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_20 <- list(
  Banana = levels_per_crop_Q20_weighted$Banana,
  Plantain = levels_per_crop_Q20_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_20 <- list(
  Banana = colors_banana_question20_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question20_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_20 <- assign_group_color(data = avg_dept_weight_20, levels_by_crop = levels_by_crop_weighted_20, colors_by_crop = colors_by_crop_weighted_20,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_20, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_20, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q20_no_weight<- question_20 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =20))%>%
  rename(EKE.expert.in = expert_in)

nal_q20_no_weight<- full_join(codes_department, nal_q20_no_weight)
nal_q20_no_weight$cat<- factor(nal_q20_no_weight$cat, levels = level_20)
colmap(departamentos, data = nal_q20_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q20_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q20_weight<- inner_join(question_20, experience_of_each_expert)
nal_q20_weight<- nal_q20_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =20)) %>%
  rename(EKE.expert.in=expert_in)

nal_q20_weight<- full_join(codes_department, nal_q20_weight)
nal_q20_weight$cat_weighted<- factor(nal_q20_weight$cat_weighted, levels = level_20)
colmap(departamentos, data = nal_q20_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q20_weight$cat))-1), na.value = "#eeeeee")
```



## Question 21: `r unique(individual_surveys$question_in_english)[21]`

```{r question_21}
#selecting only question 21----
question_21<- filter(individual_surveys, question_number==21)
#unique(question_21$numeric_answer)
#dput(unique(question_21$answer_in_english))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_21 <- question_21 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "Daily,Weekly,Biweekly,Monthly,Quarterly,As Needed" ~ "As Needed",
    answer_in_english == "Bimonthly,Quarterly" ~ "Quarterly",
    answer_in_english == "Biweekly,Monthly" ~ "Monthly",
    answer_in_english == "Weekly,Biweekly" ~ "Biweekly",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_21 <- question_21 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "1,2,3,4,6,9" ~ "9",
    numeric_answer == "5,6" ~ "5.5",
    numeric_answer == "3,4" ~ "3.5",
    numeric_answer == "2,3" ~ "2.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
level_21<- c("Daily", "Weekly", "Biweekly", "Monthly", "Bimonthly", "Quarterly", "Semiannually", "Annually", "As Needed", "Unsupervised", "Not Sure")
question_21$answer_in_english<- factor(question_21$answer_in_english,levels = level_21)
question_21<- filter(question_21, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_21<- question_21 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(21, mean =average, language = "en"))
#weighted 
add_weights_question_21<- inner_join(question_21, experience_of_each_expert)
avg_dept_weight_21<- add_weights_question_21 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(21, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q21_no_weighted<- tapply(avg_dept_no_weight_21$ave_cat, avg_dept_no_weight_21$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question21_no_weighted<- palette_banana(length(levels_per_crop_Q21_no_weighted$Banana))
colors_plantain_question21_no_weighted<- palette_plantain(length(levels_per_crop_Q21_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_21 <- list(
  Banana = levels_per_crop_Q21_no_weighted$Banana,
  Plantain = levels_per_crop_Q21_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_21 <- list(
  Banana = colors_banana_question21_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question21_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_21 <- assign_group_color(data = avg_dept_no_weight_21, levels_by_crop = levels_by_crop_no_weighted_21, colors_by_crop = colors_by_crop_no_weighted_21,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q21_weighted<- tapply(avg_dept_weight_21$ave_cat_weighted, avg_dept_weight_21$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question21_weighted<- palette_banana(length(levels_per_crop_Q21_weighted$Banana))
colors_plantain_question21_weighted<- palette_plantain(length(levels_per_crop_Q21_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_21 <- list(
  Banana = levels_per_crop_Q21_weighted$Banana,
  Plantain = levels_per_crop_Q21_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_21 <- list(
  Banana = colors_banana_question21_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question21_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_21 <- assign_group_color(data = avg_dept_weight_21, levels_by_crop = levels_by_crop_weighted_21, colors_by_crop = colors_by_crop_weighted_21,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_21, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_21, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q21_no_weight<- question_21 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =21))%>%
  rename(EKE.expert.in = expert_in)

nal_q21_no_weight<- full_join(codes_department, nal_q21_no_weight)
nal_q21_no_weight$cat<- factor(nal_q21_no_weight$cat, levels = level_21)
colmap(departamentos, data = nal_q21_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q21_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q21_weight<- inner_join(question_21, experience_of_each_expert)
nal_q21_weight<- nal_q21_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =21)) %>%
  rename(EKE.expert.in=expert_in)

nal_q21_weight<- full_join(codes_department, nal_q21_weight)
nal_q21_weight$cat_weighted<- factor(nal_q21_weight$cat_weighted, levels = level_21)
colmap(departamentos, data = nal_q21_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q21_weight$cat))-1), na.value = "#eeeeee")
```


## Question 22: `r unique(individual_surveys$question_in_english)[22]`

```{r question_22}
#selecting only question 22----
question_22<- filter(individual_surveys, question_number==22)
#unique(question_22$numeric_answer)
#dput(unique(question_22$answer_in_english))

#organizing the order of the levels
level_22<- c("Slightly Effective", "Moderately Effective", "Very Effective","Extremely Effective", "Unsure")
question_22$answer_in_english<- factor(question_22$answer_in_english,levels = level_22)
question_22<- filter(question_22, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_22<- question_22 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(22, mean =average, language = "en"))
#weighted 
add_weights_question_22<- inner_join(question_22, experience_of_each_expert)
avg_dept_weight_22<- add_weights_question_22 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(22, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q22_no_weighted<- tapply(avg_dept_no_weight_22$ave_cat, avg_dept_no_weight_22$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question22_no_weighted<- palette_banana(length(levels_per_crop_Q22_no_weighted$Banana))
colors_plantain_question22_no_weighted<- palette_plantain(length(levels_per_crop_Q22_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_22 <- list(
  Banana = levels_per_crop_Q22_no_weighted$Banana,
  Plantain = levels_per_crop_Q22_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_22 <- list(
  Banana = colors_banana_question22_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question22_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_22 <- assign_group_color(data = avg_dept_no_weight_22, levels_by_crop = levels_by_crop_no_weighted_22, colors_by_crop = colors_by_crop_no_weighted_22,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q22_weighted<- tapply(avg_dept_weight_22$ave_cat_weighted, avg_dept_weight_22$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question22_weighted<- palette_banana(length(levels_per_crop_Q22_weighted$Banana))
colors_plantain_question22_weighted<- palette_plantain(length(levels_per_crop_Q22_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_22 <- list(
  Banana = levels_per_crop_Q22_weighted$Banana,
  Plantain = levels_per_crop_Q22_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_22 <- list(
  Banana = colors_banana_question22_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question22_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_22 <- assign_group_color(data = avg_dept_weight_22, levels_by_crop = levels_by_crop_weighted_22, colors_by_crop = colors_by_crop_weighted_22,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_22, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_22, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q22_no_weight<- question_22 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =22))%>%
  rename(EKE.expert.in = expert_in)

nal_q22_no_weight<- full_join(codes_department, nal_q22_no_weight)
nal_q22_no_weight$cat<- factor(nal_q22_no_weight$cat, levels = level_22)
colmap(departamentos, data = nal_q22_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q22_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q22_weight<- inner_join(question_22, experience_of_each_expert)
nal_q22_weight<- nal_q22_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =22)) %>%
  rename(EKE.expert.in=expert_in)

nal_q22_weight<- full_join(codes_department, nal_q22_weight)
nal_q22_weight$cat_weighted<- factor(nal_q22_weight$cat_weighted, levels = level_22)
colmap(departamentos, data = nal_q22_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q22_weight$cat))-1), na.value = "#eeeeee")

```


## Question 23: `r unique(individual_surveys$question_in_english)[23]`

```{r question_23}
#selecting only question 23----
question_23<- filter(individual_surveys, question_number==23)
#unique(question_23$numeric_answer)
#dput(unique(question_23$answer_in_english))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_23 <- question_23 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "Extremely Effective,Unsure" ~ "Unsure",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_23 <- question_23 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "5,6" ~ "6",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
level_23<- c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective","Extremely Effective", "Unsure")
question_23$answer_in_english<- factor(question_23$answer_in_english,levels = level_23)
question_23<- filter(question_23, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_23<- question_23 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(23, mean =average, language = "en"))
#weighted 
add_weights_question_23<- inner_join(question_23, experience_of_each_expert)
avg_dept_weight_23<- add_weights_question_23 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(23, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q23_no_weighted<- tapply(avg_dept_no_weight_23$ave_cat, avg_dept_no_weight_23$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question23_no_weighted<- palette_banana(length(levels_per_crop_Q23_no_weighted$Banana))
colors_plantain_question23_no_weighted<- palette_plantain(length(levels_per_crop_Q23_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_23 <- list(
  Banana = levels_per_crop_Q23_no_weighted$Banana,
  Plantain = levels_per_crop_Q23_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_23 <- list(
  Banana = colors_banana_question23_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question23_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_23 <- assign_group_color(data = avg_dept_no_weight_23, levels_by_crop = levels_by_crop_no_weighted_23, colors_by_crop = colors_by_crop_no_weighted_23,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q23_weighted<- tapply(avg_dept_weight_23$ave_cat_weighted, avg_dept_weight_23$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question23_weighted<- palette_banana(length(levels_per_crop_Q23_weighted$Banana))
colors_plantain_question23_weighted<- palette_plantain(length(levels_per_crop_Q23_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_23 <- list(
  Banana = levels_per_crop_Q23_weighted$Banana,
  Plantain = levels_per_crop_Q23_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_23 <- list(
  Banana = colors_banana_question23_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question23_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_23 <- assign_group_color(data = avg_dept_weight_23, levels_by_crop = levels_by_crop_weighted_23, colors_by_crop = colors_by_crop_weighted_23,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_23, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_23, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q23_no_weight<- question_23 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =23))%>%
  rename(EKE.expert.in = expert_in)

nal_q23_no_weight<- full_join(codes_department, nal_q23_no_weight)
nal_q23_no_weight$cat<- factor(nal_q23_no_weight$cat, levels = level_23)
colmap(departamentos, data = nal_q23_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q23_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q23_weight<- inner_join(question_23, experience_of_each_expert)
nal_q23_weight<- nal_q23_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =23)) %>%
  rename(EKE.expert.in=expert_in)

nal_q23_weight<- full_join(codes_department, nal_q23_weight)
nal_q23_weight$cat_weighted<- factor(nal_q23_weight$cat_weighted, levels = level_23)
colmap(departamentos, data = nal_q23_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q23_weight$cat))-1), na.value = "#eeeeee")

```


## Question 24: `r unique(individual_surveys$question_in_english)[24]`


```{r question_24}
#selecting only question 24----
question_24<- filter(individual_surveys, question_number==24)
#unique(question_24$numeric_answer)
#dput(unique(question_24$answer_in_english))
#organizing the order of the levels
level_24<- c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective","Extremely Effective", "Unsure")
question_24$answer_in_english<- factor(question_24$answer_in_english,levels = level_24)
question_24<- filter(question_24, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_24<- question_24 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(24, mean =average, language = "en"))
#weighted 
add_weights_question_24<- inner_join(question_24, experience_of_each_expert)
avg_dept_weight_24<- add_weights_question_24 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(24, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q24_no_weighted<- tapply(avg_dept_no_weight_24$ave_cat, avg_dept_no_weight_24$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question24_no_weighted<- palette_banana(length(levels_per_crop_Q24_no_weighted$Banana))
colors_plantain_question24_no_weighted<- palette_plantain(length(levels_per_crop_Q24_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_24 <- list(
  Banana = levels_per_crop_Q24_no_weighted$Banana,
  Plantain = levels_per_crop_Q24_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_24 <- list(
  Banana = colors_banana_question24_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question24_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_24 <- assign_group_color(data = avg_dept_no_weight_24, levels_by_crop = levels_by_crop_no_weighted_24, colors_by_crop = colors_by_crop_no_weighted_24,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q24_weighted<- tapply(avg_dept_weight_24$ave_cat_weighted, avg_dept_weight_24$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question24_weighted<- palette_banana(length(levels_per_crop_Q24_weighted$Banana))
colors_plantain_question24_weighted<- palette_plantain(length(levels_per_crop_Q24_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_24 <- list(
  Banana = levels_per_crop_Q24_weighted$Banana,
  Plantain = levels_per_crop_Q24_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_24 <- list(
  Banana = colors_banana_question24_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question24_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_24 <- assign_group_color(data = avg_dept_weight_24, levels_by_crop = levels_by_crop_weighted_24, colors_by_crop = colors_by_crop_weighted_24,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_24, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_24, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q24_no_weight<- question_24 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =24))%>%
  rename(EKE.expert.in = expert_in)

nal_q24_no_weight<- full_join(codes_department, nal_q24_no_weight)
nal_q24_no_weight$cat<- factor(nal_q24_no_weight$cat, levels = level_24)
colmap(departamentos, data = nal_q24_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q24_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q24_weight<- inner_join(question_24, experience_of_each_expert)
nal_q24_weight<- nal_q24_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =24)) %>%
  rename(EKE.expert.in=expert_in)

nal_q24_weight<- full_join(codes_department, nal_q24_weight)
nal_q24_weight$cat_weighted<- factor(nal_q24_weight$cat_weighted, levels = level_24)
colmap(departamentos, data = nal_q24_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q24_weight$cat))-1), na.value = "#eeeeee")
```

## Question 25: `r unique(individual_surveys$question_in_english)[25]`


```{r question_25}
#selecting only question 25----
question_25<- filter(individual_surveys, question_number==25)
#unique(question_25$numeric_answer)
#dput(unique(question_25$answer_in_english))
#organizing the order of the levels
level_25<- c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective","Extremely Effective", "Unsure")
question_25$answer_in_english<- factor(question_25$answer_in_english,levels = level_25)
question_25<- filter(question_25, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_25<- question_25 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(25, mean =average, language = "en"))
#weighted 
add_weights_question_25<- inner_join(question_25, experience_of_each_expert)
avg_dept_weight_25<- add_weights_question_25 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(25, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q25_no_weighted<- tapply(avg_dept_no_weight_25$ave_cat, avg_dept_no_weight_25$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question25_no_weighted<- palette_banana(length(levels_per_crop_Q25_no_weighted$Banana))
colors_plantain_question25_no_weighted<- palette_plantain(length(levels_per_crop_Q25_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_25 <- list(
  Banana = levels_per_crop_Q25_no_weighted$Banana,
  Plantain = levels_per_crop_Q25_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_25 <- list(
  Banana = colors_banana_question25_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question25_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_25 <- assign_group_color(data = avg_dept_no_weight_25, levels_by_crop = levels_by_crop_no_weighted_25, colors_by_crop = colors_by_crop_no_weighted_25,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q25_weighted<- tapply(avg_dept_weight_25$ave_cat_weighted, avg_dept_weight_25$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question25_weighted<- palette_banana(length(levels_per_crop_Q25_weighted$Banana))
colors_plantain_question25_weighted<- palette_plantain(length(levels_per_crop_Q25_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_25 <- list(
  Banana = levels_per_crop_Q25_weighted$Banana,
  Plantain = levels_per_crop_Q25_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_25 <- list(
  Banana = colors_banana_question25_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question25_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_25 <- assign_group_color(data = avg_dept_weight_25, levels_by_crop = levels_by_crop_weighted_25, colors_by_crop = colors_by_crop_weighted_25,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_25, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_25, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q25_no_weight<- question_25 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =25))%>%
  rename(EKE.expert.in = expert_in)

nal_q25_no_weight<- full_join(codes_department, nal_q25_no_weight)
nal_q25_no_weight$cat<- factor(nal_q25_no_weight$cat, levels = level_25)
colmap(departamentos, data = nal_q25_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q25_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q25_weight<- inner_join(question_25, experience_of_each_expert)
nal_q25_weight<- nal_q25_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =25)) %>%
  rename(EKE.expert.in=expert_in)

nal_q25_weight<- full_join(codes_department, nal_q25_weight)
nal_q25_weight$cat_weighted<- factor(nal_q25_weight$cat_weighted, levels = level_25)
colmap(departamentos, data = nal_q25_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q25_weight$cat))-1), na.value = "#eeeeee")

```

## Question 26: `r unique(individual_surveys$question_in_english)[26]`

```{r question_26}
#selecting only question 26----
question_26<- filter(individual_surveys, question_number==26)
#unique(question_26$numeric_answer)
#dput(unique(question_26$answer_in_english))
#organizing the order of the levels
level_26<- c("Not Effective", "Slightly Effective", "Moderately Effective", "Very Effective","Extremely Effective", "Unsure")
question_26$answer_in_english<- factor(question_26$answer_in_english,levels = level_26)
question_26<- filter(question_26, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_26<- question_26 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(26, mean =average, language = "en"))
#weighted 
add_weights_question_26<- inner_join(question_26, experience_of_each_expert)
avg_dept_weight_26<- add_weights_question_26 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(26, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q26_no_weighted<- tapply(avg_dept_no_weight_26$ave_cat, avg_dept_no_weight_26$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question26_no_weighted<- palette_banana(length(levels_per_crop_Q26_no_weighted$Banana))
colors_plantain_question26_no_weighted<- palette_plantain(length(levels_per_crop_Q26_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_26 <- list(
  Banana = levels_per_crop_Q26_no_weighted$Banana,
  Plantain = levels_per_crop_Q26_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_26 <- list(
  Banana = colors_banana_question26_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question26_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_26 <- assign_group_color(data = avg_dept_no_weight_26, levels_by_crop = levels_by_crop_no_weighted_26, colors_by_crop = colors_by_crop_no_weighted_26,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q26_weighted<- tapply(avg_dept_weight_26$ave_cat_weighted, avg_dept_weight_26$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question26_weighted<- palette_banana(length(levels_per_crop_Q26_weighted$Banana))
colors_plantain_question26_weighted<- palette_plantain(length(levels_per_crop_Q26_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_26 <- list(
  Banana = levels_per_crop_Q26_weighted$Banana,
  Plantain = levels_per_crop_Q26_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_26 <- list(
  Banana = colors_banana_question26_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question26_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_26 <- assign_group_color(data = avg_dept_weight_26, levels_by_crop = levels_by_crop_weighted_26, colors_by_crop = colors_by_crop_weighted_26,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_26, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_26, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q26_no_weight<- question_26 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =26))%>%
  rename(EKE.expert.in = expert_in)

nal_q26_no_weight<- full_join(codes_department, nal_q26_no_weight)
nal_q26_no_weight$cat<- factor(nal_q26_no_weight$cat, levels = level_26)
colmap(departamentos, data = nal_q26_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q26_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q26_weight<- inner_join(question_26, experience_of_each_expert)
nal_q26_weight<- nal_q26_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =26)) %>%
  rename(EKE.expert.in=expert_in)

nal_q26_weight<- full_join(codes_department, nal_q26_weight)
nal_q26_weight$cat_weighted<- factor(nal_q26_weight$cat_weighted, levels = level_26)
colmap(departamentos, data = nal_q26_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q26_weight$cat))-1), na.value = "#eeeeee")
```

## Question 27: `r unique(individual_surveys$question_in_english)[27]`


```{r question_27}
#selecting only question 27----
question_27<- filter(individual_surveys, question_number==27)
#dput(unique(question_27$answer_in_english))
question_27<- filter(question_27, answer_in_english!="Unsure")
question_27_Frequencies_non_weighted<- count_elements_by_group(question_27, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q27_no_weighted<- tapply(question_27_Frequencies_non_weighted$answer_in_english, question_27_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question27_no_weighted<- palette_banana(length(levels_per_crop_Q27_no_weighted$Banana))
colors_plantain_question27_no_weighted<- palette_plantain(length(levels_per_crop_Q27_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_27 <- list(
  Banana = levels_per_crop_Q27_no_weighted$Banana,
  Plantain = levels_per_crop_Q27_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_27 <- list(
  Banana = colors_banana_question27_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question27_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_27 <- assign_group_color(data = question_27_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_27, colors_by_crop = colors_by_crop_no_weighted_27,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_27 <- avg_no_weight_27 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Access to Quality Planting Material" ~ "AQPM",
    answer_in_english == "Access to Training and Extension Services" ~ "ATES",
    answer_in_english == "Availability of Infrastructure and Equipment" ~ "AIE",
    answer_in_english == "Availability of Labor" ~ "AOL",
    answer_in_english == "Environmental Conditions" ~ "EC",
    answer_in_english == "Financial Resources" ~ "FR",
    answer_in_english == "Government Policies and Regulations" ~ "GPR",
    answer_in_english == "Impacts of Climate Change" ~ "ICC",
    answer_in_english == "Market Access" ~ "MA",
    answer_in_english == "Pest and Disease Pressure" ~ "PDP",
    answer_in_english == "Social Acceptance/Community Support" ~ "SACS",
    answer_in_english == "Technical Knowledge" ~ "TK",
   
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_27_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_27$crop,
                                    h3= avg_no_weight_27$answer_in_english,
                                    color= avg_no_weight_27$group_color,
                                    weight= avg_no_weight_27$n,
                                    codes= avg_no_weight_27$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_27_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_27_weihted<- inner_join(question_27, experience_of_each_expert)
rep_question_27_weighted<- question_27_weihted %>%
  slice(rep(1:n(), question_27_weihted$weights))
question_27_Frequencies_weighted<- count_elements_by_group(rep_question_27_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_27 <- assign_group_color(data = question_27_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_27, colors_by_crop = colors_by_crop_no_weighted_27,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_27 <- avg_weight_27 %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Access to Quality Planting Material" ~ "AQPM",
      answer_in_english == "Access to Training and Extension Services" ~ "ATES",
      answer_in_english == "Availability of Infrastructure and Equipment" ~ "AIE",
      answer_in_english == "Availability of Labor" ~ "AOL",
      answer_in_english == "Environmental Conditions" ~ "EC",
      answer_in_english == "Financial Resources" ~ "FR",
      answer_in_english == "Government Policies and Regulations" ~ "GPR",
      answer_in_english == "Impacts of Climate Change" ~ "ICC",
      answer_in_english == "Market Access" ~ "MA",
      answer_in_english == "Pest and Disease Pressure" ~ "PDP",
      answer_in_english == "Social Acceptance/Community Support" ~ "SACS",
      answer_in_english == "Technical Knowledge" ~ "TK",
     
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
avg_weight_27_plot<- data.frame(h1= "total",
                                   h2= avg_weight_27$crop,
                                   h3= avg_weight_27$answer_in_english,
                                   color= avg_weight_27$group_color,
                                   weight= avg_weight_27$n,
                                   codes= avg_weight_27$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_27_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "weighted")
#Frequencies by department
question_27_frequencies_by_depto <- count_elements_by_group(question_27, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_27_frequencies_by_depto <- assign_group_color(data = question_27_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_27, colors_by_crop = colors_by_crop_no_weighted_27,answer_col =  "answer_in_english")
#Make the abbreviations
question_27_frequencies_by_depto <- question_27_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Access to Quality Planting Material" ~ "AQPM",
    answer_in_english == "Access to Training and Extension Services" ~ "ATES",
    answer_in_english == "Availability of Infrastructure and Equipment" ~ "AIE",
    answer_in_english == "Availability of Labor" ~ "AOL",
    answer_in_english == "Environmental Conditions" ~ "EC",
    answer_in_english == "Financial Resources" ~ "FR",
    answer_in_english == "Government Policies and Regulations" ~ "GPR",
    answer_in_english == "Impacts of Climate Change" ~ "ICC",
    answer_in_english == "Market Access" ~ "MA",
    answer_in_english == "Pest and Disease Pressure" ~ "PDP",
    answer_in_english == "Social Acceptance/Community Support" ~ "SACS",
    answer_in_english == "Technical Knowledge" ~ "TK",
   
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_27_frequencies_by_depto<- select(question_27_frequencies_by_depto,!answer_in_english)
question_27_frequencies_by_depto<- question_27_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_27_frequencies_by_depto<- select(question_27_frequencies_by_depto,!n & !total)
#put it in long format
question_27_frequencies_by_depto <- question_27_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_27_frequencies_by_depto_banana<- filter(question_27_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_27_plot$codes[which(avg_no_weight_27_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_27_frequencies_by_depto_plantain<- filter(question_27_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_27_plot$codes[which(avg_no_weight_27_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_27_frequencies_by_depto<- rbind(question_27_frequencies_by_depto_banana, question_27_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_27_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_27_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_27_frequencies_by_depto_wei <- count_elements_by_group(rep_question_27_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_27_frequencies_by_depto_wei <- assign_group_color(data = question_27_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_27, colors_by_crop = colors_by_crop_no_weighted_27,answer_col =  "answer_in_english")
#Make the abbreviations
question_27_frequencies_by_depto_wei <- question_27_frequencies_by_depto_wei %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Access to Quality Planting Material" ~ "AQPM",
      answer_in_english == "Access to Training and Extension Services" ~ "ATES",
      answer_in_english == "Availability of Infrastructure and Equipment" ~ "AIE",
      answer_in_english == "Availability of Labor" ~ "AOL",
      answer_in_english == "Environmental Conditions" ~ "EC",
      answer_in_english == "Financial Resources" ~ "FR",
      answer_in_english == "Government Policies and Regulations" ~ "GPR",
      answer_in_english == "Impacts of Climate Change" ~ "ICC",
      answer_in_english == "Market Access" ~ "MA",
      answer_in_english == "Pest and Disease Pressure" ~ "PDP",
      answer_in_english == "Social Acceptance/Community Support" ~ "SACS",
      answer_in_english == "Technical Knowledge" ~ "TK",
     
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#tree map
question_27_frequencies_by_depto_wei<- select(question_27_frequencies_by_depto_wei,!answer_in_english)
question_27_frequencies_by_depto_wei<- question_27_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_27_frequencies_by_depto_wei<- select(question_27_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_27_frequencies_by_depto_wei <- question_27_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_27_frequencies_by_depto_banana_wei<- filter(question_27_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_27_plot$codes[which(avg_no_weight_27_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_27_frequencies_by_depto_plantain_wei<- filter(question_27_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_27_plot$codes[which(avg_no_weight_27_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_27_frequencies_by_depto_wei<- rbind(question_27_frequencies_by_depto_banana_wei, question_27_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_27_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_27_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 27 diseases and pest in Colombia
q27_top_27Colobia<- count_elements_by_group(question_27, "answer_in_english", c("answer_in_english"))
q27_top_27Colobia$mean<-round((q27_top_27Colobia$n/sum(q27_top_27Colobia$n)*100),0)
q27_top_27Colobia$background_color<- "white"
q27_top_27Colobia$color<- palette_soil(length(unique(q27_top_27Colobia$answer_in_english)))
#Make the abbreviations
q27_top_27Colobia <- q27_top_27Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Access to Quality Planting Material" ~ "AQPM",
      answer_in_english == "Access to Training and Extension Services" ~ "ATES",
      answer_in_english == "Availability of Infrastructure and Equipment" ~ "AIE",
      answer_in_english == "Availability of Labor" ~ "AOL",
      answer_in_english == "Environmental Conditions" ~ "EC",
      answer_in_english == "Financial Resources" ~ "FR",
      answer_in_english == "Government Policies and Regulations" ~ "GPR",
      answer_in_english == "Impacts of Climate Change" ~ "ICC",
      answer_in_english == "Market Access" ~ "MA",
      answer_in_english == "Pest and Disease Pressure" ~ "PDP",
      answer_in_english == "Social Acceptance/Community Support" ~ "SACS",
      answer_in_english == "Technical Knowledge" ~ "TK",
     
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q27_top_27Colobia <- q27_top_27Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q27_top_27Colobia$cat_abbreviations<- factor(q27_top_27Colobia$cat_abbreviations, levels = q27_top_27Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q27_top_27Colobia,x_lab = "Limiting Factors", y_lab ="Proportion of Experts (%)", title = "
Factors that Hinder the Implementation of Management Practices -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 27 diseases and pest in Colombia -WEIGHTED
q_27_weighted_top_27Colobia<- count_elements_by_group(rep_question_27_weighted, "answer_in_english", c("answer_in_english"))
q_27_weighted_top_27Colobia$mean<-round((q_27_weighted_top_27Colobia$n/sum(q_27_weighted_top_27Colobia$n)*100),0)
q_27_weighted_top_27Colobia$background_color<- "white"
q_27_weighted_top_27Colobia$color<- palette_soil(length(unique(q_27_weighted_top_27Colobia$answer_in_english)))
#Make the abbreviations
q_27_weighted_top_27Colobia <- q_27_weighted_top_27Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Access to Quality Planting Material" ~ "AQPM",
      answer_in_english == "Access to Training and Extension Services" ~ "ATES",
      answer_in_english == "Availability of Infrastructure and Equipment" ~ "AIE",
      answer_in_english == "Availability of Labor" ~ "AOL",
      answer_in_english == "Environmental Conditions" ~ "EC",
      answer_in_english == "Financial Resources" ~ "FR",
      answer_in_english == "Government Policies and Regulations" ~ "GPR",
      answer_in_english == "Impacts of Climate Change" ~ "ICC",
      answer_in_english == "Market Access" ~ "MA",
      answer_in_english == "Pest and Disease Pressure" ~ "PDP",
      answer_in_english == "Social Acceptance/Community Support" ~ "SACS",
      answer_in_english == "Technical Knowledge" ~ "TK",
     
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q_27_weighted_top_27Colobia <- q_27_weighted_top_27Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_27_weighted_top_27Colobia$cat_abbreviations<- factor(q_27_weighted_top_27Colobia$cat_abbreviations, levels = q_27_weighted_top_27Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_27_weighted_top_27Colobia,x_lab = "Limiting Factors", y_lab ="Proportion of Experts (%)", title = "
Factors that Hinder the Implementation of Management Practices -  W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```

## Question 28: `r unique(individual_surveys$question_in_english)[28]`


```{r question_28}
#selecting only question 28----
question_28<- filter(individual_surveys, question_number==28)
#unique(question_28$numeric_answer)
#dput(unique(question_28$answer_in_english))

#organizing the order of the levels
level_28<- c("Not Significant", "Somewhat Significant", "Very Significant","Not Sure")
question_28$answer_in_english<- factor(question_28$answer_in_english,levels = level_28)
question_28<- filter(question_28, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_28<- question_28 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(28, mean =average, language = "en"))
#weighted 
add_weights_question_28<- inner_join(question_28, experience_of_each_expert)
avg_dept_weight_28<- add_weights_question_28 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(28, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q28_no_weighted<- tapply(avg_dept_no_weight_28$ave_cat, avg_dept_no_weight_28$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question28_no_weighted<- palette_banana(length(levels_per_crop_Q28_no_weighted$Banana))
colors_plantain_question28_no_weighted<- palette_plantain(length(levels_per_crop_Q28_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_28 <- list(
  Banana = levels_per_crop_Q28_no_weighted$Banana,
  Plantain = levels_per_crop_Q28_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_28 <- list(
  Banana = colors_banana_question28_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question28_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_28 <- assign_group_color(data = avg_dept_no_weight_28, levels_by_crop = levels_by_crop_no_weighted_28, colors_by_crop = colors_by_crop_no_weighted_28,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q28_weighted<- tapply(avg_dept_weight_28$ave_cat_weighted, avg_dept_weight_28$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question28_weighted<- palette_banana(length(levels_per_crop_Q28_weighted$Banana))
colors_plantain_question28_weighted<- palette_plantain(length(levels_per_crop_Q28_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_28 <- list(
  Banana = levels_per_crop_Q28_weighted$Banana,
  Plantain = levels_per_crop_Q28_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_28 <- list(
  Banana = colors_banana_question28_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question28_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_28 <- assign_group_color(data = avg_dept_weight_28, levels_by_crop = levels_by_crop_weighted_28, colors_by_crop = colors_by_crop_weighted_28,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_28, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_28, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q28_no_weight<- question_28 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =28))%>%
  rename(EKE.expert.in = expert_in)

nal_q28_no_weight<- full_join(codes_department, nal_q28_no_weight)
nal_q28_no_weight$cat<- factor(nal_q28_no_weight$cat, levels = level_28)
colmap(departamentos, data = nal_q28_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q28_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q28_weight<- inner_join(question_28, experience_of_each_expert)
nal_q28_weight<- nal_q28_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =28)) %>%
  rename(EKE.expert.in=expert_in)

nal_q28_weight<- full_join(codes_department, nal_q28_weight)
nal_q28_weight$cat_weighted<- factor(nal_q28_weight$cat_weighted, levels = level_28)
colmap(departamentos, data = nal_q28_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q28_weight$cat))-1), na.value = "#eeeeee")
```


## Question 29: `r unique(individual_surveys$question_in_english)[29]`

```{r question_29}
#selecting only question 29----
question_29<- filter(individual_surveys, question_number==29)
#unique(question_29$numeric_answer)
#dput(unique(question_29$answer_in_english))

#organizing the order of the levels
level_29<- c("No Measures", "Some Measures", "Significant Measures","Not Sure")
question_29$answer_in_english<- factor(question_29$answer_in_english,levels = level_29)
question_29<- filter(question_29, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_29<- question_29 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(29, mean =average, language = "en"))
#weighted 
add_weights_question_29<- inner_join(question_29, experience_of_each_expert)
avg_dept_weight_29<- add_weights_question_29 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(29, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q29_no_weighted<- tapply(avg_dept_no_weight_29$ave_cat, avg_dept_no_weight_29$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question29_no_weighted<- palette_banana(length(levels_per_crop_Q29_no_weighted$Banana))
colors_plantain_question29_no_weighted<- palette_plantain(length(levels_per_crop_Q29_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_29 <- list(
  Banana = levels_per_crop_Q29_no_weighted$Banana,
  Plantain = levels_per_crop_Q29_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_29 <- list(
  Banana = colors_banana_question29_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question29_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_29 <- assign_group_color(data = avg_dept_no_weight_29, levels_by_crop = levels_by_crop_no_weighted_29, colors_by_crop = colors_by_crop_no_weighted_29,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q29_weighted<- tapply(avg_dept_weight_29$ave_cat_weighted, avg_dept_weight_29$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question29_weighted<- palette_banana(length(levels_per_crop_Q29_weighted$Banana))
colors_plantain_question29_weighted<- palette_plantain(length(levels_per_crop_Q29_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_29 <- list(
  Banana = levels_per_crop_Q29_weighted$Banana,
  Plantain = levels_per_crop_Q29_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_29 <- list(
  Banana = colors_banana_question29_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question29_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_29 <- assign_group_color(data = avg_dept_weight_29, levels_by_crop = levels_by_crop_weighted_29, colors_by_crop = colors_by_crop_weighted_29,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_29, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_29, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q29_no_weight<- question_29 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =29))%>%
  rename(EKE.expert.in = expert_in)

nal_q29_no_weight<- full_join(codes_department, nal_q29_no_weight)
nal_q29_no_weight$cat<- factor(nal_q29_no_weight$cat, levels = level_29)
colmap(departamentos, data = nal_q29_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q29_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q29_weight<- inner_join(question_29, experience_of_each_expert)
nal_q29_weight<- nal_q29_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =29)) %>%
  rename(EKE.expert.in=expert_in)

nal_q29_weight<- full_join(codes_department, nal_q29_weight)
nal_q29_weight$cat_weighted<- factor(nal_q29_weight$cat_weighted, levels = level_29)
colmap(departamentos, data = nal_q29_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q29_weight$cat))-1), na.value = "#eeeeee")
```


## Question 30: `r unique(individual_surveys$question_in_english)[30]`

```{r question_30}
#selecting only question 30----
question_30<- filter(individual_surveys, question_number==30)
#unique(question_30$numeric_answer)
#dput(unique(question_30$answer_in_english))

#organizing the order of the levels
level_30<- c("No Limitation", "Little Limitation",  "Moderate Limitation", "Extreme Limitation", "Unsure")
question_30$answer_in_english<- factor(question_30$answer_in_english,levels = level_30)
question_30<- filter(question_30, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_30<- question_30 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(30, mean =average, language = "en"))
#weighted 
add_weights_question_30<- inner_join(question_30, experience_of_each_expert)
avg_dept_weight_30<- add_weights_question_30 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(30, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q30_no_weighted<- tapply(avg_dept_no_weight_30$ave_cat, avg_dept_no_weight_30$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question30_no_weighted<- palette_banana(length(levels_per_crop_Q30_no_weighted$Banana))
colors_plantain_question30_no_weighted<- palette_plantain(length(levels_per_crop_Q30_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_30 <- list(
  Banana = levels_per_crop_Q30_no_weighted$Banana,
  Plantain = levels_per_crop_Q30_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_30 <- list(
  Banana = colors_banana_question30_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question30_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_30 <- assign_group_color(data = avg_dept_no_weight_30, levels_by_crop = levels_by_crop_no_weighted_30, colors_by_crop = colors_by_crop_no_weighted_30,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q30_weighted<- tapply(avg_dept_weight_30$ave_cat_weighted, avg_dept_weight_30$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question30_weighted<- palette_banana(length(levels_per_crop_Q30_weighted$Banana))
colors_plantain_question30_weighted<- palette_plantain(length(levels_per_crop_Q30_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_30 <- list(
  Banana = levels_per_crop_Q30_weighted$Banana,
  Plantain = levels_per_crop_Q30_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_30 <- list(
  Banana = colors_banana_question30_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question30_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_30 <- assign_group_color(data = avg_dept_weight_30, levels_by_crop = levels_by_crop_weighted_30, colors_by_crop = colors_by_crop_weighted_30,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_30, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_30, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q30_no_weight<- question_30 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =30))%>%
  rename(EKE.expert.in = expert_in)

nal_q30_no_weight<- full_join(codes_department, nal_q30_no_weight)
nal_q30_no_weight$cat<- factor(nal_q30_no_weight$cat, levels = level_30)
colmap(departamentos, data = nal_q30_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q30_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q30_weight<- inner_join(question_30, experience_of_each_expert)
nal_q30_weight<- nal_q30_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =30)) %>%
  rename(EKE.expert.in=expert_in)

nal_q30_weight<- full_join(codes_department, nal_q30_weight)
nal_q30_weight$cat_weighted<- factor(nal_q30_weight$cat_weighted, levels = level_30)
colmap(departamentos, data = nal_q30_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q30_weight$cat))-1), na.value = "#eeeeee")

```


## Question 31: `r unique(individual_surveys$question_in_english)[31]`

```{r question_31}
#selecting only question 31----
question_31<- filter(individual_surveys, question_number==31)
#unique(question_31$numeric_answer)
#dput(unique(question_31$answer_in_english))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_31 <- question_31 %>%
  mutate(answer_in_english = case_when(
    answer_in_english == "No Limitation,Little Limitation" ~ "Little Limitation",
    TRUE ~ answer_in_english  # This keeps all other values as they are
  ))
#some experts selected more than one option in this question so an intermediate answer is chosen 
question_31 <- question_31 %>%
  mutate(numeric_answer = case_when(
    numeric_answer == "1,2" ~ "1.5",
    TRUE ~ numeric_answer  # This keeps all other values as they are
  ))
#organizing the order of the levels
level_31<- c("No Limitation","Little Limitation", "Moderate Limitation", "Extreme Limitation")
question_31$answer_in_english<- factor(question_31$answer_in_english,levels = level_31)
#question_31<- filter(question_31, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_31<- question_31 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(31, mean =average, language = "en"))
#weighted 
add_weights_question_31<- inner_join(question_31, experience_of_each_expert)
avg_dept_weight_31<- add_weights_question_31 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(31, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q31_no_weighted<- tapply(avg_dept_no_weight_31$ave_cat, avg_dept_no_weight_31$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question31_no_weighted<- palette_banana(length(levels_per_crop_Q31_no_weighted$Banana))
colors_plantain_question31_no_weighted<- palette_plantain(length(levels_per_crop_Q31_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_31 <- list(
  Banana = levels_per_crop_Q31_no_weighted$Banana,
  Plantain = levels_per_crop_Q31_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_31 <- list(
  Banana = colors_banana_question31_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question31_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_31 <- assign_group_color(data = avg_dept_no_weight_31, levels_by_crop = levels_by_crop_no_weighted_31, colors_by_crop = colors_by_crop_no_weighted_31,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q31_weighted<- tapply(avg_dept_weight_31$ave_cat_weighted, avg_dept_weight_31$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question31_weighted<- palette_banana(length(levels_per_crop_Q31_weighted$Banana))
colors_plantain_question31_weighted<- palette_plantain(length(levels_per_crop_Q31_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_31 <- list(
  Banana = levels_per_crop_Q31_weighted$Banana,
  Plantain = levels_per_crop_Q31_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_31 <- list(
  Banana = colors_banana_question31_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question31_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_31 <- assign_group_color(data = avg_dept_weight_31, levels_by_crop = levels_by_crop_weighted_31, colors_by_crop = colors_by_crop_weighted_31,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_31, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_31, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q31_no_weight<- question_31 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =31))%>%
  rename(EKE.expert.in = expert_in)

nal_q31_no_weight<- full_join(codes_department, nal_q31_no_weight)
nal_q31_no_weight$cat<- factor(nal_q31_no_weight$cat, levels = level_31)
colmap(departamentos, data = nal_q31_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q31_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q31_weight<- inner_join(question_31, experience_of_each_expert)
nal_q31_weight<- nal_q31_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =31)) %>%
  rename(EKE.expert.in=expert_in)

nal_q31_weight<- full_join(codes_department, nal_q31_weight)
nal_q31_weight$cat_weighted<- factor(nal_q31_weight$cat_weighted, levels = level_31)
colmap(departamentos, data = nal_q31_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q31_weight$cat))-1), na.value = "#eeeeee")
```

## Question 32: `r unique(individual_surveys$question_in_english)[32]`


```{r queestion_32}
#selecting only question 32----
question_32<- filter(individual_surveys, question_number==32)
#dput(unique(question_32$answer_in_english))
question_32<- filter(question_32, answer_in_english!="Unsure")
question_32_Frequencies_non_weighted<- count_elements_by_group(question_32, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q32_no_weighted<- tapply(question_32_Frequencies_non_weighted$answer_in_english, question_32_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question32_no_weighted<- palette_banana(length(levels_per_crop_Q32_no_weighted$Banana))
colors_plantain_question32_no_weighted<- palette_plantain(length(levels_per_crop_Q32_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_32 <- list(
  Banana = levels_per_crop_Q32_no_weighted$Banana,
  Plantain = levels_per_crop_Q32_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_32 <- list(
  Banana = colors_banana_question32_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question32_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_32 <- assign_group_color(data = question_32_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_32, colors_by_crop = colors_by_crop_no_weighted_32,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_32 <- avg_no_weight_32 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Basin" ~ "BAS",
    answer_in_english == "Drip" ~ "DRP",
    answer_in_english == "Furrow/Trench" ~ "FUR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Other" ~ "OTH",
    answer_in_english == "Sprinkler" ~ "SPR",
    
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_32_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_32$crop,
                                    h3= avg_no_weight_32$answer_in_english,
                                    color= avg_no_weight_32$group_color,
                                    weight= avg_no_weight_32$n,
                                    codes= avg_no_weight_32$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_32_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_32_weihted<- inner_join(question_32, experience_of_each_expert)
rep_question_32_weighted<- question_32_weihted %>%
  slice(rep(1:n(), question_32_weihted$weights))
question_32_Frequencies_weighted<- count_elements_by_group(rep_question_32_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_32 <- assign_group_color(data = question_32_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_32, colors_by_crop = colors_by_crop_no_weighted_32,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_32 <- avg_weight_32 %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Basin" ~ "BAS",
      answer_in_english == "Drip" ~ "DRP",
      answer_in_english == "Furrow/Trench" ~ "FUR",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Other" ~ "OTH",
      answer_in_english == "Sprinkler" ~ "SPR",
      
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
avg_weight_32_plot<- data.frame(h1= "total",
                                   h2= avg_weight_32$crop,
                                   h3= avg_weight_32$answer_in_english,
                                   color= avg_weight_32$group_color,
                                   weight= avg_weight_32$n,
                                   codes= avg_weight_32$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_32_plot))
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = T, color_label = "#654321", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654321", size_border = "1.5px", label = F, color_label = "#654321", seed = 3, title = "weighted")
#Frequencies by department
question_32_frequencies_by_depto <- count_elements_by_group(question_32, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_32_frequencies_by_depto <- assign_group_color(data = question_32_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_32, colors_by_crop = colors_by_crop_no_weighted_32,answer_col =  "answer_in_english")
#Make the abbreviations
question_32_frequencies_by_depto <- question_32_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Basin" ~ "BAS",
    answer_in_english == "Drip" ~ "DRP",
    answer_in_english == "Furrow/Trench" ~ "FUR",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Other" ~ "OTH",
    answer_in_english == "Sprinkler" ~ "SPR",
    
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_32_frequencies_by_depto<- select(question_32_frequencies_by_depto,!answer_in_english)
question_32_frequencies_by_depto<- question_32_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_32_frequencies_by_depto<- select(question_32_frequencies_by_depto,!n & !total)
#put it in long format
question_32_frequencies_by_depto <- question_32_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_32_frequencies_by_depto_banana<- filter(question_32_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_32_plot$codes[which(avg_no_weight_32_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_32_frequencies_by_depto_plantain<- filter(question_32_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_32_plot$codes[which(avg_no_weight_32_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_32_frequencies_by_depto<- rbind(question_32_frequencies_by_depto_banana, question_32_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_32_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_32_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_32_frequencies_by_depto_wei <- count_elements_by_group(rep_question_32_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_32_frequencies_by_depto_wei <- assign_group_color(data = question_32_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_32, colors_by_crop = colors_by_crop_no_weighted_32,answer_col =  "answer_in_english")
#Make the abbreviations
question_32_frequencies_by_depto_wei <- question_32_frequencies_by_depto_wei %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Basin" ~ "BAS",
      answer_in_english == "Drip" ~ "DRP",
      answer_in_english == "Furrow/Trench" ~ "FUR",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Other" ~ "OTH",
      answer_in_english == "Sprinkler" ~ "SPR",
      
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#tree map
question_32_frequencies_by_depto_wei<- select(question_32_frequencies_by_depto_wei,!answer_in_english)
question_32_frequencies_by_depto_wei<- question_32_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_32_frequencies_by_depto_wei<- select(question_32_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_32_frequencies_by_depto_wei <- question_32_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_32_frequencies_by_depto_banana_wei<- filter(question_32_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_32_plot$codes[which(avg_no_weight_32_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_32_frequencies_by_depto_plantain_wei<- filter(question_32_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_32_plot$codes[which(avg_no_weight_32_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_32_frequencies_by_depto_wei<- rbind(question_32_frequencies_by_depto_banana_wei, question_32_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_32_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_32_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 32 diseases and pest in Colombia
q32_top_32Colobia<- count_elements_by_group(question_32, "answer_in_english", c("answer_in_english"))
q32_top_32Colobia$mean<-round((q32_top_32Colobia$n/sum(q32_top_32Colobia$n)*100),0)
q32_top_32Colobia$background_color<- "white"
q32_top_32Colobia$color<- palette_soil(length(unique(q32_top_32Colobia$answer_in_english)))
#Make the abbreviations
q32_top_32Colobia <- q32_top_32Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Basin" ~ "BAS",
      answer_in_english == "Drip" ~ "DRP",
      answer_in_english == "Furrow/Trench" ~ "FUR",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Other" ~ "OTH",
      answer_in_english == "Sprinkler" ~ "SPR",
      
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q32_top_32Colobia <- q32_top_32Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q32_top_32Colobia$cat_abbreviations<- factor(q32_top_32Colobia$cat_abbreviations, levels = q32_top_32Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q32_top_32Colobia,x_lab = "Irrigation System", y_lab ="Proportion of Experts (%)", title = "
Irrigation Systems Utilized in Musaceae Prodruction -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 32 diseases and pest in Colombia -WEIGHTED
q_32_weighted_top_32Colobia<- count_elements_by_group(rep_question_32_weighted, "answer_in_english", c("answer_in_english"))
q_32_weighted_top_32Colobia$mean<-round((q_32_weighted_top_32Colobia$n/sum(q_32_weighted_top_32Colobia$n)*100),0)
q_32_weighted_top_32Colobia$background_color<- "white"
q_32_weighted_top_32Colobia$color<- palette_soil(length(unique(q_32_weighted_top_32Colobia$answer_in_english)))
#Make the abbreviations
q_32_weighted_top_32Colobia <- q_32_weighted_top_32Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Basin" ~ "BAS",
      answer_in_english == "Drip" ~ "DRP",
      answer_in_english == "Furrow/Trench" ~ "FUR",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Other" ~ "OTH",
      answer_in_english == "Sprinkler" ~ "SPR",
      
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q_32_weighted_top_32Colobia <- q_32_weighted_top_32Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_32_weighted_top_32Colobia$cat_abbreviations<- factor(q_32_weighted_top_32Colobia$cat_abbreviations, levels = q_32_weighted_top_32Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_32_weighted_top_32Colobia,x_lab = "Irrigation System", y_lab ="Proportion of Experts (%)", title = "
Irrigation Systems Utilized in Musaceae Prodruction -  W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```


## Question 33: `r unique(individual_surveys$question_in_english)[33]`


```{r queestion_33}
#selecting only question 33----
question_33<- filter(individual_surveys, question_number==33)
#dput(unique(question_33$answer_in_english))
question_33<- filter(question_33, answer_in_english!="Unsure")
question_33_Frequencies_non_weighted<- count_elements_by_group(question_33, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q33_no_weighted<- tapply(question_33_Frequencies_non_weighted$answer_in_english, question_33_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question33_no_weighted<- palette_banana(length(levels_per_crop_Q33_no_weighted$Banana))
colors_plantain_question33_no_weighted<- palette_plantain(length(levels_per_crop_Q33_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_33 <- list(
  Banana = levels_per_crop_Q33_no_weighted$Banana,
  Plantain = levels_per_crop_Q33_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_33 <- list(
  Banana = colors_banana_question33_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question33_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_33 <- assign_group_color(data = question_33_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_33, colors_by_crop = colors_by_crop_no_weighted_33,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_33 <- avg_no_weight_33 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Community Irrigation Districts" ~ "CID",
    answer_in_english == "Dams" ~ "DAM",
    answer_in_english == "Groundwater" ~ "GW",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Others" ~ "OTH",
    answer_in_english == "Rainwater" ~ "RW",
    answer_in_english == "Surface Water" ~ "SW",
    answer_in_english == "Treated Wastewater" ~ "TWW",
    answer_in_english == "Unsure" ~ "UNS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_33_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_33$crop,
                                    h3= avg_no_weight_33$answer_in_english,
                                    color= avg_no_weight_33$group_color,
                                    weight= avg_no_weight_33$n,
                                    codes= avg_no_weight_33$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_33_plot))
vt_d3(gdp_json, color_border = "#654331", size_border = "1.5px", label = T, color_label = "#654331", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654331", size_border = "1.5px", label = F, color_label = "#654331", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_33_weihted<- inner_join(question_33, experience_of_each_expert)
rep_question_33_weighted<- question_33_weihted %>%
  slice(rep(1:n(), question_33_weihted$weights))
question_33_Frequencies_weighted<- count_elements_by_group(rep_question_33_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_33 <- assign_group_color(data = question_33_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_33, colors_by_crop = colors_by_crop_no_weighted_33,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_33 <- avg_weight_33 %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Irrigation Districts" ~ "CID",
      answer_in_english == "Dams" ~ "DAM",
      answer_in_english == "Groundwater" ~ "GW",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Others" ~ "OTH",
      answer_in_english == "Rainwater" ~ "RW",
      answer_in_english == "Surface Water" ~ "SW",
      answer_in_english == "Treated Wastewater" ~ "TWW",
      answer_in_english == "Unsure" ~ "UNS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
avg_weight_33_plot<- data.frame(h1= "total",
                                   h2= avg_weight_33$crop,
                                   h3= avg_weight_33$answer_in_english,
                                   color= avg_weight_33$group_color,
                                   weight= avg_weight_33$n,
                                   codes= avg_weight_33$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_33_plot))
vt_d3(gdp_json, color_border = "#654331", size_border = "1.5px", label = T, color_label = "#654331", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654331", size_border = "1.5px", label = F, color_label = "#654331", seed = 3, title = "weighted")
#Frequencies by department
question_33_frequencies_by_depto <- count_elements_by_group(question_33, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_33_frequencies_by_depto <- assign_group_color(data = question_33_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_33, colors_by_crop = colors_by_crop_no_weighted_33,answer_col =  "answer_in_english")
#Make the abbreviations
question_33_frequencies_by_depto <- question_33_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Community Irrigation Districts" ~ "CID",
    answer_in_english == "Dams" ~ "DAM",
    answer_in_english == "Groundwater" ~ "GW",
    answer_in_english == "None" ~ "NON",
    answer_in_english == "Others" ~ "OTH",
    answer_in_english == "Rainwater" ~ "RW",
    answer_in_english == "Surface Water" ~ "SW",
    answer_in_english == "Treated Wastewater" ~ "TWW",
    answer_in_english == "Unsure" ~ "UNS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_33_frequencies_by_depto<- select(question_33_frequencies_by_depto,!answer_in_english)
question_33_frequencies_by_depto<- question_33_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_33_frequencies_by_depto<- select(question_33_frequencies_by_depto,!n & !total)
#put it in long format
question_33_frequencies_by_depto <- question_33_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_33_frequencies_by_depto_banana<- filter(question_33_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_33_plot$codes[which(avg_no_weight_33_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_33_frequencies_by_depto_plantain<- filter(question_33_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_33_plot$codes[which(avg_no_weight_33_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_33_frequencies_by_depto<- rbind(question_33_frequencies_by_depto_banana, question_33_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_33_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_33_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_33_frequencies_by_depto_wei <- count_elements_by_group(rep_question_33_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_33_frequencies_by_depto_wei <- assign_group_color(data = question_33_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_33, colors_by_crop = colors_by_crop_no_weighted_33,answer_col =  "answer_in_english")
#Make the abbreviations
question_33_frequencies_by_depto_wei <- question_33_frequencies_by_depto_wei %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Irrigation Districts" ~ "CID",
      answer_in_english == "Dams" ~ "DAM",
      answer_in_english == "Groundwater" ~ "GW",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Others" ~ "OTH",
      answer_in_english == "Rainwater" ~ "RW",
      answer_in_english == "Surface Water" ~ "SW",
      answer_in_english == "Treated Wastewater" ~ "TWW",
      answer_in_english == "Unsure" ~ "UNS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#tree map
question_33_frequencies_by_depto_wei<- select(question_33_frequencies_by_depto_wei,!answer_in_english)
question_33_frequencies_by_depto_wei<- question_33_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_33_frequencies_by_depto_wei<- select(question_33_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_33_frequencies_by_depto_wei <- question_33_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_33_frequencies_by_depto_banana_wei<- filter(question_33_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_33_plot$codes[which(avg_no_weight_33_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_33_frequencies_by_depto_plantain_wei<- filter(question_33_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_33_plot$codes[which(avg_no_weight_33_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_33_frequencies_by_depto_wei<- rbind(question_33_frequencies_by_depto_banana_wei, question_33_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_33_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_33_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 33 diseases and pest in Colombia
q33_top_33Colobia<- count_elements_by_group(question_33, "answer_in_english", c("answer_in_english"))
q33_top_33Colobia$mean<-round((q33_top_33Colobia$n/sum(q33_top_33Colobia$n)*100),0)
q33_top_33Colobia$background_color<- "white"
q33_top_33Colobia$color<- palette_soil(length(unique(q33_top_33Colobia$answer_in_english)))
#Make the abbreviations
q33_top_33Colobia <- q33_top_33Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Irrigation Districts" ~ "CID",
      answer_in_english == "Dams" ~ "DAM",
      answer_in_english == "Groundwater" ~ "GW",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Others" ~ "OTH",
      answer_in_english == "Rainwater" ~ "RW",
      answer_in_english == "Surface Water" ~ "SW",
      answer_in_english == "Treated Wastewater" ~ "TWW",
      answer_in_english == "Unsure" ~ "UNS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q33_top_33Colobia <- q33_top_33Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q33_top_33Colobia$cat_abbreviations<- factor(q33_top_33Colobia$cat_abbreviations, levels = q33_top_33Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q33_top_33Colobia,x_lab = "Water Source", y_lab ="Proportion of Experts (%)", title = "
Water Source Utilized for Musaceae Prodruction -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 33 diseases and pest in Colombia -WEIGHTED
q_33_weighted_top_33Colobia<- count_elements_by_group(rep_question_33_weighted, "answer_in_english", c("answer_in_english"))
q_33_weighted_top_33Colobia$mean<-round((q_33_weighted_top_33Colobia$n/sum(q_33_weighted_top_33Colobia$n)*100),0)
q_33_weighted_top_33Colobia$background_color<- "white"
q_33_weighted_top_33Colobia$color<- palette_soil(length(unique(q_33_weighted_top_33Colobia$answer_in_english)))
#Make the abbreviations
q_33_weighted_top_33Colobia <- q_33_weighted_top_33Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Irrigation Districts" ~ "CID",
      answer_in_english == "Dams" ~ "DAM",
      answer_in_english == "Groundwater" ~ "GW",
      answer_in_english == "None" ~ "NON",
      answer_in_english == "Others" ~ "OTH",
      answer_in_english == "Rainwater" ~ "RW",
      answer_in_english == "Surface Water" ~ "SW",
      answer_in_english == "Treated Wastewater" ~ "TWW",
      answer_in_english == "Unsure" ~ "UNS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q_33_weighted_top_33Colobia <- q_33_weighted_top_33Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_33_weighted_top_33Colobia$cat_abbreviations<- factor(q_33_weighted_top_33Colobia$cat_abbreviations, levels = q_33_weighted_top_33Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_33_weighted_top_33Colobia,x_lab = "Water Source", y_lab ="Proportion of Experts (%)", title = "
Water Source Utilized for Musaceae Prodruction -  W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```

## Question 34: `r unique(individual_surveys$question_in_english)[34]`

```{r question_34}
#selecting only question 34----
question_34<- filter(individual_surveys, question_number==34)
#select Add_parameters_english different than "Not Sure"
question_34<- filter(question_34, Add_parameters_english!="Not Sure")
#Verify the unique values in the numeric_answer column
unique(question_34$numeric_answer)
#Verify if the percentages by expert and department sum 100% and select those that are not 100%
verification_34<- question_34 %>%
  group_by(crop, expert_in, expert_ID) %>%
  summarise(sum= sum(as.numeric(numeric_answer))) %>%
  filter(sum!=100)
#Remove the experts by department and crop that answer more or less than 100%
question_34<- anti_join(question_34, verification_34, by=c("crop", "expert_in", "expert_ID"))
#double chech all the kept values are 100%
# verification_34<- question_34 %>%
#   group_by(crop, expert_in, expert_ID) %>%
#   summarise(sum= sum(as.numeric(numeric_answer)))
# nrow(verification_34)
# sum(verification_34$sum==100)
question_34<- inner_join(question_34, experience_of_each_expert)
#repeat the interaction the number of times given in the numeric answer column
question_34$numeric_answer<- as.numeric(question_34$numeric_answer)
question_34_long<- question_34 %>%
  slice(rep(1:n(),question_34$numeric_answer)) 
#Add the weights for the weighted data set
question_34_long_weighted<- question_34_long %>%
  slice(rep(1:n(), question_34_long$weights))
question_34_long_frequencies<- summarise_frequencies(data=question_34_long, first_group_cols = c("crop","expert_in"), second_group_cols =  c("crop","expert_in", "Add_parameters_english"))
question_34_long_frequencies_weighted<- summarise_frequencies(data=question_34_long_weighted, first_group_cols = c("crop","expert_in"), second_group_cols =  c("crop","expert_in", "Add_parameters_english"))

#National non weighted 
sankey_national_non_weighted_34 <- create_sankey(
  data = question_34_long_frequencies,
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_soil(length(unique(question_34_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_national_non_weighted_34


sankey_banana_non_weighted_34 <- create_sankey(
  data = filter(question_34_long_frequencies, crop=="Banana"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_banana(length(unique(question_34_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_banana_non_weighted_34

#Plantain non weighted 
sankey_plantain_non_weighted_34 <- create_sankey(
  data = filter(question_34_long_frequencies, crop=="Plantain"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_plantain(length(unique(question_34_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_plantain_non_weighted_34


#National weighted 
sankey_national_non_weighted_34 <- create_sankey(
  data = question_34_long_frequencies_weighted,
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_soil(length(unique(question_34_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_national_non_weighted_34
#banana weighted 
sankey_banana_non_weighted_34 <- create_sankey(
  data = filter(question_34_long_frequencies_weighted, crop=="Banana"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_banana(length(unique(question_34_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_banana_non_weighted_34
#Plantain weighted 
sankey_plantain_non_weighted_34 <- create_sankey(
  data = filter(question_34_long_frequencies_weighted, crop=="Plantain"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_plantain(length(unique(question_34_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_plantain_non_weighted_34
```

## Question 35: `r unique(individual_surveys$question_in_english)[35]`

```{r questoin_35}
#selecting only question 35----
question_35<- filter(individual_surveys, question_number==35)
#dput(unique(question_35$answer_in_english))
question_35<- filter(question_35, answer_in_english!="Unsure")
question_35_Frequencies_non_weighted<- count_elements_by_group(question_35, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q35_no_weighted<- tapply(question_35_Frequencies_non_weighted$answer_in_english, question_35_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question35_no_weighted<- palette_banana(length(levels_per_crop_Q35_no_weighted$Banana))
colors_plantain_question35_no_weighted<- palette_plantain(length(levels_per_crop_Q35_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_35 <- list(
  Banana = levels_per_crop_Q35_no_weighted$Banana,
  Plantain = levels_per_crop_Q35_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_35 <- list(
  Banana = colors_banana_question35_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question35_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_35 <- assign_group_color(data = question_35_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_35, colors_by_crop = colors_by_crop_no_weighted_35,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_35 <- avg_no_weight_35 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Chemical Treatment" ~ "CT",
    answer_in_english == "Filtration" ~ "FIL",
    answer_in_english == "No Treatment" ~ "NT",
    answer_in_english == "Physical Treatment" ~ "PT",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_35_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_35$crop,
                                    h3= avg_no_weight_35$answer_in_english,
                                    color= avg_no_weight_35$group_color,
                                    weight= avg_no_weight_35$n,
                                    codes= avg_no_weight_35$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_35_plot))
vt_d3(gdp_json, color_border = "#654351", size_border = "1.5px", label = T, color_label = "#654351", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654351", size_border = "1.5px", label = F, color_label = "#654351", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_35_weihted<- inner_join(question_35, experience_of_each_expert)
rep_question_35_weighted<- question_35_weihted %>%
  slice(rep(1:n(), question_35_weihted$weights))
question_35_Frequencies_weighted<- count_elements_by_group(rep_question_35_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_35 <- assign_group_color(data = question_35_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_35, colors_by_crop = colors_by_crop_no_weighted_35,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_35 <- avg_weight_35 %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Chemical Treatment" ~ "CT",
      answer_in_english == "Filtration" ~ "FIL",
      answer_in_english == "No Treatment" ~ "NT",
      answer_in_english == "Physical Treatment" ~ "PT",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
avg_weight_35_plot<- data.frame(h1= "total",
                                   h2= avg_weight_35$crop,
                                   h3= avg_weight_35$answer_in_english,
                                   color= avg_weight_35$group_color,
                                   weight= avg_weight_35$n,
                                   codes= avg_weight_35$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_35_plot))
vt_d3(gdp_json, color_border = "#654351", size_border = "1.5px", label = T, color_label = "#654351", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654351", size_border = "1.5px", label = F, color_label = "#654351", seed = 3, title = "weighted")
#Frequencies by department
question_35_frequencies_by_depto <- count_elements_by_group(question_35, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_35_frequencies_by_depto <- assign_group_color(data = question_35_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_35, colors_by_crop = colors_by_crop_no_weighted_35,answer_col =  "answer_in_english")
#Make the abbreviations
question_35_frequencies_by_depto <- question_35_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Chemical Treatment" ~ "CT",
    answer_in_english == "Filtration" ~ "FIL",
    answer_in_english == "No Treatment" ~ "NT",
    answer_in_english == "Physical Treatment" ~ "PT",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_35_frequencies_by_depto<- select(question_35_frequencies_by_depto,!answer_in_english)
question_35_frequencies_by_depto<- question_35_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_35_frequencies_by_depto<- select(question_35_frequencies_by_depto,!n & !total)
#put it in long format
question_35_frequencies_by_depto <- question_35_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_35_frequencies_by_depto_banana<- filter(question_35_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_35_plot$codes[which(avg_no_weight_35_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_35_frequencies_by_depto_plantain<- filter(question_35_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_35_plot$codes[which(avg_no_weight_35_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_35_frequencies_by_depto<- rbind(question_35_frequencies_by_depto_banana, question_35_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_35_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_35_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_35_frequencies_by_depto_wei <- count_elements_by_group(rep_question_35_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_35_frequencies_by_depto_wei <- assign_group_color(data = question_35_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_35, colors_by_crop = colors_by_crop_no_weighted_35,answer_col =  "answer_in_english")
#Make the abbreviations
question_35_frequencies_by_depto_wei <- question_35_frequencies_by_depto_wei %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Chemical Treatment" ~ "CT",
      answer_in_english == "Filtration" ~ "FIL",
      answer_in_english == "No Treatment" ~ "NT",
      answer_in_english == "Physical Treatment" ~ "PT",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#tree map
question_35_frequencies_by_depto_wei<- select(question_35_frequencies_by_depto_wei,!answer_in_english)
question_35_frequencies_by_depto_wei<- question_35_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_35_frequencies_by_depto_wei<- select(question_35_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_35_frequencies_by_depto_wei <- question_35_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_35_frequencies_by_depto_banana_wei<- filter(question_35_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_35_plot$codes[which(avg_no_weight_35_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_35_frequencies_by_depto_plantain_wei<- filter(question_35_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_35_plot$codes[which(avg_no_weight_35_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_35_frequencies_by_depto_wei<- rbind(question_35_frequencies_by_depto_banana_wei, question_35_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_35_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_35_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 35 diseases and pest in Colombia
q35_top_35Colobia<- count_elements_by_group(question_35, "answer_in_english", c("answer_in_english"))
q35_top_35Colobia$mean<-round((q35_top_35Colobia$n/sum(q35_top_35Colobia$n)*100),0)
q35_top_35Colobia$background_color<- "white"
q35_top_35Colobia$color<- palette_soil(length(unique(q35_top_35Colobia$answer_in_english)))
#Make the abbreviations
q35_top_35Colobia <- q35_top_35Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Chemical Treatment" ~ "CT",
      answer_in_english == "Filtration" ~ "FIL",
      answer_in_english == "No Treatment" ~ "NT",
      answer_in_english == "Physical Treatment" ~ "PT",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q35_top_35Colobia <- q35_top_35Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q35_top_35Colobia$cat_abbreviations<- factor(q35_top_35Colobia$cat_abbreviations, levels = q35_top_35Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q35_top_35Colobia,x_lab = "Water Treatment", y_lab ="Proportion of Experts (%)", title = "
Irrigation Water Treatment Utilized for Musaceae Prodruction -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 35 diseases and pest in Colombia -WEIGHTED
q_35_weighted_top_35Colobia<- count_elements_by_group(rep_question_35_weighted, "answer_in_english", c("answer_in_english"))
q_35_weighted_top_35Colobia$mean<-round((q_35_weighted_top_35Colobia$n/sum(q_35_weighted_top_35Colobia$n)*100),0)
q_35_weighted_top_35Colobia$background_color<- "white"
q_35_weighted_top_35Colobia$color<- palette_soil(length(unique(q_35_weighted_top_35Colobia$answer_in_english)))
#Make the abbreviations
q_35_weighted_top_35Colobia <- q_35_weighted_top_35Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Chemical Treatment" ~ "CT",
      answer_in_english == "Filtration" ~ "FIL",
      answer_in_english == "No Treatment" ~ "NT",
      answer_in_english == "Physical Treatment" ~ "PT",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q_35_weighted_top_35Colobia <- q_35_weighted_top_35Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_35_weighted_top_35Colobia$cat_abbreviations<- factor(q_35_weighted_top_35Colobia$cat_abbreviations, levels = q_35_weighted_top_35Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_35_weighted_top_35Colobia,x_lab = "Water Treatment", y_lab ="Proportion of Experts (%)", title = "
Irrigation Water Treatment Utilized for Musaceae Prodruction -  W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```

## Question 36: `r unique(individual_surveys$question_in_english)[36]`


```{r question_36}
#selecting only question 36----
question_36<- filter(individual_surveys, question_number==36)
#unique(question_36$numeric_answer)
#dput(unique(question_36$answer_in_english))
#organizing the order of the levels
level_36<- c("0%", "1%-10%", "11%-20%", "21%-30%", "31%-40%", "41%-50%","51%-60%", "61%-70%", "71%-80%", "81%-90%", "91%-100%", "Not Sure")
question_36$answer_in_english<- factor(question_36$answer_in_english,levels = level_36)
question_36<- filter(question_36, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_36<- question_36 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(36, mean =average, language = "en"))
#weighted 
add_weights_question_36<- inner_join(question_36, experience_of_each_expert)
avg_dept_weight_36<- add_weights_question_36 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(36, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q36_no_weighted<- tapply(avg_dept_no_weight_36$ave_cat, avg_dept_no_weight_36$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question36_no_weighted<- palette_banana(length(levels_per_crop_Q36_no_weighted$Banana))
colors_plantain_question36_no_weighted<- palette_plantain(length(levels_per_crop_Q36_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_36 <- list(
  Banana = levels_per_crop_Q36_no_weighted$Banana,
  Plantain = levels_per_crop_Q36_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_36 <- list(
  Banana = colors_banana_question36_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question36_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_36 <- assign_group_color(data = avg_dept_no_weight_36, levels_by_crop = levels_by_crop_no_weighted_36, colors_by_crop = colors_by_crop_no_weighted_36,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q36_weighted<- tapply(avg_dept_weight_36$ave_cat_weighted, avg_dept_weight_36$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question36_weighted<- palette_banana(length(levels_per_crop_Q36_weighted$Banana))
colors_plantain_question36_weighted<- palette_plantain(length(levels_per_crop_Q36_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_36 <- list(
  Banana = levels_per_crop_Q36_weighted$Banana,
  Plantain = levels_per_crop_Q36_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_36 <- list(
  Banana = colors_banana_question36_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question36_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_36 <- assign_group_color(data = avg_dept_weight_36, levels_by_crop = levels_by_crop_weighted_36, colors_by_crop = colors_by_crop_weighted_36,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_36, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_36, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q36_no_weight<- question_36 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =36))%>%
  rename(EKE.expert.in = expert_in)

nal_q36_no_weight<- full_join(codes_department, nal_q36_no_weight)
nal_q36_no_weight$cat<- factor(nal_q36_no_weight$cat, levels = level_36)
colmap(departamentos, data = nal_q36_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q36_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q36_weight<- inner_join(question_36, experience_of_each_expert)
nal_q36_weight<- nal_q36_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =36)) %>%
  rename(EKE.expert.in=expert_in)

nal_q36_weight<- full_join(codes_department, nal_q36_weight)
nal_q36_weight$cat_weighted<- factor(nal_q36_weight$cat_weighted, levels = level_36)
colmap(departamentos, data = nal_q36_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q36_weight$cat))-1), na.value = "#eeeeee")

```

## Question 37: `r unique(individual_surveys$question_in_english)[37]`

```{r question_37}
#selecting only question 37----
question_37<- filter(individual_surveys, question_number==37)
#unique(question_37$numeric_answer)
#dput(unique(question_37$answer_in_english))
#organizing the order of the levels
level_37<- c("Extremely Unlikely", "Very Unlikely", "Unlikely", "Somewhat Unlikely", "Neutral", "Somewhat Likely", "Likely", "Very Likely", "Extremely Likely", "Unsure")
question_37$answer_in_english<- factor(question_37$answer_in_english,levels = level_37)
question_37<- filter(question_37, answer_in_english!="Unsure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_37<- question_37 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(37, mean =average, language = "en"))
#weighted 
add_weights_question_37<- inner_join(question_37, experience_of_each_expert)
avg_dept_weight_37<- add_weights_question_37 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(37, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q37_no_weighted<- tapply(avg_dept_no_weight_37$ave_cat, avg_dept_no_weight_37$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question37_no_weighted<- palette_banana(length(levels_per_crop_Q37_no_weighted$Banana))
colors_plantain_question37_no_weighted<- palette_plantain(length(levels_per_crop_Q37_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_37 <- list(
  Banana = levels_per_crop_Q37_no_weighted$Banana,
  Plantain = levels_per_crop_Q37_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_37 <- list(
  Banana = colors_banana_question37_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question37_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_37 <- assign_group_color(data = avg_dept_no_weight_37, levels_by_crop = levels_by_crop_no_weighted_37, colors_by_crop = colors_by_crop_no_weighted_37,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q37_weighted<- tapply(avg_dept_weight_37$ave_cat_weighted, avg_dept_weight_37$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question37_weighted<- palette_banana(length(levels_per_crop_Q37_weighted$Banana))
colors_plantain_question37_weighted<- palette_plantain(length(levels_per_crop_Q37_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_37 <- list(
  Banana = levels_per_crop_Q37_weighted$Banana,
  Plantain = levels_per_crop_Q37_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_37 <- list(
  Banana = colors_banana_question37_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question37_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_37 <- assign_group_color(data = avg_dept_weight_37, levels_by_crop = levels_by_crop_weighted_37, colors_by_crop = colors_by_crop_weighted_37,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_37, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_37, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q37_no_weight<- question_37 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =37))%>%
  rename(EKE.expert.in = expert_in)

nal_q37_no_weight<- full_join(codes_department, nal_q37_no_weight)
nal_q37_no_weight$cat<- factor(nal_q37_no_weight$cat, levels = level_37)
colmap(departamentos, data = nal_q37_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q37_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q37_weight<- inner_join(question_37, experience_of_each_expert)
nal_q37_weight<- nal_q37_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =37)) %>%
  rename(EKE.expert.in=expert_in)

nal_q37_weight<- full_join(codes_department, nal_q37_weight)
nal_q37_weight$cat_weighted<- factor(nal_q37_weight$cat_weighted, levels = level_37)
colmap(departamentos, data = nal_q37_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q37_weight$cat))-1), na.value = "#eeeeee")
```


## Question 38: `r unique(individual_surveys$question_in_english)[38]`

```{r question_38}
#selecting only question 38----
question_38<- filter(individual_surveys, question_number==38)
#select Add_parameters_english different than "Not Sure"
question_38<- filter(question_38, Add_parameters_english!="Not Sure")
#Verify the unique values in the numeric_answer column
unique(question_38$numeric_answer)
#Verify if the percentages by expert and department sum 100% and select those that are not 100%
verification_38<- question_38 %>%
  group_by(crop, expert_in, expert_ID) %>%
  summarise(sum= sum(as.numeric(numeric_answer))) %>%
  filter(sum!=100)
#Remove the experts by department and crop that answer more or less than 100%
question_38<- anti_join(question_38, verification_38, by=c("crop", "expert_in", "expert_ID"))
#double chech all the kept values are 100%
# verification_38<- question_38 %>%
#   group_by(crop, expert_in, expert_ID) %>%
#   summarise(sum= sum(as.numeric(numeric_answer)))
# nrow(verification_38)
# sum(verification_38$sum==100)
question_38<- inner_join(question_38, experience_of_each_expert)
#repeat the interaction the number of times given in the numeric answer column
question_38$numeric_answer<- as.numeric(question_38$numeric_answer)
question_38_long<- question_38 %>%
  slice(rep(1:n(),question_38$numeric_answer)) 
#Add the weights for the weighted data set
question_38_long_weighted<- question_38_long %>%
  slice(rep(1:n(), question_38_long$weights))
question_38_long_frequencies<- summarise_frequencies(data=question_38_long, first_group_cols = c("crop","expert_in"), second_group_cols =  c("crop","expert_in", "Add_parameters_english"))
question_38_long_frequencies_weighted<- summarise_frequencies(data=question_38_long_weighted, first_group_cols = c("crop","expert_in"), second_group_cols =  c("crop","expert_in", "Add_parameters_english"))


#National non weighted 
sankey_national_non_weighted_38 <- create_sankey(
  data = question_38_long_frequencies,
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_soil(length(unique(question_38_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_national_non_weighted_38


sankey_banana_non_weighted_38 <- create_sankey(
  data = filter(question_38_long_frequencies, crop=="Banana"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_banana(length(unique(question_38_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_banana_non_weighted_38

#Plantain non weighted 
sankey_plantain_non_weighted_38 <- create_sankey(
  data = filter(question_38_long_frequencies, crop=="Plantain"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_plantain(length(unique(question_38_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_plantain_non_weighted_38


#National weighted 
sankey_national_non_weighted_38 <- create_sankey(
  data = question_38_long_frequencies_weighted,
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_soil(length(unique(question_38_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_national_non_weighted_38
#banana weighted 
sankey_banana_non_weighted_38 <- create_sankey(
  data = filter(question_38_long_frequencies_weighted, crop=="Banana"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_banana(length(unique(question_38_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_banana_non_weighted_38
#Plantain weighted 
sankey_plantain_non_weighted_38 <- create_sankey(
  data = filter(question_38_long_frequencies_weighted, crop=="Plantain"),
  target = "expert_in",
  source = "Add_parameters_english",
  value = "freq_unique",
  ColourScal = paste("d3.scaleOrdinal().range([\"", paste(palette_plantain(length(unique(question_38_long_frequencies$Add_parameters_english))), collapse = "\", \""), "\"])", sep = "")
)
sankey_plantain_non_weighted_38
```


## Question 39: `r unique(individual_surveys$question_in_english)[39]`

```{r question_39}
#selecting only question 39----
question_39<- filter(individual_surveys, question_number==39)
#unique(question_39$numeric_answer)
#dput(unique(question_39$answer_in_english))
#organizing the order of the levels
level_39<- c("Very Low Risk", "Low Risk", "Moderate Risk", "High Risk", "Not Sure")
question_39$answer_in_english<- factor(question_39$answer_in_english,levels = level_39)
question_39<- filter(question_39, answer_in_english!="Not Sure")
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_39<- question_39 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(39, mean =average, language = "en"))
#weighted 
add_weights_question_39<- inner_join(question_39, experience_of_each_expert)
avg_dept_weight_39<- add_weights_question_39 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(39, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q39_no_weighted<- tapply(avg_dept_no_weight_39$ave_cat, avg_dept_no_weight_39$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question39_no_weighted<- palette_banana(length(levels_per_crop_Q39_no_weighted$Banana))
colors_plantain_question39_no_weighted<- palette_plantain(length(levels_per_crop_Q39_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_39 <- list(
  Banana = levels_per_crop_Q39_no_weighted$Banana,
  Plantain = levels_per_crop_Q39_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_39 <- list(
  Banana = colors_banana_question39_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question39_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_39 <- assign_group_color(data = avg_dept_no_weight_39, levels_by_crop = levels_by_crop_no_weighted_39, colors_by_crop = colors_by_crop_no_weighted_39,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q39_weighted<- tapply(avg_dept_weight_39$ave_cat_weighted, avg_dept_weight_39$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question39_weighted<- palette_banana(length(levels_per_crop_Q39_weighted$Banana))
colors_plantain_question39_weighted<- palette_plantain(length(levels_per_crop_Q39_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_39 <- list(
  Banana = levels_per_crop_Q39_weighted$Banana,
  Plantain = levels_per_crop_Q39_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_39 <- list(
  Banana = colors_banana_question39_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question39_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_39 <- assign_group_color(data = avg_dept_weight_39, levels_by_crop = levels_by_crop_weighted_39, colors_by_crop = colors_by_crop_weighted_39,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_39, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_39, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q39_no_weight<- question_39 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =39))%>%
  rename(EKE.expert.in = expert_in)

nal_q39_no_weight<- full_join(codes_department, nal_q39_no_weight)
nal_q39_no_weight$cat<- factor(nal_q39_no_weight$cat, levels = level_39)
colmap(departamentos, data = nal_q39_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q39_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q39_weight<- inner_join(question_39, experience_of_each_expert)
nal_q39_weight<- nal_q39_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =39)) %>%
  rename(EKE.expert.in=expert_in)

nal_q39_weight<- full_join(codes_department, nal_q39_weight)
nal_q39_weight$cat_weighted<- factor(nal_q39_weight$cat_weighted, levels = level_39)
colmap(departamentos, data = nal_q39_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q39_weight$cat))-1), na.value = "#eeeeee")
```


## Question 40: `r unique(individual_surveys$question_in_english)[40]`

```{r questions_40}
#selecting only question 40----
question_40<- filter(individual_surveys, question_number==40)
#unique(question_40$numeric_answer)
#dput(unique(question_40$answer_in_english))
#organizing the order of the levels
level_40<- c("Slightly Feasible", "Moderately Feasible", "Very Feasible", "Extremely Feasible")
question_40$answer_in_english<- factor(question_40$answer_in_english,levels = level_40)
#average by department (weighted and no weighted)
#not weighted 
avg_dept_no_weight_40<- question_40 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average= mean(numeric_answer)) %>%
  group_by(average)%>%
  mutate(ave_cat= category_by_mean_by_question(40, mean =average, language = "en"))
#weighted 
add_weights_question_40<- inner_join(question_40, experience_of_each_expert)
avg_dept_weight_40<- add_weights_question_40 %>%
  group_by(crop, expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer))%>%
  mutate(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted)%>%
  mutate(ave_cat_weighted= category_by_mean_by_question(40, mean =average_weighted, language = "en"))

#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q40_no_weighted<- tapply(avg_dept_no_weight_40$ave_cat, avg_dept_no_weight_40$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question40_no_weighted<- palette_banana(length(levels_per_crop_Q40_no_weighted$Banana))
colors_plantain_question40_no_weighted<- palette_plantain(length(levels_per_crop_Q40_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_40 <- list(
  Banana = levels_per_crop_Q40_no_weighted$Banana,
  Plantain = levels_per_crop_Q40_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_40 <- list(
  Banana = colors_banana_question40_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question40_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_no_weight_40 <- assign_group_color(data = avg_dept_no_weight_40, levels_by_crop = levels_by_crop_no_weighted_40, colors_by_crop = colors_by_crop_no_weighted_40,answer_col =  "ave_cat")

#finding the levels per crop (banana and plantain) weighted
levels_per_crop_Q40_weighted<- tapply(avg_dept_weight_40$ave_cat_weighted, avg_dept_weight_40$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question40_weighted<- palette_banana(length(levels_per_crop_Q40_weighted$Banana))
colors_plantain_question40_weighted<- palette_plantain(length(levels_per_crop_Q40_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_weighted_40 <- list(
  Banana = levels_per_crop_Q40_weighted$Banana,
  Plantain = levels_per_crop_Q40_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_weighted_40 <- list(
  Banana = colors_banana_question40_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question40_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_dept_weight_40 <- assign_group_color(data = avg_dept_weight_40, levels_by_crop = levels_by_crop_weighted_40, colors_by_crop = colors_by_crop_weighted_40,answer_col =  "ave_cat_weighted")

#tree map
tree_map_3(data = avg_dept_no_weight_40, "crop", "expert_in", "ave_cat", "group_color", title="No weighted")
tree_map_3(data = avg_dept_weight_40, "crop", "expert_in", "ave_cat_weighted", "group_color", title="weighted")
#Map of Colombia  
#non weighted
nal_q40_no_weight<- question_40 %>% group_by(expert_in) %>%
  summarise(average= mean(as.numeric(numeric_answer))) %>%
  group_by(average) %>% 
  mutate(cat= category_by_mean_by_question(language = "en", mean = average, question =40))%>%
  rename(EKE.expert.in = expert_in)

nal_q40_no_weight<- full_join(codes_department, nal_q40_no_weight)
nal_q40_no_weight$cat<- factor(nal_q40_no_weight$cat, levels = level_40)
colmap(departamentos, data = nal_q40_no_weight, data_id = "id_depto", var = "cat")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q40_no_weight$cat))-1), na.value = "#eeeeee")
# weighted
nal_q40_weight<- inner_join(question_40, experience_of_each_expert)
nal_q40_weight<- nal_q40_weight %>%
  group_by(expert_in) %>%
  mutate(numeric_answer=as.numeric(numeric_answer)) %>%
  summarise(average_weighted= weighted.mean(numeric_answer, weights)) %>% 
  group_by(average_weighted) %>%
  mutate(cat_weighted= category_by_mean_by_question(language = "en", mean = average_weighted, question =40)) %>%
  rename(EKE.expert.in=expert_in)

nal_q40_weight<- full_join(codes_department, nal_q40_weight)
nal_q40_weight$cat_weighted<- factor(nal_q40_weight$cat_weighted, levels = level_40)
colmap(departamentos, data = nal_q40_weight, data_id = "id_depto", var = "cat_weighted")+
  scale_fill_manual(values = palette_soil(length(unique(nal_q40_weight$cat))-1), na.value = "#eeeeee")

```

## Question 41: `r unique(individual_surveys$question_in_english)[41]`


```{r question_41}
#selecting only question 41----
question_41<- filter(individual_surveys, question_number==41)
#dput(unique(question_41$answer_in_english))
question_41<- filter(question_41, answer_in_english!="Unsure")
question_41_Frequencies_non_weighted<- count_elements_by_group(question_41, "answer_in_english", c("crop"))
#finding the levels per crop (banana and plantain) no weighted
levels_per_crop_Q41_no_weighted<- tapply(question_41_Frequencies_non_weighted$answer_in_english, question_41_Frequencies_non_weighted$crop, function(x){(unique(x))})
#generating a ramp palette according to the number of levels per crop
colors_banana_question41_no_weighted<- palette_banana(length(levels_per_crop_Q41_no_weighted$Banana))
colors_plantain_question41_no_weighted<- palette_plantain(length(levels_per_crop_Q41_no_weighted$Plantain))
#Assigning the colors by crop and answer
# Define the knowledge levels for each crop
levels_by_crop_no_weighted_41 <- list(
  Banana = levels_per_crop_Q41_no_weighted$Banana,
  Plantain = levels_per_crop_Q41_no_weighted$Plantain
)
# Define the colors for each crop
colors_by_crop_no_weighted_41 <- list(
  Banana = colors_banana_question41_no_weighted, # Replace with actual color vector for Banana
  Plantain = colors_plantain_question41_no_weighted # Replace with actual color vector for Plantain
  # Add more crops and their color vectors here if needed
)
# Now call the function
avg_no_weight_41 <- assign_group_color(data = question_41_Frequencies_non_weighted, levels_by_crop = levels_by_crop_no_weighted_41, colors_by_crop = colors_by_crop_no_weighted_41,answer_col =  "answer_in_english")
#Make the abbreviations
avg_no_weight_41 <- avg_no_weight_41 %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Community Awareness" ~ "CA",
    answer_in_english == "Effects of Climate Change" ~ "ECC",
    answer_in_english == "Inadequate Biosecurity Measures" ~ "IBM",
    answer_in_english == "Invasive Species" ~ "IS",
    answer_in_english == "Lack of Quarantine Enforcement" ~ "LQE",
    answer_in_english == "Limited Disease Surveillance" ~ "LDS",
    answer_in_english == "Market Demand" ~ "MD",
    answer_in_english == "Migration" ~ "MIG",
    answer_in_english == "Political Factors" ~ "PF",
    answer_in_english == "Social Instability" ~ "SI",
    answer_in_english == "Trade of Infected Plant Material" ~ "TIPM",
    answer_in_english == "Weak Regulatory Framework" ~ "WRF",
    answer_in_english == "Not Sure" ~ "NS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
avg_no_weight_41_plot<- data.frame(h1= "total",
                                    h2= avg_no_weight_41$crop,
                                    h3= avg_no_weight_41$answer_in_english,
                                    color= avg_no_weight_41$group_color,
                                    weight= avg_no_weight_41$n,
                                    codes= avg_no_weight_41$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_no_weight_41_plot))
vt_d3(gdp_json, color_border = "#654411", size_border = "1.5px", label = T, color_label = "#654411", seed = 3, title = "non-weighted")
vt_d3(gdp_json, color_border = "#654411", size_border = "1.5px", label = F, color_label = "#654411", seed = 3, title = "non-weighted")
#kable(question_5_frequencies)
#weighted
question_41_weihted<- inner_join(question_41, experience_of_each_expert)
rep_question_41_weighted<- question_41_weihted %>%
  slice(rep(1:n(), question_41_weihted$weights))
question_41_Frequencies_weighted<- count_elements_by_group(rep_question_41_weighted, "answer_in_english", c("crop"))
# Now call the function
avg_weight_41 <- assign_group_color(data = question_41_Frequencies_weighted, levels_by_crop = levels_by_crop_no_weighted_41, colors_by_crop = colors_by_crop_no_weighted_41,answer_col =  "answer_in_english")
#Make the abbreviations
avg_weight_41 <- avg_weight_41 %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Awareness" ~ "CA",
      answer_in_english == "Effects of Climate Change" ~ "ECC",
      answer_in_english == "Inadequate Biosecurity Measures" ~ "IBM",
      answer_in_english == "Invasive Species" ~ "IS",
      answer_in_english == "Lack of Quarantine Enforcement" ~ "LQE",
      answer_in_english == "Limited Disease Surveillance" ~ "LDS",
      answer_in_english == "Market Demand" ~ "MD",
      answer_in_english == "Migration" ~ "MIG",
      answer_in_english == "Political Factors" ~ "PF",
      answer_in_english == "Social Instability" ~ "SI",
      answer_in_english == "Trade of Infected Plant Material" ~ "TIPM",
      answer_in_english == "Weak Regulatory Framework" ~ "WRF",
      answer_in_english == "Not Sure" ~ "NS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
avg_weight_41_plot<- data.frame(h1= "total",
                                   h2= avg_weight_41$crop,
                                   h3= avg_weight_41$answer_in_english,
                                   color= avg_weight_41$group_color,
                                   weight= avg_weight_41$n,
                                   codes= avg_weight_41$cat_abbreviations)
gdp_json <- vt_export_json(vt_input_from_df(avg_weight_41_plot))
vt_d3(gdp_json, color_border = "#654411", size_border = "1.5px", label = T, color_label = "#654411", seed = 3, title = "weighted")
vt_d3(gdp_json, color_border = "#654411", size_border = "1.5px", label = F, color_label = "#654411", seed = 3, title = "weighted")
#Frequencies by department
question_41_frequencies_by_depto <- count_elements_by_group(question_41, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_41_frequencies_by_depto <- assign_group_color(data = question_41_frequencies_by_depto, levels_by_crop = levels_by_crop_no_weighted_41, colors_by_crop = colors_by_crop_no_weighted_41,answer_col =  "answer_in_english")
#Make the abbreviations
question_41_frequencies_by_depto <- question_41_frequencies_by_depto %>%
  mutate(cat_abbreviations = case_when(
    answer_in_english == "Community Awareness" ~ "CA",
    answer_in_english == "Effects of Climate Change" ~ "ECC",
    answer_in_english == "Inadequate Biosecurity Measures" ~ "IBM",
    answer_in_english == "Invasive Species" ~ "IS",
    answer_in_english == "Lack of Quarantine Enforcement" ~ "LQE",
    answer_in_english == "Limited Disease Surveillance" ~ "LDS",
    answer_in_english == "Market Demand" ~ "MD",
    answer_in_english == "Migration" ~ "MIG",
    answer_in_english == "Political Factors" ~ "PF",
    answer_in_english == "Social Instability" ~ "SI",
    answer_in_english == "Trade of Infected Plant Material" ~ "TIPM",
    answer_in_english == "Weak Regulatory Framework" ~ "WRF",
    answer_in_english == "Not Sure" ~ "NS",
    TRUE ~ NA_character_  # Default case if none of the above conditions are met
  ))
#tree map
question_41_frequencies_by_depto<- select(question_41_frequencies_by_depto,!answer_in_english)
question_41_frequencies_by_depto<- question_41_frequencies_by_depto %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_41_frequencies_by_depto<- select(question_41_frequencies_by_depto,!n & !total)
#put it in long format
question_41_frequencies_by_depto <- question_41_frequencies_by_depto %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_41_frequencies_by_depto_banana<- filter(question_41_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_41_plot$codes[which(avg_no_weight_41_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_41_frequencies_by_depto_plantain<- filter(question_41_frequencies_by_depto, cat_abbreviations %in% avg_no_weight_41_plot$codes[which(avg_no_weight_41_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_41_frequencies_by_depto<- rbind(question_41_frequencies_by_depto_banana, question_41_frequencies_by_depto_plantain)
#tree map only plantain
tree_map_3(data = filter(question_41_frequencies_by_depto, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#tree map only banana
tree_map_3(data = filter(question_41_frequencies_by_depto, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="non-weighted")
#Weighted
#Frequencies by department
question_41_frequencies_by_depto_wei <- count_elements_by_group(rep_question_41_weighted, "answer_in_english", c("crop", "expert_in"))
# Now call the function
question_41_frequencies_by_depto_wei <- assign_group_color(data = question_41_frequencies_by_depto_wei, levels_by_crop = levels_by_crop_no_weighted_41, colors_by_crop = colors_by_crop_no_weighted_41,answer_col =  "answer_in_english")
#Make the abbreviations
question_41_frequencies_by_depto_wei <- question_41_frequencies_by_depto_wei %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Awareness" ~ "CA",
      answer_in_english == "Effects of Climate Change" ~ "ECC",
      answer_in_english == "Inadequate Biosecurity Measures" ~ "IBM",
      answer_in_english == "Invasive Species" ~ "IS",
      answer_in_english == "Lack of Quarantine Enforcement" ~ "LQE",
      answer_in_english == "Limited Disease Surveillance" ~ "LDS",
      answer_in_english == "Market Demand" ~ "MD",
      answer_in_english == "Migration" ~ "MIG",
      answer_in_english == "Political Factors" ~ "PF",
      answer_in_english == "Social Instability" ~ "SI",
      answer_in_english == "Trade of Infected Plant Material" ~ "TIPM",
      answer_in_english == "Weak Regulatory Framework" ~ "WRF",
      answer_in_english == "Not Sure" ~ "NS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#tree map
question_41_frequencies_by_depto_wei<- select(question_41_frequencies_by_depto_wei,!answer_in_english)
question_41_frequencies_by_depto_wei<- question_41_frequencies_by_depto_wei %>%
  group_by(crop,expert_in) %>%
  mutate(total= sum(n),
         mean= round((n/total)*100,0))
question_41_frequencies_by_depto_wei<- select(question_41_frequencies_by_depto_wei,!n & !total)
#put it in long format
question_41_frequencies_by_depto_wei <- question_41_frequencies_by_depto_wei %>% 
  uncount(weights = mean, .id = "id")
#for banana
question_41_frequencies_by_depto_banana_wei<- filter(question_41_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_41_plot$codes[which(avg_no_weight_41_plot$h2=="Banana")], crop=="Banana")
#for plantain
question_41_frequencies_by_depto_plantain_wei<- filter(question_41_frequencies_by_depto_wei, cat_abbreviations %in% avg_no_weight_41_plot$codes[which(avg_no_weight_41_plot$h2=="Plantain")], crop=="Plantain")
#merge both data set
question_41_frequencies_by_depto_wei<- rbind(question_41_frequencies_by_depto_banana_wei, question_41_frequencies_by_depto_plantain_wei)
#tree map only plantain
tree_map_3(data = filter(question_41_frequencies_by_depto_wei, crop=="Plantain"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")
#tree map only banana
tree_map_3(data = filter(question_41_frequencies_by_depto_wei, crop=="Banana"), "crop", "expert_in", "cat_abbreviations", "group_color", title="weighted")

#Additional top 41 diseases and pest in Colombia
q41_top_41Colobia<- count_elements_by_group(question_41, "answer_in_english", c("answer_in_english"))
q41_top_41Colobia$mean<-round((q41_top_41Colobia$n/sum(q41_top_41Colobia$n)*100),0)
q41_top_41Colobia$background_color<- "white"
q41_top_41Colobia$color<- palette_soil(length(unique(q41_top_41Colobia$answer_in_english)))
#Make the abbreviations
q41_top_41Colobia <- q41_top_41Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Awareness" ~ "CA",
      answer_in_english == "Effects of Climate Change" ~ "ECC",
      answer_in_english == "Inadequate Biosecurity Measures" ~ "IBM",
      answer_in_english == "Invasive Species" ~ "IS",
      answer_in_english == "Lack of Quarantine Enforcement" ~ "LQE",
      answer_in_english == "Limited Disease Surveillance" ~ "LDS",
      answer_in_english == "Market Demand" ~ "MD",
      answer_in_english == "Migration" ~ "MIG",
      answer_in_english == "Political Factors" ~ "PF",
      answer_in_english == "Social Instability" ~ "SI",
      answer_in_english == "Trade of Infected Plant Material" ~ "TIPM",
      answer_in_english == "Weak Regulatory Framework" ~ "WRF",
      answer_in_english == "Not Sure" ~ "NS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q41_top_41Colobia <- q41_top_41Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q41_top_41Colobia$cat_abbreviations<- factor(q41_top_41Colobia$cat_abbreviations, levels = q41_top_41Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q41_top_41Colobia,x_lab = "Risk Factor", y_lab ="Proportion of Experts (%)", title = "
Risk Factors that Must be Focus on -  NW" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)



#Additional top 41 diseases and pest in Colombia -WEIGHTED
q_41_weighted_top_41Colobia<- count_elements_by_group(rep_question_41_weighted, "answer_in_english", c("answer_in_english"))
q_41_weighted_top_41Colobia$mean<-round((q_41_weighted_top_41Colobia$n/sum(q_41_weighted_top_41Colobia$n)*100),0)
q_41_weighted_top_41Colobia$background_color<- "white"
q_41_weighted_top_41Colobia$color<- palette_soil(length(unique(q_41_weighted_top_41Colobia$answer_in_english)))
#Make the abbreviations
q_41_weighted_top_41Colobia <- q_41_weighted_top_41Colobia %>%
    mutate(cat_abbreviations = case_when(
      answer_in_english == "Community Awareness" ~ "CA",
      answer_in_english == "Effects of Climate Change" ~ "ECC",
      answer_in_english == "Inadequate Biosecurity Measures" ~ "IBM",
      answer_in_english == "Invasive Species" ~ "IS",
      answer_in_english == "Lack of Quarantine Enforcement" ~ "LQE",
      answer_in_english == "Limited Disease Surveillance" ~ "LDS",
      answer_in_english == "Market Demand" ~ "MD",
      answer_in_english == "Migration" ~ "MIG",
      answer_in_english == "Political Factors" ~ "PF",
      answer_in_english == "Social Instability" ~ "SI",
      answer_in_english == "Trade of Infected Plant Material" ~ "TIPM",
      answer_in_english == "Weak Regulatory Framework" ~ "WRF",
      answer_in_english == "Not Sure" ~ "NS",
      TRUE ~ NA_character_  # Default case if none of the above conditions are met
    ))
#sort the results by mean
q_41_weighted_top_41Colobia <- q_41_weighted_top_41Colobia %>%
  arrange(desc(mean))
#Finding the order of the levels
q_41_weighted_top_41Colobia$cat_abbreviations<- factor(q_41_weighted_top_41Colobia$cat_abbreviations, levels = q_41_weighted_top_41Colobia$cat_abbreviations)
#plot most important pest and diseases
bar_plot_banana_plantain(data_set = q_41_weighted_top_41Colobia,x_lab = "Risk Factor", y_lab ="Proportion of Experts (%)", title = "
Risk Factors that Must be Focus on -  W" ,x = "cat_abbreviations", y = "mean", alpha = 0.3,background_color = "background_color", bar_color = "color",proportional_limit =1.10)
```


